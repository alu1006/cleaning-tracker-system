<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“æƒè¿½è¹¤ç³»çµ± - è³‡æ–™åŒ¯å…¥</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>ğŸ§¹ æ‰“æƒè¿½è¹¤ç³»çµ±</h1>
            <div class="nav-user">
                <span id="userInfo"></span>
                <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="step-container">
            <h2>æ­¥é©Ÿä¸€ï¼šåŒ¯å…¥æ‰“æƒåå–®</h2>
            <div class="upload-section">
                <input type="file" id="cleaningListFile" accept=".xlsx,.xls" class="file-input">
                <label for="cleaningListFile" class="file-label">
                    ğŸ“‹ é¸æ“‡æ‰“æƒåå–®.xlsx
                </label>
                <div id="cleaningPreview" class="preview-section"></div>
            </div>
        </div>

        <div class="step-container">
            <h2>æ­¥é©ŸäºŒï¼šåŒ¯å…¥å­¸ç”Ÿåå–®</h2>
            <div class="upload-section">
                <input type="file" id="studentListFile" accept=".xlsx,.xls" class="file-input">
                <label for="studentListFile" class="file-label">
                    ğŸ‘¥ é¸æ“‡å­¸ç”Ÿåå–®.xlsx
                </label>
                <div id="studentPreview" class="preview-section"></div>
            </div>
        </div>

        <div class="step-container" id="assignmentSection" style="display: none;">
            <h2>æ­¥é©Ÿä¸‰ï¼šåˆ†é…æ‰“æƒä»»å‹™</h2>
            <div id="assignmentArea"></div>
            <div class="action-buttons">
                <button id="saveAssignments" class="primary-btn">ğŸ’¾ å„²å­˜åˆ†é…</button>
                <button id="goToTracking" class="secondary-btn">ğŸ“Š é–‹å§‹è¿½è¹¤</button>
            </div>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple-public.js"></script>
    
    <script>
        let currentUser = null;
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.firebaseService.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserInfo();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUserInfo() {
            if (!currentUser) return;
            
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                const userName = userData?.name || currentUser.displayName || currentUser.email;
                const userRole = userData?.role || 'user';
                const userInfoElement = document.getElementById('userInfo');
                const photoURL = currentUser.photoURL || userData?.photoURL;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºå­¸ç”Ÿæ¨¡å¼
                const isStudentMode = sessionStorage.getItem('isStudentMode') === 'true';
                const teacherName = sessionStorage.getItem('teacherName');
                
                if (photoURL) {
                    userInfoElement.innerHTML = `
                        <img src="${photoURL}" alt="User Avatar" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                        ${userName} (${userRole === 'admin' ? 'ç®¡ç†å“¡' : userRole === 'teacher' ? 'æ•™å¸«' : 'å­¸ç”Ÿ'})
                        ${isStudentMode ? ` - æŸ¥çœ‹æ•™å¸« ${teacherName} çš„è³‡æ–™` : ''}
                    `;
                } else {
                    userInfoElement.textContent = `${userName} (${userRole === 'admin' ? 'ç®¡ç†å“¡' : userRole === 'teacher' ? 'æ•™å¸«' : 'å­¸ç”Ÿ'})${isStudentMode ? ` - æŸ¥çœ‹æ•™å¸« ${teacherName} çš„è³‡æ–™` : ''}`;
                }
                
                // æ ¹æ“šè§’è‰²æ·»åŠ å°æ‡‰æŒ‰éˆ•
                if (userRole === 'teacher') {
                    const navUser = document.querySelector('.nav-user');
                    const logoutBtn = navUser.querySelector('.logout-btn');
                    
                    // æ·»åŠ å­¸ç”Ÿç®¡ç†æŒ‰éˆ•
                    const studentMgmtBtn = document.createElement('button');
                    studentMgmtBtn.textContent = 'ğŸ‘¥ å­¸ç”Ÿç®¡ç†';
                    studentMgmtBtn.className = 'secondary-btn';
                    studentMgmtBtn.onclick = () => window.location.href = 'student-management.html';
                    
                    // æ·»åŠ è¿½è¹¤æŒ‰éˆ•
                    const trackingBtn = document.createElement('button');
                    trackingBtn.textContent = 'ğŸ“Š è¿½è¹¤é é¢';
                    trackingBtn.className = 'secondary-btn';
                    trackingBtn.onclick = () => window.location.href = 'tracking.html';
                    
                    navUser.insertBefore(studentMgmtBtn, logoutBtn);
                    navUser.insertBefore(trackingBtn, logoutBtn);
                } else if (userRole === 'student') {
                    // å­¸ç”Ÿæ·»åŠ è¿½è¹¤æŒ‰éˆ•
                    const navUser = document.querySelector('.nav-user');
                    const logoutBtn = navUser.querySelector('.logout-btn');
                    
                    const trackingBtn = document.createElement('button');
                    trackingBtn.textContent = 'ğŸ“Š è¿½è¹¤é é¢';
                    trackingBtn.className = 'secondary-btn';
                    trackingBtn.onclick = () => window.location.href = 'tracking.html';
                    
                    navUser.insertBefore(trackingBtn, logoutBtn);
                    
                    // ç‚ºå­¸ç”Ÿé¡¯ç¤ºåªè®€æ¨¡å¼æç¤º
                    if (isStudentMode) {
                        addStudentModeNotice();
                    }
                }
                    
                // è¼‰å…¥ç¾æœ‰è³‡æ–™
                loadExistingData(userRole, isStudentMode);
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:', error);
                // å¦‚æœè¼‰å…¥ Firebase è³‡æ–™å¤±æ•—ï¼Œä½¿ç”¨ sessionStorage å‚™æ´
                document.getElementById('userInfo').textContent = 
                    `${sessionStorage.getItem('userName')} (${sessionStorage.getItem('userRole') === 'admin' ? 'ç®¡ç†å“¡' : 'ä½¿ç”¨è€…'})`;
                loadExistingData();
            }
        }

        let cleaningData = [];
        let studentData = [];
        let assignments = {};
        let assignedStudents = new Set(); // è¿½è¹¤å·²åˆ†é…çš„å­¸ç”Ÿ
        let isDataLoaded = false; // æ¨™è¨˜è³‡æ–™æ˜¯å¦å·²è¼‰å…¥

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            try {
                await window.firebaseService.signOut();
                sessionStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // è¼‰å…¥ç¾æœ‰è³‡æ–™
        async function loadExistingData(userRole = 'user', isStudentMode = false) {
            if (!currentUser) {
                console.log('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œç„¡æ³•è¼‰å…¥è³‡æ–™');
                return false;
            }
            
            console.log('é–‹å§‹è¼‰å…¥ç¾æœ‰è³‡æ–™ï¼Œä½¿ç”¨è€… UID:', currentUser.uid);
            console.log('ä½¿ç”¨è€…è§’è‰²:', userRole, 'å­¸ç”Ÿæ¨¡å¼:', isStudentMode);
            
            try {
                let result;
                
                if (userRole === 'student' && isStudentMode) {
                    // å­¸ç”Ÿæ¨¡å¼ï¼šè¼‰å…¥æ•™å¸«çš„è³‡æ–™
                    console.log('ğŸ“ å­¸ç”Ÿæ¨¡å¼ï¼šè¼‰å…¥æ•™å¸«è³‡æ–™');
                    result = await window.firebaseService.getTeacherDataForStudent(currentUser.uid);
                    
                    if (result.success) {
                        console.log('æ‰¾åˆ°æ•™å¸«è³‡æ–™:', result.teacherData);
                        
                        cleaningData = result.teacherData?.cleaningTasks || [];
                        studentData = result.teacherData?.students || [];
                        assignments = result.teacherData?.assignments || {};
                        isDataLoaded = true;
                        
                        // æ·»åŠ æ•™å¸«å’Œå­¸ç”Ÿè³‡è¨Šåˆ°å…¨åŸŸè®Šæ•¸
                        window.teacherInfo = result.teacherInfo;
                        window.studentInfo = result.studentInfo;
                        
                        console.log('è¼‰å…¥çš„æ•™å¸«è³‡æ–™:', {
                            cleaningTasks: cleaningData.length,
                            students: studentData.length,
                            assignments: Object.keys(assignments).length,
                            teacher: result.teacherInfo?.name
                        });
                    } else {
                        console.log('è¼‰å…¥æ•™å¸«è³‡æ–™å¤±æ•—:', result.error);
                        showNoDataMessage('ç„¡æ³•è¼‰å…¥æ•™å¸«è³‡æ–™ï¼š' + result.error);
                        return false;
                    }
                } else {
                    // ä¸€èˆ¬æ¨¡å¼ï¼šè¼‰å…¥è‡ªå·±çš„è³‡æ–™
                    result = await window.firebaseService.getUserData(currentUser.uid);
                    console.log('getUserData çµæœ:', result);
                    
                    if (result.success && result.data) {
                        console.log('æ‰¾åˆ°ç¾æœ‰è³‡æ–™:', result.data);
                        
                        cleaningData = result.data.cleaningTasks || [];
                        studentData = result.data.students || [];
                        assignments = result.data.assignments || {};
                        isDataLoaded = true;
                        
                        console.log('è¼‰å…¥çš„è³‡æ–™:', {
                            cleaningTasks: cleaningData.length,
                            students: studentData.length,
                            assignments: Object.keys(assignments).length
                        });
                    } else {
                        console.log('æ²’æœ‰æ‰¾åˆ°ç¾æœ‰è³‡æ–™æˆ–è³‡æ–™ç„¡æ•ˆ');
                    }
                }
                
                if (isDataLoaded) {
                    // æ¨™è¨˜å·²åˆ†é…çš„å­¸ç”Ÿ
                    assignedStudents.clear();
                    Object.values(assignments).forEach(studentList => {
                        studentList.forEach(student => assignedStudents.add(student));
                    });
                    
                    displayExistingData(userRole, isStudentMode);
                    return true;
                }
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
            }
            return false;
        }

        // æ·»åŠ å­¸ç”Ÿæ¨¡å¼æç¤º
        function addStudentModeNotice() {
            const container = document.querySelector('.container');
            const notice = document.createElement('div');
            notice.className = 'student-mode-notice';
            notice.innerHTML = `
                <div style="background: #e3f2fd; border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin: 20px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 24px; margin-right: 10px;">ğŸ“</span>
                        <strong style="color: #1976D2; font-size: 18px;">å­¸ç”ŸæŸ¥çœ‹æ¨¡å¼</strong>
                    </div>
                    <p style="margin: 5px 0; color: #424242;">
                        ğŸ“– æ‚¨æ­£åœ¨æŸ¥çœ‹æ•™å¸« <strong>${sessionStorage.getItem('teacherName') || 'æ‚¨çš„è€å¸«'}</strong> åŒ¯å…¥çš„æ‰“æƒè³‡æ–™
                    </p>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">
                        âš ï¸ å­¸ç”Ÿåªèƒ½æŸ¥çœ‹è³‡æ–™ï¼Œç„¡æ³•ç·¨è¼¯æˆ–é‡æ–°åŒ¯å…¥æª”æ¡ˆ
                    </p>
                </div>
            `;
            container.insertBefore(notice, container.firstChild);
        }
        
        // ç¦ç”¨å­¸ç”Ÿçš„ç·¨è¼¯åŠŸèƒ½
        function disableStudentEditing() {
            // ç¦ç”¨æª”æ¡ˆä¸Šå‚³
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.5';
            });
            
            // ç¦ç”¨æª”æ¡ˆä¸Šå‚³æ¨™ç±¤é»æ“Š
            const fileLabels = document.querySelectorAll('.file-label');
            fileLabels.forEach(label => {
                label.style.pointerEvents = 'none';
                label.style.opacity = '0.5';
                label.innerHTML = label.innerHTML.replace('é¸æ“‡', 'æª¢è¦–');
            });
            
            // ç¦ç”¨å„²å­˜å’Œç·¨è¼¯æŒ‰éˆ•
            const editButtons = document.querySelectorAll('.edit-btn, .delete-btn, .duplicate-btn, #saveAssignments');
            editButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.pointerEvents = 'none';
                }
            });
            
            // ä¿®æ”¹æ­¥é©Ÿæ¨™é¡Œ
            const stepHeaders = document.querySelectorAll('.step-container h2');
            stepHeaders.forEach(header => {
                header.innerHTML = header.innerHTML.replace('æ­¥é©Ÿ', 'æª¢è¦–').replace('åŒ¯å…¥', 'æŸ¥çœ‹').replace('åˆ†é…', 'æª¢è¦–');
            });
        }
        
        // é¡¯ç¤ºç„¡è³‡æ–™è¨Šæ¯
        function showNoDataMessage(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
                    <h2 style="color: #666; margin-bottom: 15px;">${message}</h2>
                    <p style="color: #999; margin-bottom: 20px;">è«‹è¯çµ¡æ‚¨çš„æ•™å¸«ç¢ºèªå¸³è™Ÿè¨­å®š</p>
                    <button onclick="window.location.href='tracking.html'" class="secondary-btn">è¿”å›è¿½è¹¤é é¢</button>
                </div>
            `;
        }

        // é¡¯ç¤ºç¾æœ‰è³‡æ–™
        function displayExistingData(userRole = 'user', isStudentMode = false) {
            console.log('é–‹å§‹é¡¯ç¤ºç¾æœ‰è³‡æ–™');
            console.log('cleaningData.length:', cleaningData.length);
            console.log('studentData.length:', studentData.length);
            console.log('ä½¿ç”¨è€…è§’è‰²:', userRole, 'å­¸ç”Ÿæ¨¡å¼:', isStudentMode);
            
            // å¦‚æœæ˜¯å­¸ç”Ÿæ¨¡å¼ï¼Œç¦ç”¨ç·¨è¼¯åŠŸèƒ½
            if (userRole === 'student' && isStudentMode) {
                disableStudentEditing();
            }
            
            if (cleaningData.length > 0) {
                document.getElementById('cleaningPreview').innerHTML = `
                    <div class="existing-data-notice">
                        <h3>âœ… å·²æœ‰æ‰“æƒåå–®è³‡æ–™</h3>
                        <p>å…± ${cleaningData.length} å€‹æ‰“æƒäº‹é …</p>
                        <button class="secondary-btn" onclick="showCleaningData()">æª¢è¦–è³‡æ–™</button>
                        <button class="secondary-btn" onclick="reimportCleaning()">é‡æ–°åŒ¯å…¥</button>
                    </div>
                `;
                console.log('âœ… æ‰“æƒåå–®è³‡æ–™é¡¯ç¤ºå®Œæˆ');
            } else {
                console.log('âŒ æ²’æœ‰æ‰“æƒåå–®è³‡æ–™');
            }
            
            if (studentData.length > 0) {
                document.getElementById('studentPreview').innerHTML = `
                    <div class="existing-data-notice">
                        <h3>âœ… å·²æœ‰å­¸ç”Ÿåå–®è³‡æ–™</h3>
                        <p>å…± ${studentData.length} ä½å­¸ç”Ÿ</p>
                        <button class="secondary-btn" onclick="showStudentData()">æª¢è¦–è³‡æ–™</button>
                        <button class="secondary-btn" onclick="reimportStudents()">é‡æ–°åŒ¯å…¥</button>
                    </div>
                `;
                console.log('âœ… å­¸ç”Ÿåå–®è³‡æ–™é¡¯ç¤ºå®Œæˆ');
            } else {
                console.log('âŒ æ²’æœ‰å­¸ç”Ÿåå–®è³‡æ–™');
            }
            
            if (cleaningData.length > 0 && studentData.length > 0) {
                document.getElementById('assignmentSection').style.display = 'block';
                generateAssignmentInterface();
                console.log('âœ… åˆ†é…ä»‹é¢å·²é¡¯ç¤º');
            } else {
                console.log('âŒ è³‡æ–™ä¸å®Œæ•´ï¼Œç„¡æ³•é¡¯ç¤ºåˆ†é…ä»‹é¢');
            }
        }

        // é¡¯ç¤ºæ‰“æƒè³‡æ–™
        function showCleaningData() {
            displayCleaningPreview();
        }

        // é¡¯ç¤ºå­¸ç”Ÿè³‡æ–™
        function showStudentData() {
            displayStudentPreview();
        }

        // é‡æ–°åŒ¯å…¥æ‰“æƒåå–®
        function reimportCleaning() {
            document.getElementById('cleaningListFile').click();
        }

        // é‡æ–°åŒ¯å…¥å­¸ç”Ÿåå–®
        function reimportStudents() {
            document.getElementById('studentListFile').click();
        }

        // è™•ç†æ‰“æƒåå–®ä¸Šå‚³
        document.getElementById('cleaningListFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    console.log('Excel åˆ†é åˆ—è¡¨:', workbook.SheetNames);
                    
                    // è®€å–æ‰€æœ‰åˆ†é çš„è³‡æ–™
                    cleaningData = [];
                    workbook.SheetNames.forEach((sheetName, index) => {
                        console.log(`è™•ç†åˆ†é  ${index + 1}: ${sheetName}`);
                        const worksheet = workbook.Sheets[sheetName];
                        const sheetData = XLSX.utils.sheet_to_json(worksheet);
                        
                        // æ¨™æº–åŒ–æ¬„ä½åç¨±
                        const normalizedData = sheetData.map(row => {
                            const normalizedRow = {};
                            Object.keys(row).forEach(key => {
                                const trimmedKey = key.trim();
                                if (trimmedKey === 'äº‹é …') {
                                    normalizedRow['äº‹é …'] = row[key];
                                } else if (trimmedKey === 'è©³ç´°' || trimmedKey === 'è©³ç´°ä½ç½®') {
                                    normalizedRow['è©³ç´°'] = row[key];
                                } else if (trimmedKey === 'æ¨™æº–') {
                                    normalizedRow['æ¨™æº–'] = row[key];
                                } else if (trimmedKey === 'äººæ•¸') {
                                    normalizedRow['äººæ•¸'] = row[key];
                                } else {
                                    normalizedRow[trimmedKey] = row[key];
                                }
                            });
                            
                            // åŠ å…¥åˆ†é è³‡è¨Š
                            normalizedRow['åˆ†é '] = sheetName;
                            normalizedRow['å®Œæ•´äº‹é …'] = `[${sheetName}] ${normalizedRow['äº‹é …']}`;
                            
                            return normalizedRow;
                        });
                        
                        cleaningData = cleaningData.concat(normalizedData);
                        console.log(`åˆ†é  ${sheetName} è¼‰å…¥ ${normalizedData.length} ç­†è³‡æ–™`);
                    });
                    
                    console.log('ç¸½å…±è¼‰å…¥', cleaningData.length, 'ç­†æ‰“æƒäº‹é …');
                    displayCleaningPreview();
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // è™•ç†å­¸ç”Ÿåå–®ä¸Šå‚³
        document.getElementById('studentListFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    studentData = XLSX.utils.sheet_to_json(worksheet);
                    displayStudentPreview();
                    checkIfCanAssign();
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function displayCleaningPreview() {
            const preview = document.getElementById('cleaningPreview');
            if (cleaningData.length === 0) return;

            let html = `<div class="preview-header">
                <h3>æ‰“æƒäº‹é …é è¦½</h3>
                <div class="preview-actions">
                    <button class="secondary-btn" onclick="addNewCleaningTask()">â• æ–°å¢ä»»å‹™</button>
                    <button class="secondary-btn" onclick="editAllCleaningTasks()">âœï¸ æ‰¹é‡ç·¨è¼¯</button>
                </div>
            </div>`;
            
            // æŒ‰åˆ†é åˆ†çµ„é¡¯ç¤º
            const groupedData = {};
            cleaningData.forEach((item, index) => {
                const sheetName = item['åˆ†é '] || 'æœªçŸ¥åˆ†é ';
                if (!groupedData[sheetName]) {
                    groupedData[sheetName] = [];
                }
                groupedData[sheetName].push({...item, originalIndex: index});
            });
            
            Object.keys(groupedData).forEach(sheetName => {
                html += `<div class="sheet-section">
                    <h4>ğŸ“‹ ${sheetName} (${groupedData[sheetName].length}ç­†)</h4>
                    <table class="preview-table editable"><thead><tr>
                        <th>äº‹é …</th><th>è©³ç´°</th><th>æ¨™æº–</th><th>äººæ•¸</th><th>æ“ä½œ</th>
                    </tr></thead><tbody>`;
                
                groupedData[sheetName].forEach(row => {
                    html += `<tr data-index="${row.originalIndex}">`;
                    html += `<td><input type="text" value="${row['äº‹é …'] || ''}" onchange="updateCleaningTask(${row.originalIndex}, 'äº‹é …', this.value)"></td>`;
                    html += `<td><input type="text" value="${row['è©³ç´°'] || ''}" onchange="updateCleaningTask(${row.originalIndex}, 'è©³ç´°', this.value)"></td>`;
                    html += `<td><input type="text" value="${row['æ¨™æº–'] || ''}" onchange="updateCleaningTask(${row.originalIndex}, 'æ¨™æº–', this.value)"></td>`;
                    html += `<td><input type="number" value="${row['äººæ•¸'] || 1}" min="1" onchange="updateCleaningTask(${row.originalIndex}, 'äººæ•¸', this.value)"></td>`;
                    html += `<td class="action-buttons">
                        <button class="edit-btn" onclick="duplicateCleaningTask(${row.originalIndex})">ğŸ“‹</button>
                        <button class="delete-btn" onclick="deleteCleaningTask(${row.originalIndex})">ğŸ—‘ï¸</button>
                    </td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            });
            
            html += `<div class="import-summary">
                <h4>ğŸ“Š åŒ¯å…¥æ‘˜è¦</h4>
                <p>âœ… æˆåŠŸåŒ¯å…¥ <strong>${Object.keys(groupedData).length}</strong> å€‹åˆ†é </p>
                <p>âœ… ç¸½å…± <strong>${cleaningData.length}</strong> å€‹æ‰“æƒäº‹é …</p>
                <p>ğŸ“‹ åˆ†é : ${Object.keys(groupedData).join(', ')}</p>
                <div class="summary-actions">
                    <button class="primary-btn" onclick="saveCleaningChanges()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                    <button class="secondary-btn" onclick="reimportCleaning()">ğŸ”„ é‡æ–°åŒ¯å…¥</button>
                </div>
            </div>`;
            
            preview.innerHTML = html;
        }

        function displayStudentPreview() {
            const preview = document.getElementById('studentPreview');
            if (studentData.length === 0) return;

            let html = `<div class="preview-header">
                <h3>å­¸ç”Ÿåå–®é è¦½</h3>
                <div class="preview-actions">
                    <button class="secondary-btn" onclick="addNewStudent()">â• æ–°å¢å­¸ç”Ÿ</button>
                    <button class="secondary-btn" onclick="editAllStudents()">âœï¸ æ‰¹é‡ç·¨è¼¯</button>
                </div>
            </div>`;
            
            html += '<table class="preview-table editable"><thead><tr>';
            html += '<th>å­¸è™Ÿ</th><th>å§“å</th><th>é¡¯ç¤ºæ ¼å¼</th><th>æ“ä½œ</th>';
            html += '</tr></thead><tbody>';

            studentData.forEach((student, index) => {
                const studentId = student['å­¸è™Ÿ'] || '';
                const studentName = student['å§“å'] || '';
                const displayName = `${studentId} ${studentName}`;
                
                html += `<tr data-index="${index}">`;
                html += `<td><input type="text" value="${studentId}" onchange="updateStudent(${index}, 'å­¸è™Ÿ', this.value)"></td>`;
                html += `<td><input type="text" value="${studentName}" onchange="updateStudent(${index}, 'å§“å', this.value)"></td>`;
                html += `<td><strong>${displayName}</strong></td>`;
                html += `<td class="action-buttons">
                    <button class="edit-btn" onclick="duplicateStudent(${index})">ğŸ“‹</button>
                    <button class="delete-btn" onclick="deleteStudent(${index})">ğŸ—‘ï¸</button>
                </td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            
            html += `<div class="import-summary">
                <h4>ğŸ‘¥ å­¸ç”Ÿåå–®æ‘˜è¦</h4>
                <p>âœ… æˆåŠŸåŒ¯å…¥ <strong>${studentData.length}</strong> ä½å­¸ç”Ÿ</p>
                <p>ğŸ“‹ é¡¯ç¤ºæ ¼å¼ï¼šå­¸è™Ÿ + å§“å</p>
                <div class="summary-actions">
                    <button class="primary-btn" onclick="saveStudentChanges()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                    <button class="secondary-btn" onclick="reimportStudents()">ğŸ”„ é‡æ–°åŒ¯å…¥</button>
                </div>
            </div>`;
            
            preview.innerHTML = html;
        }

        function checkIfCanAssign() {
            if (cleaningData.length > 0 && studentData.length > 0) {
                document.getElementById('assignmentSection').style.display = 'block';
                generateAssignmentInterface();
            }
        }

        function generateAssignmentInterface() {
            const assignmentArea = document.getElementById('assignmentArea');
            let html = `
                <div class="assignment-instructions">
                    <h3>ğŸ“ åˆ†é…èªªæ˜</h3>
                    <ul>
                        <li>ğŸ’¡ <strong>æŒ‰ä½ Shift éµ</strong>å¯ä»¥ä¸€æ¬¡é¸æ“‡å¤šä½å­¸ç”Ÿ</li>
                        <li>ğŸ’¡ <strong>æŒ‰ä½ Ctrl/Cmd éµ</strong>å¯ä»¥å€‹åˆ¥é¸æ“‡å­¸ç”Ÿ</li>
                        <li>âš ï¸ å·²åˆ†é…çš„å­¸ç”Ÿæœƒé¡¯ç¤ºç‚ºç°è‰²ä¸”ç„¡æ³•å†æ¬¡é¸æ“‡</li>
                        <li>âœ¨ å»ºè­°å…ˆåˆ†é…éœ€è¦äººæ•¸è¼ƒå¤šçš„æ‰“æƒäº‹é …</li>
                    </ul>
                </div>
            `;

            cleaningData.forEach((task, index) => {
                const taskName = task['å®Œæ•´äº‹é …'] || task['äº‹é …'] || 'æœªçŸ¥äº‹é …';
                const details = task['è©³ç´°'] || '';
                const standard = task['æ¨™æº–'] || '';
                const requiredCount = parseInt(task['äººæ•¸'] || 1);
                
                html += `
                    <div class="assignment-item">
                        <h4>${taskName}</h4>
                        <div class="task-details">
                            <p><strong>ğŸ“ è©³ç´°ï¼š</strong>${details}</p>
                            <p><strong>ğŸ“ æ¨™æº–ï¼š</strong>${standard}</p>
                            <p><strong>ğŸ‘¥ æ‰€éœ€äººæ•¸ï¼š</strong>${requiredCount}äºº</p>
                        </div>
                        <div class="student-assignment">
                            <select multiple class="student-select" data-task="${index}" data-required="${requiredCount}">
                                ${studentData.map(student => {
                                    const studentId = student['å­¸è™Ÿ'] || '';
                                    const studentName = student['å§“å'] || '';
                                    const displayName = `${studentId} ${studentName}`;
                                    const uniqueKey = `${studentId}_${studentName}`; // ä½¿ç”¨å”¯ä¸€æ¨™è­˜
                                    
                                    const isAssigned = assignedStudents.has(uniqueKey);
                                    const isCurrentlySelected = assignments[index] && assignments[index].includes(uniqueKey);
                                    
                                    if (isAssigned && !isCurrentlySelected) {
                                        return `<option value="${uniqueKey}" disabled style="color: #999; background: #f5f5f5;">${displayName} (å·²åˆ†é…)</option>`;
                                    } else {
                                        return `<option value="${uniqueKey}" ${isCurrentlySelected ? 'selected' : ''}>${displayName}</option>`;
                                    }
                                }).join('')}
                            </select>
                            <div class="selected-students" id="selected-${index}"></div>
                        </div>
                    </div>
                `;
            });

            assignmentArea.innerHTML = html;

            // æ·»åŠ é¸æ“‡äº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('.student-select').forEach(select => {
                select.addEventListener('change', updateSelectedStudents);
            });
        }

        function updateSelectedStudents(e) {
            const select = e.target;
            const taskIndex = select.dataset.task;
            const selectedDiv = document.getElementById(`selected-${taskIndex}`);
            const selectedOptions = Array.from(select.selectedOptions);
            const requiredCount = parseInt(select.dataset.required);
            
            // ç§»é™¤ä¹‹å‰çš„åˆ†é…
            if (assignments[taskIndex]) {
                assignments[taskIndex].forEach(student => assignedStudents.delete(student));
            }
            
            // æ·»åŠ æ–°çš„åˆ†é…
            assignments[taskIndex] = selectedOptions.map(option => option.value);
            assignments[taskIndex].forEach(student => assignedStudents.add(student));
            
            // æ›´æ–°é¡¯ç¤º
            const selectedCount = selectedOptions.length;
            const statusClass = selectedCount === requiredCount ? 'perfect' : 
                               selectedCount > requiredCount ? 'over' : 
                               selectedCount > 0 ? 'partial' : 'empty';
            
            selectedDiv.innerHTML = `
                <div class="selection-status ${statusClass}">
                    <strong>å·²é¸æ“‡ ${selectedCount}/${requiredCount} äºº</strong>
                    ${selectedCount > requiredCount ? ' âš ï¸ è¶…ééœ€æ±‚äººæ•¸' : 
                      selectedCount === requiredCount ? ' âœ… äººæ•¸æ­£ç¢º' : 
                      selectedCount > 0 ? ' ğŸ”„ å°šéœ€æ›´å¤šäººå“¡' : ''}
                </div>
                <div class="selected-list">
                    ${selectedOptions.map(option => {
                        // å°‡ uniqueKey è½‰æ›å›é¡¯ç¤ºæ ¼å¼
                        const parts = option.value.split('_');
                        const displayName = parts.length >= 2 ? `${parts[0]} ${parts.slice(1).join('_')}` : option.value;
                        return `<span class="student-tag">${displayName}</span>`;
                    }).join('')}
                </div>
            `;
            
            // é‡æ–°ç”Ÿæˆæ‰€æœ‰é¸å–®ä»¥æ›´æ–°å·²åˆ†é…ç‹€æ…‹
            updateAllSelects();
        }

        function updateAllSelects() {
            document.querySelectorAll('.student-select').forEach(select => {
                const taskIndex = select.dataset.task;
                Array.from(select.options).forEach(option => {
                    const studentName = option.value;
                    const isAssigned = assignedStudents.has(studentName);
                    const isCurrentlySelected = assignments[taskIndex] && assignments[taskIndex].includes(studentName);
                    
                    if (isAssigned && !isCurrentlySelected) {
                        option.disabled = true;
                        option.style.color = '#999';
                        option.style.background = '#f5f5f5';
                        option.textContent = studentName + ' (å·²åˆ†é…)';
                    } else {
                        option.disabled = false;
                        option.style.color = '';
                        option.style.background = '';
                        option.textContent = studentName;
                    }
                });
            });
        }

        // å„²å­˜åˆ†é…
        document.getElementById('saveAssignments').addEventListener('click', async function() {
            console.log('é–‹å§‹å„²å­˜åˆ†é…...');
            console.log('ç•¶å‰ä½¿ç”¨è€…:', currentUser);
            console.log('æ¸…æ½”è³‡æ–™:', cleaningData.length, 'ç­†');
            console.log('å­¸ç”Ÿè³‡æ–™:', studentData.length, 'ç­†');
            console.log('åˆ†é…è³‡æ–™:', Object.keys(assignments).length, 'é …ä»»å‹™');
            
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥');
                console.error('ä½¿ç”¨è€…æœªç™»å…¥');
                return;
            }
            
            if (cleaningData.length === 0) {
                alert('è«‹å…ˆåŒ¯å…¥æ‰“æƒåå–®');
                return;
            }
            
            if (studentData.length === 0) {
                alert('è«‹å…ˆåŒ¯å…¥å­¸ç”Ÿåå–®');
                return;
            }
            
            if (Object.keys(assignments).length === 0) {
                alert('è«‹å…ˆåˆ†é…å­¸ç”Ÿåˆ°æ‰“æƒä»»å‹™');
                return;
            }
            
            const userData = {
                cleaningTasks: cleaningData,
                students: studentData,
                assignments: assignments,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                version: 1 // ç‰ˆæœ¬è™Ÿç¢¼
            };
            
            try {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const saveBtn = document.getElementById('saveAssignments');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'â³ å„²å­˜ä¸­...';
                saveBtn.disabled = true;
                
                console.log('æº–å‚™å„²å­˜åˆ° Firebase...');
                console.log('ä½¿ç”¨è€… UID:', currentUser.uid);
                
                const result = await window.firebaseService.saveUserData(currentUser.uid, userData);
                
                console.log('å„²å­˜çµæœ:', result);
                
                if (result.success) {
                    alert('âœ… åˆ†é…è³‡æ–™å·²æˆåŠŸå„²å­˜åˆ° Firebase é›²ç«¯ï¼\n\n' + 
                          `ğŸ“‹ æ‰“æƒäº‹é …: ${cleaningData.length} é …\n` +
                          `ğŸ‘¥ å­¸ç”Ÿäººæ•¸: ${studentData.length} äºº\n` +
                          `ğŸ¯ ä»»å‹™åˆ†é…: ${Object.keys(assignments).length} é …ä»»å‹™`);
                    console.log('âœ… å„²å­˜æˆåŠŸ');
                } else {
                    console.error('âŒ å„²å­˜å¤±æ•—:', result.error);
                    alert('âŒ å„²å­˜å¤±æ•—ï¼š' + result.error + '\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚');
                }
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                
            } catch (error) {
                console.error('âŒ å„²å­˜éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('âŒ å„²å­˜å¤±æ•—ï¼Œç³»çµ±éŒ¯èª¤ï¼š' + error.message + '\n\nè«‹æª¢æŸ¥ï¼š\n1. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸\n2. Firebase è¨­å®šæ˜¯å¦æ­£ç¢º\n3. ç€è¦½å™¨ Console ä¸­çš„è©³ç´°éŒ¯èª¤');
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                const saveBtn = document.getElementById('saveAssignments');
                saveBtn.textContent = 'ğŸ’¾ å„²å­˜åˆ†é…';
                saveBtn.disabled = false;
            }
        });

        // å‰å¾€è¿½è¹¤é é¢
        document.getElementById('goToTracking').addEventListener('click', function() {
            window.location.href = 'tracking.html';
        });

        // æ‰“æƒä»»å‹™ç·¨è¼¯å‡½æ•¸
        function updateCleaningTask(index, field, value) {
            if (cleaningData[index]) {
                cleaningData[index][field] = value;
                // é‡æ–°ç”Ÿæˆå®Œæ•´äº‹é …åç¨±
                if (field === 'äº‹é …') {
                    cleaningData[index]['å®Œæ•´äº‹é …'] = `[${cleaningData[index]['åˆ†é ']}] ${value}`;
                }
                console.log(`æ›´æ–°ä»»å‹™ ${index} çš„ ${field}:`, value);
            }
        }

        function deleteCleaningTask(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ‰“æƒäº‹é …å—ï¼Ÿ')) {
                cleaningData.splice(index, 1);
                displayCleaningPreview();
                // é‡æ–°ç”Ÿæˆåˆ†é…ä»‹é¢
                if (studentData.length > 0) {
                    generateAssignmentInterface();
                }
                console.log('åˆªé™¤ä»»å‹™:', index);
            }
        }

        function duplicateCleaningTask(index) {
            if (cleaningData[index]) {
                const newTask = {...cleaningData[index]};
                newTask['äº‹é …'] = newTask['äº‹é …'] + ' (è¤‡è£½)';
                newTask['å®Œæ•´äº‹é …'] = `[${newTask['åˆ†é ']}] ${newTask['äº‹é …']}`;
                cleaningData.push(newTask);
                displayCleaningPreview();
                // é‡æ–°ç”Ÿæˆåˆ†é…ä»‹é¢
                if (studentData.length > 0) {
                    generateAssignmentInterface();
                }
                console.log('è¤‡è£½ä»»å‹™:', index);
            }
        }

        function addNewCleaningTask() {
            const sheetName = prompt('è«‹è¼¸å…¥åˆ†é åç¨±ï¼ˆä¾‹å¦‚ï¼šB1-2Fï¼‰ï¼š');
            const taskName = prompt('è«‹è¼¸å…¥äº‹é …åç¨±ï¼š');
            
            if (sheetName && taskName) {
                const newTask = {
                    'äº‹é …': taskName,
                    'è©³ç´°': '',
                    'æ¨™æº–': '',
                    'äººæ•¸': 1,
                    'åˆ†é ': sheetName,
                    'å®Œæ•´äº‹é …': `[${sheetName}] ${taskName}`
                };
                
                cleaningData.push(newTask);
                displayCleaningPreview();
                // é‡æ–°ç”Ÿæˆåˆ†é…ä»‹é¢
                if (studentData.length > 0) {
                    generateAssignmentInterface();
                }
                console.log('æ–°å¢ä»»å‹™:', newTask);
            }
        }

        function editAllCleaningTasks() {
            // æ‰¹é‡ç·¨è¼¯æ¨¡å¼
            alert('é€²å…¥æ‰¹é‡ç·¨è¼¯æ¨¡å¼ï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨è¡¨æ ¼ä¸­ç·¨è¼¯æ‰€æœ‰å…§å®¹');
        }

        function saveCleaningChanges() {
            alert('æ‰“æƒäº‹é …è®Šæ›´å·²ä¿å­˜ï¼è«‹è¨˜å¾—é‡æ–°å„²å­˜åˆ†é…è³‡æ–™ã€‚');
            // é‡æ–°ç”Ÿæˆåˆ†é…ä»‹é¢ä»¥åæ˜ è®Šæ›´
            if (studentData.length > 0) {
                generateAssignmentInterface();
            }
        }

        // å­¸ç”Ÿç·¨è¼¯å‡½æ•¸
        function updateStudent(index, field, value) {
            if (studentData[index]) {
                studentData[index][field] = value;
                // æ›´æ–°é¡¯ç¤ºæ ¼å¼
                const row = document.querySelector(`tr[data-index="${index}"]`);
                if (row) {
                    const displayCell = row.querySelector('td:nth-child(3) strong');
                    if (displayCell) {
                        displayCell.textContent = `${studentData[index]['å­¸è™Ÿ']} ${studentData[index]['å§“å']}`;
                    }
                }
                console.log(`æ›´æ–°å­¸ç”Ÿ ${index} çš„ ${field}:`, value);
            }
        }

        function deleteStudent(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ')) {
                studentData.splice(index, 1);
                displayStudentPreview();
                // é‡æ–°ç”Ÿæˆåˆ†é…ä»‹é¢
                if (cleaningData.length > 0) {
                    generateAssignmentInterface();
                }
                console.log('åˆªé™¤å­¸ç”Ÿ:', index);
            }
        }

        function duplicateStudent(index) {
            if (studentData[index]) {
                const newStudent = {...studentData[index]};
                newStudent['å­¸è™Ÿ'] = newStudent['å­¸è™Ÿ'] + '_copy';
                newStudent['å§“å'] = newStudent['å§“å'] + ' (è¤‡è£½)';
                studentData.push(newStudent);
                displayStudentPreview();
                // é‡æ–°ç”Ÿæˆåˆ†é…ä»‹é¢
                if (cleaningData.length > 0) {
                    generateAssignmentInterface();
                }
                console.log('è¤‡è£½å­¸ç”Ÿ:', index);
            }
        }

        function addNewStudent() {
            const studentId = prompt('è«‹è¼¸å…¥å­¸è™Ÿï¼š');
            const studentName = prompt('è«‹è¼¸å…¥å§“åï¼š');
            
            if (studentId && studentName) {
                const newStudent = {
                    'å­¸è™Ÿ': studentId,
                    'å§“å': studentName
                };
                
                studentData.push(newStudent);
                displayStudentPreview();
                // é‡æ–°ç”Ÿæˆåˆ†é…ä»‹é¢
                if (cleaningData.length > 0) {
                    generateAssignmentInterface();
                }
                console.log('æ–°å¢å­¸ç”Ÿ:', newStudent);
            }
        }

        function editAllStudents() {
            alert('é€²å…¥æ‰¹é‡ç·¨è¼¯æ¨¡å¼ï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨è¡¨æ ¼ä¸­ç·¨è¼¯æ‰€æœ‰å­¸ç”Ÿè³‡æ–™');
        }

        function saveStudentChanges() {
            alert('å­¸ç”Ÿåå–®è®Šæ›´å·²ä¿å­˜ï¼è«‹è¨˜å¾—é‡æ–°å„²å­˜åˆ†é…è³‡æ–™ã€‚');
            // é‡æ–°ç”Ÿæˆåˆ†é…ä»‹é¢ä»¥åæ˜ è®Šæ›´
            if (cleaningData.length > 0) {
                generateAssignmentInterface();
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç¾æœ‰è³‡æ–™
        window.addEventListener('load', function() {
            loadExistingData();
        });
    </script>
</body>
</html>