<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç®¡ç† - æ‰“æƒè¿½è¹¤ç³»çµ±</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>ğŸ‘¥ å­¸ç”Ÿç®¡ç†</h1>
            <div class="nav-user">
                <span id="userInfo"></span>
                <button onclick="goToTracking()" class="secondary-btn">ğŸ“‹ è¿½è¹¤é é¢</button>
                <button onclick="goToImport()" class="secondary-btn">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
                <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="student-management">
            <div class="management-header">
                <h2>ğŸ“ æˆ‘çš„å­¸ç”Ÿå¸³è™Ÿç®¡ç†</h2>
                <button id="addStudentBtn" class="primary-btn">â• æ–°å¢å­¸ç”Ÿå¸³è™Ÿ</button>
            </div>

            <div class="stats-section">
                <div class="stat-card">
                    <h3 id="totalStudents">0</h3>
                    <p>å­¸ç”Ÿç¸½æ•¸</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeStudents">0</h3>
                    <p>æ´»èºå­¸ç”Ÿ</p>
                </div>
                <div class="stat-card">
                    <h3 id="studentsWithData">0</h3>
                    <p>æœ‰è³‡æ–™å­¸ç”Ÿ</p>
                </div>
            </div>

            <div class="students-table">
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th>å­¸ç”Ÿå§“å</th>
                            <th>å­¸è™Ÿ</th>
                            <th>é›»å­ä¿¡ç®±</th>
                            <th>ç‹€æ…‹</th>
                            <th>å»ºç«‹æ™‚é–“</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ–°å¢å­¸ç”Ÿæ¨¡æ…‹æ¡† -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• æ–°å¢å­¸ç”Ÿå¸³è™Ÿ</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div class="input-group">
                        <label for="studentName">å­¸ç”Ÿå§“å *</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div class="input-group">
                        <label for="studentNumber">å­¸è™Ÿ</label>
                        <input type="text" id="studentNumber" placeholder="é¸å¡«">
                    </div>
                    <div class="input-group">
                        <label for="studentEmail">é›»å­ä¿¡ç®± *</label>
                        <input type="email" id="studentEmail" required>
                        <small>å­¸ç”Ÿå°‡ä½¿ç”¨æ­¤ä¿¡ç®±ç™»å…¥ç³»çµ±</small>
                    </div>
                    <div class="input-group">
                        <label for="studentPassword">åˆå§‹å¯†ç¢¼ *</label>
                        <input type="password" id="studentPassword" value="student123" required>
                        <small>å»ºè­°å­¸ç”Ÿé¦–æ¬¡ç™»å…¥å¾Œä¿®æ”¹å¯†ç¢¼</small>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn">å–æ¶ˆ</button>
                        <button type="submit" class="primary-btn">å»ºç«‹å¸³è™Ÿ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple.js"></script>
    
    <script>
        let currentUser = null;
        let userRole = null;
        let students = [];

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ¬Šé™
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserInfo();
                if (userRole !== 'teacher' && userRole !== 'admin') {
                    alert('æ¬Šé™ä¸è¶³ï¼Œåƒ…æ•™å¸«å’Œç®¡ç†å“¡å¯ä»¥å­˜å–å­¸ç”Ÿç®¡ç†åŠŸèƒ½');
                    window.location.href = 'login.html';
                    return;
                }
                await loadStudents();
            } else {
                window.location.href = 'login.html';
            }
        });

        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUserInfo() {
            if (!currentUser) return;
            
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                const userName = userData?.name || currentUser.displayName || currentUser.email;
                userRole = userData?.role || 'user';
                const userInfoElement = document.getElementById('userInfo');
                const photoURL = currentUser.photoURL || userData?.photoURL;
                
                if (photoURL) {
                    userInfoElement.innerHTML = `
                        <img src="${photoURL}" alt="User Avatar" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                        ${userName} (${userRole === 'admin' ? 'ç®¡ç†å“¡' : userRole === 'teacher' ? 'æ•™å¸«' : 'ä½¿ç”¨è€…'})
                    `;
                } else {
                    userInfoElement.textContent = `${userName} (${userRole === 'admin' ? 'ç®¡ç†å“¡' : userRole === 'teacher' ? 'æ•™å¸«' : 'ä½¿ç”¨è€…'})`;
                }
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:', error);
            }
        }

        // è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨
        async function loadStudents() {
            if (!currentUser) return;

            try {
                let studentsQuery;
                if (userRole === 'admin') {
                    // ç®¡ç†å“¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰å­¸ç”Ÿ
                    studentsQuery = window.firebaseService.db.collection('students');
                } else {
                    // æ•™å¸«åªèƒ½çœ‹åˆ°è‡ªå·±å‰µå»ºçš„å­¸ç”Ÿ
                    studentsQuery = window.firebaseService.db.collection('students')
                        .where('teacherId', '==', currentUser.uid);
                }

                const snapshot = await studentsQuery.get();
                students = [];
                snapshot.forEach(doc => {
                    students.push({ id: doc.id, ...doc.data() });
                });

                updateStudentsTable();
                updateStats();
            } catch (error) {
                console.error('è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨éŒ¯èª¤:', error);
            }
        }

        // æ›´æ–°å­¸ç”Ÿè¡¨æ ¼
        function updateStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            students.forEach(student => {
                const row = document.createElement('tr');
                const createdAt = student.createdAt ? new Date(student.createdAt.toDate()).toLocaleDateString('zh-TW') : 'æœªçŸ¥';
                
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.studentNumber || 'æœªè¨­å®š'}</td>
                    <td>${student.email}</td>
                    <td>
                        <span class="status ${student.status}">${student.status === 'active' ? 'æ´»èº' : 'åœç”¨'}</span>
                    </td>
                    <td>${createdAt}</td>
                    <td>
                        <button onclick="viewStudent('${student.id}')" class="action-btn view">ğŸ‘€ æŸ¥çœ‹</button>
                        <button onclick="toggleStudentStatus('${student.id}')" class="action-btn ${student.status === 'active' ? 'disable' : 'enable'}">
                            ${student.status === 'active' ? 'åœç”¨' : 'å•Ÿç”¨'}
                        </button>
                        <button onclick="deleteStudent('${student.id}')" class="action-btn delete">ğŸ—‘ï¸ åˆªé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('activeStudents').textContent = 
                students.filter(s => s.status === 'active').length;
            document.getElementById('studentsWithData').textContent = 'è¨ˆç®—ä¸­...';

            // ç•°æ­¥è¨ˆç®—æœ‰è³‡æ–™çš„å­¸ç”Ÿæ•¸
            countStudentsWithData();
        }

        // è¨ˆç®—æœ‰è³‡æ–™çš„å­¸ç”Ÿæ•¸
        async function countStudentsWithData() {
            let count = 0;
            for (const student of students) {
                try {
                    const userDataDoc = await window.firebaseService.db
                        .collection('userData').doc(student.id).get();
                    if (userDataDoc.exists && userDataDoc.data()?.cleaningTasks?.length > 0) {
                        count++;
                    }
                } catch (error) {
                    console.warn('æª¢æŸ¥å­¸ç”Ÿè³‡æ–™éŒ¯èª¤:', error);
                }
            }
            document.getElementById('studentsWithData').textContent = count;
        }

        // æ¨¡æ…‹æ¡†æ§åˆ¶
        const modal = document.getElementById('addStudentModal');
        const addBtn = document.getElementById('addStudentBtn');
        const closeBtn = document.querySelector('.close');
        const cancelBtn = document.querySelector('.cancel-btn');

        addBtn.addEventListener('click', () => {
            modal.style.display = 'block';
        });

        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // æ–°å¢å­¸ç”Ÿè¡¨å–®è™•ç†
        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('studentName').value.trim();
            const studentNumber = document.getElementById('studentNumber').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const password = document.getElementById('studentPassword').value;

            if (!name || !email || !password) {
                alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'å»ºç«‹ä¸­...';
            submitBtn.disabled = true;

            try {
                const result = await window.firebaseService.createUser(email, password, {
                    role: 'student',
                    name: name,
                    studentNumber: studentNumber,
                    teacherId: currentUser.uid
                });

                if (result.success) {
                    alert('å­¸ç”Ÿå¸³è™Ÿå»ºç«‹æˆåŠŸï¼');
                    modal.style.display = 'none';
                    document.getElementById('addStudentForm').reset();
                    document.getElementById('studentPassword').value = 'student123'; // é‡è¨­é è¨­å¯†ç¢¼
                    await loadStudents(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                } else {
                    alert('å»ºç«‹å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                console.error('å»ºç«‹å­¸ç”Ÿå¸³è™ŸéŒ¯èª¤:', error);
                alert('å»ºç«‹éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // æŸ¥çœ‹å­¸ç”Ÿè³‡æ–™
        function viewStudent(studentId) {
            // è·³è½‰åˆ°è¿½è¹¤é é¢ä¸¦é¡¯ç¤ºè©²å­¸ç”Ÿçš„è³‡æ–™
            sessionStorage.setItem('viewingStudentId', studentId);
            window.location.href = 'tracking.html';
        }

        // åˆ‡æ›å­¸ç”Ÿç‹€æ…‹
        async function toggleStudentStatus(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const newStatus = student.status === 'active' ? 'inactive' : 'active';
            
            try {
                await window.firebaseService.db.collection('students').doc(studentId).update({
                    status: newStatus
                });
                
                alert(`å­¸ç”Ÿç‹€æ…‹å·²${newStatus === 'active' ? 'å•Ÿç”¨' : 'åœç”¨'}`);
                await loadStudents();
            } catch (error) {
                console.error('æ›´æ–°å­¸ç”Ÿç‹€æ…‹éŒ¯èª¤:', error);
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—');
            }
        }

        // åˆªé™¤å­¸ç”Ÿ
        async function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿã€Œ${student.name}ã€å—ï¼Ÿ\né€™å°‡åŒæ™‚åˆªé™¤è©²å­¸ç”Ÿçš„æ‰€æœ‰è³‡æ–™ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }

            try {
                // åˆªé™¤å­¸ç”Ÿè¨˜éŒ„ã€ä½¿ç”¨è€…å¸³è™Ÿå’Œæ‰€æœ‰ç›¸é—œè³‡æ–™
                const batch = window.firebaseService.db.batch();
                
                // åˆªé™¤ students é›†åˆä¸­çš„è¨˜éŒ„
                batch.delete(window.firebaseService.db.collection('students').doc(studentId));
                
                // åˆªé™¤ users é›†åˆä¸­çš„è¨˜éŒ„
                batch.delete(window.firebaseService.db.collection('users').doc(studentId));
                
                // åˆªé™¤ userData é›†åˆä¸­çš„è¨˜éŒ„
                batch.delete(window.firebaseService.db.collection('userData').doc(studentId));
                
                // åˆªé™¤ trackingData é›†åˆä¸­çš„è¨˜éŒ„
                batch.delete(window.firebaseService.db.collection('trackingData').doc(studentId));

                await batch.commit();
                
                alert('å­¸ç”Ÿå¸³è™ŸåŠæ‰€æœ‰è³‡æ–™å·²åˆªé™¤');
                await loadStudents();
            } catch (error) {
                console.error('åˆªé™¤å­¸ç”ŸéŒ¯èª¤:', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // å°èˆªå‡½æ•¸
        function goToTracking() {
            window.location.href = 'tracking.html';
        }

        function goToImport() {
            window.location.href = 'import.html';
        }

        function logout() {
            window.firebaseService.signOut().then(() => {
                sessionStorage.clear();
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>ğŸ‘¥ å­¸ç”Ÿå¸³è™Ÿç®¡ç†</h1>
            <div class="nav-user">
                <span id="userInfo"></span>
                <div id="navButtons">
                    <button onclick="goToImport()" class="secondary-btn">ğŸ“‹ è³‡æ–™åŒ¯å…¥</button>
                    <button onclick="goToTracking()" class="secondary-btn">ğŸ“Š è¿½è¹¤é é¢</button>
                </div>
                <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- å–®ä¸€å­¸ç”Ÿå‰µå»º -->
        <div class="step-container">
            <h2>â• å‰µå»ºå­¸ç”Ÿå¸³è™Ÿï¼ˆè¡›ç”Ÿè‚¡é•·ç­‰ï¼‰</h2>
            <div class="info-box" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; border-radius: 4px;">
                <p><strong>ğŸ’¡ ç”¨é€”èªªæ˜ï¼š</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>ğŸ§¹ ç‚ºç­ç´šè¡›ç”Ÿè‚¡é•·å‰µå»ºç™»å…¥å¸³è™Ÿ</li>
                    <li>ğŸ‘¥ å…¶ä»–éœ€è¦è¿½è¹¤æ‰“æƒçš„å­¸ç”Ÿ</li>
                    <li>ğŸ“Š å­¸ç”Ÿå¸³è™Ÿåªèƒ½æ¨™è¨˜ç¼ºå¤±ï¼Œç„¡æ³•ä¿®æ”¹å„ªé»</li>
                </ul>
            </div>
            <div class="form-section">
                <div class="input-row">
                    <div class="input-group">
                        <label for="studentNumber">å­¸è™Ÿ</label>
                        <input type="text" id="studentNumber" placeholder="ä¾‹ï¼š412101" required>
                    </div>
                    <div class="input-group">
                        <label for="studentName">å§“å</label>
                        <input type="text" id="studentName" placeholder="ä¾‹ï¼šæå°æ˜" required>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label for="studentEmail">é›»å­ä¿¡ç®±</label>
                        <input type="email" id="studentEmail" placeholder="ä¾‹ï¼š412101@school.edu.tw" required>
                    </div>
                    <div class="input-group">
                        <label for="studentPassword">é è¨­å¯†ç¢¼</label>
                        <input type="password" id="studentPassword" placeholder="è¨­å®šé è¨­å¯†ç¢¼" required>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="createStudent" class="primary-btn">ğŸ‘¤ å‰µå»ºå­¸ç”Ÿå¸³è™Ÿ</button>
                </div>
            </div>
        </div>

        <!-- æ‰¹é‡åŒ¯å…¥å­¸ç”Ÿ -->
        <div class="step-container">
            <h2>ğŸ“Š æ‰¹é‡åŒ¯å…¥å­¸ç”Ÿ</h2>
            <div class="upload-section">
                <input type="file" id="studentBatchFile" accept=".xlsx,.xls" class="file-input">
                <label for="studentBatchFile" class="file-label">
                    ğŸ“‹ é¸æ“‡å­¸ç”Ÿåå–®.xlsx
                </label>
                <div class="import-instructions">
                    <h4>ğŸ“ Excel æ ¼å¼è¦æ±‚ï¼š</h4>
                    <ul>
                        <li><strong>å­¸è™Ÿ</strong> - å­¸ç”Ÿå­¸è™Ÿæ¬„ä½</li>
                        <li><strong>å§“å</strong> - å­¸ç”Ÿå§“åæ¬„ä½</li>
                        <li><strong>ä¿¡ç®±</strong> - å­¸ç”Ÿé›»å­ä¿¡ç®±ï¼ˆé¸å¡«ï¼‰</li>
                        <li>ç³»çµ±æœƒè‡ªå‹•ç”Ÿæˆé è¨­å¯†ç¢¼ï¼šå­¸è™Ÿ+123</li>
                    </ul>
                </div>
                <div id="batchPreview" class="preview-section"></div>
                <div class="action-buttons" id="batchActions" style="display: none;">
                    <button id="createBatchStudents" class="primary-btn">ğŸ‘¥ æ‰¹é‡å‰µå»ºå­¸ç”Ÿå¸³è™Ÿ</button>
                </div>
            </div>
        </div>

        <!-- ç¾æœ‰å­¸ç”Ÿç®¡ç† -->
        <div class="step-container">
            <h2>ğŸ‘¥ ç¾æœ‰å­¸ç”Ÿç®¡ç†</h2>
            <div id="existingStudents" class="students-list">
                <div class="loading">è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨ä¸­...</div>
            </div>
            <div class="action-buttons">
                <button id="refreshStudents" class="secondary-btn">ğŸ”„ é‡æ–°è¼‰å…¥</button>
            </div>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple-public.js"></script>
    
    <script>
        let currentUser = null;
        let userRole = null;
        let batchStudentData = [];

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.firebaseService.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserInfo();
            } else {
                window.location.href = 'login.html';
            }
        });

        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šä¸¦æª¢æŸ¥æ¬Šé™
        async function loadUserInfo() {
            if (!currentUser) return;
            
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                userRole = userData?.role || 'user';
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºè€å¸«æˆ–ç®¡ç†å“¡
                if (userRole !== 'teacher' && userRole !== 'admin') {
                    alert('âŒ å­˜å–è¢«æ‹’ï¼šåªæœ‰è€å¸«æˆ–ç®¡ç†å“¡å¯ä»¥ç®¡ç†å­¸ç”Ÿå¸³è™Ÿ');
                    window.location.href = 'tracking.html';
                    return;
                }
                
                // æ ¹æ“šè§’è‰²é¡¯ç¤ºä¸åŒçš„å°èˆª
                if (userRole === 'admin') {
                    document.getElementById('userInfo').textContent = `${userData?.name || currentUser.email} (ç®¡ç†å“¡)`;
                    document.getElementById('navButtons').innerHTML = `
                        <button onclick="goToAdminManagement()" class="secondary-btn">ğŸ”‘ ç®¡ç†é¢æ¿</button>
                        <button onclick="goToImport()" class="secondary-btn">ğŸ“‹ è³‡æ–™åŒ¯å…¥</button>
                        <button onclick="goToTracking()" class="secondary-btn">ğŸ“Š è¿½è¹¤é é¢</button>
                    `;
                } else {
                    document.getElementById('userInfo').textContent = `${userData?.name || currentUser.email} (è€å¸«)`;
                }
                    
                // è¼‰å…¥ç¾æœ‰å­¸ç”Ÿåˆ—è¡¨
                loadExistingStudents();
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:', error);
                alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        }

        // å‰µå»ºå–®ä¸€å­¸ç”Ÿå¸³è™Ÿ
        document.getElementById('createStudent').addEventListener('click', async function() {
            const studentNumber = document.getElementById('studentNumber').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const studentEmail = document.getElementById('studentEmail').value.trim();
            const studentPassword = document.getElementById('studentPassword').value.trim();

            if (!studentNumber || !studentName || !studentEmail || !studentPassword) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦è³‡è¨Š');
                return;
            }

            const btn = this;
            const originalText = btn.textContent;
            btn.textContent = 'â³ å‰µå»ºä¸­...';
            btn.disabled = true;

            try {
                // å‰µå»º Firebase å¸³è™Ÿ
                const result = await window.firebaseService.createUser(studentEmail, studentPassword, {
                    role: 'student',
                    name: studentName,
                    studentNumber: studentNumber,
                    teacherId: currentUser.uid
                });

                if (result.success) {
                    // å­¸ç”Ÿè³‡æ–™å·²åœ¨ createUser ä¸­è‡ªå‹•è™•ç†
                    alert(`âœ… å­¸ç”Ÿå¸³è™Ÿå‰µå»ºæˆåŠŸï¼\n\nå­¸è™Ÿï¼š${studentNumber}\nå§“åï¼š${studentName}\nä¿¡ç®±ï¼š${studentEmail}`);
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('studentNumber').value = '';
                    document.getElementById('studentName').value = '';
                    document.getElementById('studentEmail').value = '';
                    document.getElementById('studentPassword').value = '';
                    
                    // å¦‚æœéœ€è¦é‡æ–°èªè­‰ï¼ˆé¿å…è‡ªå‹•ç™»å…¥åˆ°å­¸ç”Ÿå¸³è™Ÿï¼‰
                    if (result.needsReauth) {
                        alert('âš ï¸ å­¸ç”Ÿå¸³è™Ÿå·²å‰µå»ºæˆåŠŸï¼Œç³»çµ±å°‡é‡æ–°æ•´ç†é é¢ä»¥ä¿æŒæ‚¨çš„ç™»å…¥ç‹€æ…‹ã€‚');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        // é‡æ–°è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨
                        loadExistingStudents();
                    }
                } else {
                    alert('âŒ å‰µå»ºå¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                console.error('å‰µå»ºå­¸ç”Ÿå¸³è™ŸéŒ¯èª¤:', error);
                alert('âŒ å‰µå»ºå¤±æ•—ï¼šç³»çµ±éŒ¯èª¤');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        // æ‰¹é‡åŒ¯å…¥å­¸ç”Ÿ
        document.getElementById('studentBatchFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    batchStudentData = XLSX.utils.sheet_to_json(worksheet);
                    displayBatchPreview();
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function displayBatchPreview() {
            const preview = document.getElementById('batchPreview');
            if (batchStudentData.length === 0) return;

            let html = '<h3>ğŸ“‹ åŒ¯å…¥é è¦½</h3>';
            html += '<table class="preview-table"><thead><tr>';
            html += '<th>å­¸è™Ÿ</th><th>å§“å</th><th>ä¿¡ç®±</th><th>é è¨­å¯†ç¢¼</th>';
            html += '</tr></thead><tbody>';

            batchStudentData.slice(0, 10).forEach(student => {
                const studentNumber = student['å­¸è™Ÿ'] || '';
                const studentName = student['å§“å'] || '';
                const studentEmail = student['ä¿¡ç®±'] || `${studentNumber}@school.edu.tw`;
                const defaultPassword = `${studentNumber}123`;
                
                html += '<tr>';
                html += `<td>${studentNumber}</td>`;
                html += `<td>${studentName}</td>`;
                html += `<td>${studentEmail}</td>`;
                html += `<td>${defaultPassword}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            
            if (batchStudentData.length > 10) {
                html += `<p>...å¦å¤–é‚„æœ‰ ${batchStudentData.length - 10} ä½å­¸ç”Ÿ</p>`;
            }
            
            html += `<div class="import-summary">
                <h4>ğŸ‘¥ æ‰¹é‡åŒ¯å…¥æ‘˜è¦</h4>
                <p>âœ… æº–å‚™å‰µå»º <strong>${batchStudentData.length}</strong> ä½å­¸ç”Ÿå¸³è™Ÿ</p>
                <p>ğŸ”‘ é è¨­å¯†ç¢¼æ ¼å¼ï¼šå­¸è™Ÿ + 123</p>
                <p>ğŸ“§ é è¨­ä¿¡ç®±æ ¼å¼ï¼šå­¸è™Ÿ@school.edu.tw</p>
            </div>`;
            
            preview.innerHTML = html;
            document.getElementById('batchActions').style.display = 'block';
        }

        // æ‰¹é‡å‰µå»ºå­¸ç”Ÿå¸³è™Ÿ
        document.getElementById('createBatchStudents').addEventListener('click', async function() {
            if (batchStudentData.length === 0) {
                alert('è«‹å…ˆåŒ¯å…¥å­¸ç”Ÿè³‡æ–™');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦å‰µå»º ${batchStudentData.length} ä½å­¸ç”Ÿå¸³è™Ÿå—ï¼Ÿ`)) {
                return;
            }

            const btn = this;
            const originalText = btn.textContent;
            btn.disabled = true;

            let successCount = 0;
            let failCount = 0;
            const errors = [];

            for (let i = 0; i < batchStudentData.length; i++) {
                const student = batchStudentData[i];
                const studentNumber = student['å­¸è™Ÿ'] || '';
                const studentName = student['å§“å'] || '';
                const studentEmail = student['ä¿¡ç®±'] || `${studentNumber}@school.edu.tw`;
                const defaultPassword = `${studentNumber}123`;

                btn.textContent = `â³ å‰µå»ºä¸­... (${i + 1}/${batchStudentData.length})`;

                try {
                    const result = await window.firebaseService.createUser(studentEmail, defaultPassword, {
                        role: 'student',
                        name: studentName,
                        studentNumber: studentNumber,
                        teacherId: currentUser.uid
                    });

                    if (result.success) {
                        // å­¸ç”Ÿè³‡æ–™å·²åœ¨ createUser ä¸­è‡ªå‹•è™•ç†
                        successCount++;
                    } else {
                        failCount++;
                        errors.push(`${studentName} (${studentNumber}): ${result.error}`);
                    }
                } catch (error) {
                    failCount++;
                    errors.push(`${studentName} (${studentNumber}): ç³»çµ±éŒ¯èª¤`);
                }

                // é¿å…è«‹æ±‚éæ–¼é »ç¹
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            let message = `ğŸ‰ æ‰¹é‡å‰µå»ºå®Œæˆï¼\n\nâœ… æˆåŠŸï¼š${successCount} ä½\nâŒ å¤±æ•—ï¼š${failCount} ä½`;
            if (errors.length > 0) {
                message += `\n\nå¤±æ•—è©³æƒ…ï¼š\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) {
                    message += `\n...å¦å¤–é‚„æœ‰ ${errors.length - 5} å€‹éŒ¯èª¤`;
                }
            }

            alert(message);
            
            // é‡æ–°è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨
            loadExistingStudents();
            
            // æ¸…ç©ºåŒ¯å…¥è³‡æ–™
            batchStudentData = [];
            document.getElementById('batchPreview').innerHTML = '';
            document.getElementById('batchActions').style.display = 'none';
            document.getElementById('studentBatchFile').value = '';

            btn.textContent = originalText;
            btn.disabled = false;
        });

        // è¼‰å…¥ç¾æœ‰å­¸ç”Ÿåˆ—è¡¨
        async function loadExistingStudents() {
            const container = document.getElementById('existingStudents');
            container.innerHTML = '<div class="loading">è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨ä¸­...</div>';

            try {
                const snapshot = await window.firebaseService.db
                    .collection('students')
                    .where('teacherId', '==', currentUser.uid)
                    .get();

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="no-data">
                            <p>ğŸ“ å°šæœªå‰µå»ºä»»ä½•å­¸ç”Ÿå¸³è™Ÿ</p>
                            <p>è«‹ä½¿ç”¨ä¸Šæ–¹åŠŸèƒ½å‰µå»ºå­¸ç”Ÿå¸³è™Ÿ</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="students-grid">';
                snapshot.forEach(doc => {
                    const student = doc.data();
                    const studentId = doc.id;
                    
                    html += `
                        <div class="student-card" data-student-id="${studentId}">
                            <div class="student-info">
                                <h4>${student.studentNumber} ${student.name}</h4>
                                <p>ğŸ“§ ${student.email}</p>
                                <p>ğŸ“… å‰µå»ºæ™‚é–“ï¼š${student.createdAt?.toDate()?.toLocaleDateString() || 'æœªçŸ¥'}</p>
                                <span class="status-badge ${student.status || 'active'}">${student.status === 'active' ? 'ğŸŸ¢ æ­£å¸¸' : 'ğŸ”´ åœç”¨'}</span>
                            </div>
                            <div class="student-actions">
                                <button class="action-btn reset-pwd" onclick="resetStudentPassword('${studentId}', '${student.studentNumber}')">ğŸ”‘ é‡ç½®å¯†ç¢¼</button>
                                <button class="action-btn toggle-status" onclick="toggleStudentStatus('${studentId}', '${student.status}')">
                                    ${student.status === 'active' ? 'ğŸ”´ åœç”¨' : 'ğŸŸ¢ å•Ÿç”¨'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨éŒ¯èª¤:', error);
                container.innerHTML = `
                    <div class="error">
                        <p>âŒ è¼‰å…¥å¤±æ•—</p>
                        <button onclick="loadExistingStudents()" class="secondary-btn">ğŸ”„ é‡è©¦</button>
                    </div>
                `;
            }
        }

        // é‡ç½®å­¸ç”Ÿå¯†ç¢¼
        async function resetStudentPassword(studentId, studentNumber) {
            if (!confirm(`ç¢ºå®šè¦é‡ç½® ${studentNumber} çš„å¯†ç¢¼å—ï¼Ÿ\næ–°å¯†ç¢¼å°‡è¨­ç‚ºï¼š${studentNumber}123`)) {
                return;
            }

            try {
                // æ³¨æ„ï¼šFirebase ä¸æä¾›ç›´æ¥é‡ç½®å…¶ä»–ç”¨æˆ¶å¯†ç¢¼çš„åŠŸèƒ½
                // é€™è£¡åªæ˜¯æ›´æ–°è³‡æ–™åº«è¨˜éŒ„ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­å¯èƒ½éœ€è¦å…¶ä»–å¯¦ä½œæ–¹å¼
                await window.firebaseService.db.collection('students').doc(studentId).update({
                    passwordReset: true,
                    lastPasswordReset: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`âœ… å·²æ¨™è¨˜å¯†ç¢¼é‡ç½®\nè«‹é€šçŸ¥å­¸ç”Ÿä½¿ç”¨æ–°å¯†ç¢¼ï¼š${studentNumber}123`);
            } catch (error) {
                console.error('é‡ç½®å¯†ç¢¼éŒ¯èª¤:', error);
                alert('âŒ é‡ç½®å¤±æ•—ï¼šç³»çµ±éŒ¯èª¤');
            }
        }

        // åˆ‡æ›å­¸ç”Ÿç‹€æ…‹
        async function toggleStudentStatus(studentId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'å•Ÿç”¨' : 'åœç”¨';
            
            if (!confirm(`ç¢ºå®šè¦${action}æ­¤å­¸ç”Ÿå¸³è™Ÿå—ï¼Ÿ`)) {
                return;
            }

            try {
                await window.firebaseService.db.collection('students').doc(studentId).update({
                    status: newStatus,
                    lastStatusUpdate: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`âœ… å­¸ç”Ÿå¸³è™Ÿå·²${action}`);
                loadExistingStudents();
            } catch (error) {
                console.error('æ›´æ–°å­¸ç”Ÿç‹€æ…‹éŒ¯èª¤:', error);
                alert('âŒ æ›´æ–°å¤±æ•—ï¼šç³»çµ±éŒ¯èª¤');
            }
        }

        // é‡æ–°è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨
        document.getElementById('refreshStudents').addEventListener('click', loadExistingStudents);

        // å°èˆªåŠŸèƒ½
        function goToImport() {
            window.location.href = 'import.html';
        }

        function goToAdminManagement() {
            window.location.href = 'admin-management.html';
        }

        function goToTracking() {
            window.location.href = 'tracking.html';
        }

        async function logout() {
            try {
                await window.firebaseService.signOut();
                sessionStorage.clear();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
    </script>
</body>
</html>