<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打掃追蹤系統 - 追蹤頁面</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>🧹 打掃追蹤系統</h1>
            <div class="nav-user">
                <span id="userInfo"></span>
                <button onclick="goToImport()" class="secondary-btn">📋 修改分配</button>
                <button onclick="logout()" class="logout-btn">登出</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="tracking-header">
            <h2>📊 打掃追蹤表</h2>
            <div id="dataSourceInfo" class="data-source-info" style="display: none;">
                <div class="source-badge">
                    <span class="source-icon">🎓</span>
                    <div class="source-text">
                        <strong>查看教師資料</strong>
                        <small id="teacherNameDisplay"></small>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button id="prevWeek" class="control-btn">◀ 上週</button>
                <span id="currentWeek" class="week-display"></span>
                <button id="nextWeek" class="control-btn">下週 ▶</button>
            </div>
            <div class="legend">
                <span class="legend-item">🏅 優點</span>
                <span class="legend-item">😈 缺失</span>
                <span class="legend-item warning">⚠️ 三次缺失警告</span>
            </div>
        </div>

        <div class="user-selector" id="userSelector" style="display: none;">
            <label for="selectedUser">選擇要查看的使用者：</label>
            <select id="selectedUser">
                <option value="">載入中...</option>
            </select>
            <div class="user-info-display" id="selectedUserInfo"></div>
        </div>
        
        <div class="student-mode-banner" id="studentModeBanner" style="display: none;">
            <div class="banner-content">
                <span class="banner-icon">🛡️</span>
                <div class="banner-text">
                    <strong>衛生股長模式</strong> - 協助老師檢查打掃狀況
                    <br><small>你可以標記缺點 😈，但只有老師能解除缺點或給予優點 🏅</small>
                </div>
            </div>
        </div>

        <div id="trackingTable" class="tracking-table-container">
            <div class="no-data">
                <p>📝 尚未匯入資料</p>
                <button onclick="goToImport()" class="primary-btn">前往匯入資料</button>
            </div>
        </div>

        <div class="statistics" id="statisticsPanel" style="display: none;">
            <h3>📈 統計資訊</h3>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- Firebase 配置 -->
    <script src="firebase-simple-public.js"></script>
    
    <script>
        let currentUser = null;
        let userRole = null;
        let userName = null;
        let allUsers = {}; // 管理員用：儲存所有使用者資訊
        
        // 檢查登入狀態
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserInfo();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        // 載入使用者資訊
        async function loadUserInfo() {
            if (!currentUser) return;
            
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                userName = userData?.name || currentUser.displayName || currentUser.email;
                userRole = userData?.role || 'user';
                
                // 更新使用者資訊顯示，包含頭像（如果有的話）
                const userInfoElement = document.getElementById('userInfo');
                const photoURL = currentUser.photoURL || userData?.photoURL;
                
                if (photoURL) {
                    userInfoElement.innerHTML = `
                        <img src="${photoURL}" alt="User Avatar" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                        ${userName} (${userRole === 'teacher' ? '教師' : '學生'})
                    `;
                } else {
                    userInfoElement.textContent = `${userName} (${userRole === 'teacher' ? '教師' : '學生'})`;
                }
                
                // 根據角色添加對應按鈕
                const navUser = document.querySelector('.nav-user');
                const importBtn = navUser.querySelector('button');
                
                if (userRole === 'teacher') {
                    // 教師：添加學生管理按鈕並載入學生資料
                    const studentMgmtBtn = document.createElement('button');
                    studentMgmtBtn.textContent = '👥 學生管理';
                    studentMgmtBtn.className = 'secondary-btn';
                    studentMgmtBtn.onclick = () => window.location.href = 'student-management.html';
                    navUser.insertBefore(studentMgmtBtn, importBtn);
                    
                    // 教師模式：直接使用自己的資料，不需要載入其他使用者
                }
                
                // 初始化頁面
                await initializePage();
            } catch (error) {
                console.error('載入使用者資訊錯誤:', error);
            }
        }
        
        // 載入所有使用者（管理員功能）
        async function loadAllUsers() {
            try {
                const result = await window.firebaseService.getAllUsers();
                if (result.success) {
                    result.users.forEach(user => {
                        allUsers[user.id] = user;
                    });
                    
                    // 更新使用者選擇器
                    updateUserSelector();
                }
            } catch (error) {
                console.error('載入使用者清單錯誤:', error);
            }
        }
        
        // 載入教師的學生（教師功能）
        async function loadTeacherStudents() {
            try {
                // 載入屬於此教師的學生
                const studentsQuery = window.firebaseService.db.collection('students')
                    .where('teacherId', '==', currentUser.uid)
                    .where('status', '==', 'active');
                
                const studentsSnapshot = await studentsQuery.get();
                
                // 清空 allUsers，只包含這個教師的學生
                allUsers = {};
                
                // 載入每個學生的完整使用者資料
                const promises = [];
                studentsSnapshot.forEach(doc => {
                    const student = { id: doc.id, ...doc.data() };
                    promises.push(
                        window.firebaseService.db.collection('users').doc(student.id).get()
                        .then(userDoc => {
                            if (userDoc.exists) {
                                allUsers[student.id] = { 
                                    ...userDoc.data(), 
                                    id: student.id,
                                    studentNumber: student.studentNumber 
                                };
                            }
                        })
                    );
                });
                
                await Promise.all(promises);
                console.log('載入教師學生數量:', Object.keys(allUsers).length);
                
                // 更新使用者選擇器
                updateUserSelector();
            } catch (error) {
                console.error('載入教師學生錯誤:', error);
            }
        }
        
        // 更新使用者選擇器
        function updateUserSelector() {
            if (userRole !== 'teacher') return;
            
            const selector = document.getElementById('selectedUser');
            selector.innerHTML = '';
            
            // 添加所有使用者
            Object.entries(allUsers).forEach(([userId, user]) => {
                const option = document.createElement('option');
                option.value = userId;
                
                let roleText = '';
                if (user.role === 'teacher') roleText = ' (教師)';
                else if (user.role === 'student') roleText = ' (學生)';
                else roleText = ' (使用者)';
                
                // 顯示學號（如果有）
                const studentNumber = user.studentNumber ? ` ${user.studentNumber}` : '';
                option.textContent = `${user.name || user.email}${studentNumber}${roleText}`;
                selector.appendChild(option);
            });
            
            // 預設選擇第一個使用者
            let defaultUserId = null;
            for (const [userId, user] of Object.entries(allUsers)) {
                if (userRole === 'admin' && user.role !== 'admin') { 
                    // 管理員優先選擇非管理員使用者
                    defaultUserId = userId;
                    break;
                } else if (userRole === 'teacher') { 
                    // 教師選擇第一個學生
                    defaultUserId = userId;
                    break;
                }
            }
            
            if (!defaultUserId && selector.options.length > 0) {
                defaultUserId = selector.options[0].value;
            }
            
            if (defaultUserId) {
                selector.value = defaultUserId;
                selectedUser = defaultUserId;
                updateSelectedUserInfo();
            }
        }

        // 更新選中使用者的資訊顯示
        function updateSelectedUserInfo() {
            const infoDiv = document.getElementById('selectedUserInfo');
            if (!selectedUser || !allUsers[selectedUser]) {
                infoDiv.innerHTML = '';
                return;
            }
            
            const user = allUsers[selectedUser];
            const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';
            const roleName = user.role === 'admin' ? '管理員' : '使用者';
            
            infoDiv.innerHTML = `
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #007bff;">
                    <strong>📊 正在查看：</strong>
                    <span style="margin-left: 10px;">${user.name || user.email}</span>
                    <span class="${roleClass}" style="margin-left: 10px;">${roleName}</span>
                    <br><small style="color: #666; margin-top: 5px;">Email: ${user.email}</small>
                </div>
            `;
        }

        // 即時監聽器變數
        let unsubscribeTeacherData = null;
        let unsubscribeTrackingData = null;
        
        // 初始化頁面
        async function initializePage() {
            // 檢查是否為學生模式
            const isStudentMode = sessionStorage.getItem('isStudentMode') === 'true';
            
            console.log('🔄 初始化頁面:', {
                userRole,
                isStudentMode,
                currentUserUid: currentUser?.uid
            });
            
            if (userRole === 'student' && isStudentMode) {
                // 學生模式：隱藏用戶選擇器和修改分配按鈕
                console.log('🎓 學生模式：隱藏用戶選擇器和修改分配按鈕');
                document.getElementById('userSelector').style.display = 'none';
                // 隱藏修改分配按鈕
                const importButtons = document.querySelectorAll('button[onclick="goToImport()"]');
                importButtons.forEach(btn => btn.style.display = 'none');
                selectedUser = currentUser?.uid;
                
                // 顯示學生模式提示
                const userSelectorDiv = document.getElementById('userSelector');
                const studentNotice = document.createElement('div');
                studentNotice.className = 'student-notice';
                studentNotice.innerHTML = `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #2196f3;">
                        <strong>🎓 學生模式</strong><br>
                        <small>顯示您的個人打掃任務和記錄</small>
                    </div>
                `;
                userSelectorDiv.parentNode.insertBefore(studentNotice, userSelectorDiv);
                
            } else if (userRole === 'admin') {
                // 管理員：顯示用戶選擇器
                console.log('👨‍💼 管理員模式：顯示用戶選擇器');
                document.getElementById('userSelector').style.display = 'block';
                selectedUser = currentUser?.uid;
                updateUserSelector();
            } else if (userRole === 'teacher') {
                // 教師：只查看自己的資料，不顯示用戶選擇器
                console.log('👨‍🏫 教師模式：查看自己的匯入資料');
                document.getElementById('userSelector').style.display = 'none';
                selectedUser = currentUser?.uid;
            } else {
                // 其他情況：設定預設選擇的使用者
                selectedUser = currentUser?.uid;
            }
            
            console.log('初始化頁面，選擇的使用者:', selectedUser);
            
            // 初始化週次顯示和表格
            updateWeekDisplay();
            await generateTrackingTable();
            
            // 設定即時監聽器
            setupRealtimeListeners();
        }
        
        // 設定即時監聽器
        function setupRealtimeListeners() {
            // 清理舊的監聽器
            if (unsubscribeTeacherData) {
                unsubscribeTeacherData();
                unsubscribeTeacherData = null;
            }
            if (unsubscribeTrackingData) {
                unsubscribeTrackingData();
                unsubscribeTrackingData = null;
            }
            
            if (!currentUser) return;
            
            const isStudentMode = sessionStorage.getItem('isStudentMode') === 'true';
            
            if (userRole === 'student' && isStudentMode) {
                // 學生模式：監聽教師資料變化
                console.log('🔔 設定學生模式即時監聽器');
                
                window.firebaseService.onTeacherDataChanged(currentUser.uid, (update) => {
                    console.log('📡 收到教師資料更新:', update.type);
                    
                    if (update.type === 'userData' && update.data) {
                        // 更新本地的 userData
                        const oldTaskCount = userData?.cleaningTasks?.length || 0;
                        const newTaskCount = update.data.cleaningTasks?.length || 0;
                        
                        userData = {
                            ...update.data,
                            isStudentMode: true,
                            studentId: currentUser.uid,
                            teacherId: update.teacherId,
                            teacherInfo: userData?.teacherInfo,
                            studentInfo: userData?.studentInfo
                        };
                        
                        // 如果打掃任務有變化，重新生成表格
                        if (oldTaskCount !== newTaskCount || 
                            JSON.stringify(userData.assignments) !== JSON.stringify(update.data.assignments)) {
                            console.log('🔄 教師資料已更新，重新生成表格');
                            generateTrackingTable();
                        }
                    }
                });
                
                // 監聽教師的追蹤資料變化（學生模式下也要同步教師的追蹤）
                const teacherId = sessionStorage.getItem('teacherId');
                if (teacherId) {
                    unsubscribeTrackingData = window.firebaseService.onTrackingDataChanged(teacherId, (doc) => {
                        if (doc.exists) {
                            trackingData = doc.data();
                            console.log('📡 教師追蹤資料已更新（學生模式）');
                            // 更新統計和顯示
                            updateStatistics();
                        }
                    });
                }
                
            } else {
                // 一般模式：監聽選中使用者的資料
                const targetUserId = selectedUser || currentUser.uid;
                
                unsubscribeTeacherData = window.firebaseService.onUserDataChanged(targetUserId, (doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        console.log('📡 使用者資料已更新');
                        generateTrackingTable();
                    }
                });
                
                unsubscribeTrackingData = window.firebaseService.onTrackingDataChanged(targetUserId, (doc) => {
                    if (doc.exists) {
                        trackingData = doc.data();
                        console.log('📡 追蹤資料已更新');
                        updateStatistics();
                    }
                });
            }
        }
        
        // 頁面卸載時清理監聽器
        window.addEventListener('beforeunload', () => {
            if (unsubscribeTeacherData) unsubscribeTeacherData();
            if (unsubscribeTrackingData) unsubscribeTrackingData();
        });

        let currentWeek = new Date();
        let selectedUser = null; // 將在使用者登入後設定
        let userData = null;
        let trackingData = {};

        // 週次導航
        document.getElementById('prevWeek').addEventListener('click', async () => {
            currentWeek.setDate(currentWeek.getDate() - 7);
            updateWeekDisplay();
            await generateTrackingTable();
        });

        document.getElementById('nextWeek').addEventListener('click', async () => {
            currentWeek.setDate(currentWeek.getDate() + 7);
            updateWeekDisplay();
            await generateTrackingTable();
        });

        // 使用者選擇（管理員功能）
        document.getElementById('selectedUser')?.addEventListener('change', async (e) => {
            selectedUser = e.target.value;
            console.log('使用者選擇變更為:', selectedUser);
            updateSelectedUserInfo();
            await generateTrackingTable();
        });

        async function logout() {
            try {
                await window.firebaseService.signOut();
                sessionStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('登出錯誤:', error);
                alert('登出失敗，請稍後再試');
            }
        }

        function goToImport() {
            window.location.href = 'import.html';
        }

        function getWeekKey(date) {
            const year = date.getFullYear();
            const weekNum = getWeekNumber(date);
            return `${year}-W${weekNum}`;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function updateWeekDisplay() {
            const startOfWeek = new Date(currentWeek);
            startOfWeek.setDate(currentWeek.getDate() - currentWeek.getDay());
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const formatDate = (date) => `${date.getMonth() + 1}/${date.getDate()}`;
            
            document.getElementById('currentWeek').textContent = 
                `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
        }

        async function loadUserData() {
            const targetUserId = selectedUser || currentUser?.uid;
            if (!targetUserId) return false;
            
            try {
                // 檢查是否為學生模式（從 sessionStorage）
                const isStudentMode = sessionStorage.getItem('isStudentMode') === 'true';
                const teacherId = sessionStorage.getItem('teacherId');
                
                if (isStudentMode && userRole === 'student' && currentUser?.uid === targetUserId) {
                    // 學生模式：載入教師的資料
                    console.log('🎓 學生模式：載入教師資料');
                    return await loadStudentTeacherData(targetUserId);
                } else if (await isStudent(targetUserId)) {
                    // 教師查看學生的情況
                    return await loadStudentTeacherData(targetUserId);
                }
                
                // 一般情況：載入指定使用者的資料
                const [userDataResult, trackingResult] = await Promise.all([
                    window.firebaseService.getUserData(targetUserId),
                    window.firebaseService.getTrackingData(targetUserId)
                ]);
                
                if (userDataResult.success && userDataResult.data) {
                    userData = userDataResult.data;
                    
                    if (trackingResult.success) {
                        trackingData = trackingResult.data || {};
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('載入使用者資料錯誤:', error);
            }
            return false;
        }
        
        // 檢查用戶是否為學生
        async function isStudent(userId) {
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(userId).get();
                return userDoc.exists && userDoc.data()?.role === 'student';
            } catch (error) {
                console.error('檢查用戶角色錯誤:', error);
                return false;
            }
        }
        
        // 檢查是否為教師的學生
        async function isTeacherStudent(teacherId, studentId) {
            try {
                const studentDoc = await window.firebaseService.db.collection('students').doc(studentId).get();
                return studentDoc.exists && studentDoc.data()?.teacherId === teacherId;
            } catch (error) {
                console.error('檢查師生關係錯誤:', error);
                return false;
            }
        }
        
        // 載入學生對應教師的資料
        async function loadStudentTeacherData(studentId) {
            try {
                console.log('載入學生教師資料，學生ID:', studentId);
                
                // 使用新的 getTeacherDataForStudent 方法
                const teacherDataResult = await window.firebaseService.getTeacherDataForStudent(studentId);
                
                if (!teacherDataResult.success) {
                    console.log('無法載入教師資料:', teacherDataResult.error);
                    return false;
                }
                
                const { teacherId, teacherInfo, teacherData: teacherUserData, teacherTrackingData, studentInfo } = teacherDataResult;
                
                // 載入學生自己的追蹤記錄
                const studentTrackingResult = await window.firebaseService.getTrackingData(studentId);
                
                // 檢查教師是否有資料
                if (!teacherUserData || !teacherUserData.cleaningTasks || !teacherUserData.assignments) {
                    console.log('❌ 教師沒有清掃資料');
                    console.log('teacherUserData:', teacherUserData);
                    userData = {
                        cleaningTasks: [],
                        assignments: {},
                        isStudentMode: true,
                        studentId: studentId,
                        studentInfo: studentInfo,
                        teacherId: teacherId,
                        teacherInfo: teacherInfo,
                        error: '教師尚未匯入清掃資料'
                    };
                    trackingData = {};
                    return false;
                }
                
                // 設置全域變數
                userData = teacherUserData; // 使用教師的 cleaningTasks 和 assignments
                trackingData = teacherTrackingData || {}; // 使用教師的追蹤資料，確保同步
                
                // 標記這是學生模式，並保存相關資訊
                userData.isStudentMode = true;
                userData.studentId = studentId;
                userData.studentData = studentInfo;  // 修正：使用 studentData 而非 studentInfo
                userData.teacherId = teacherId;
                userData.teacherInfo = teacherInfo;
                
                console.log('學生教師資料載入完成');
                console.log('教師:', teacherInfo?.name || teacherId);
                console.log('學生:', studentInfo?.name || studentId);
                console.log('打掃任務數量:', userData.cleaningTasks?.length || 0);
                console.log('分配數量:', Object.keys(userData.assignments || {}).length);
                
                return true;
                
            } catch (error) {
                console.error('載入學生教師資料錯誤:', error);
                return false;
            }
        }

        async function generateTrackingTable() {
            console.log('=== 開始生成追蹤表格 ===');
            console.log('當前使用者 UID:', currentUser?.uid);
            console.log('選擇的使用者:', selectedUser);
            console.log('使用者角色:', userRole);
            
            const dataLoaded = await loadUserData();
            console.log('資料載入結果:', dataLoaded);
            console.log('使用者資料:', userData);
            
            if (!dataLoaded || !userData) {
                console.log('❌ 資料載入失敗或資料為空');
                document.getElementById('trackingTable').innerHTML = `
                    <div class="no-data">
                        <p>📝 尚未匯入資料</p>
                        <button onclick="goToImport()" class="primary-btn">前往匯入資料</button>
                    </div>
                `;
                return;
            }
            
            // 顯示學生模式相關資訊
            if (userData.isStudentMode) {
                document.getElementById('studentModeBanner').style.display = 'block';
                console.log('🛡️ 衛生股長模式已啟用，可以標記缺點但不能解除');
                
                // 顯示資料來源資訊
                const dataSourceInfo = document.getElementById('dataSourceInfo');
                const teacherNameDisplay = document.getElementById('teacherNameDisplay');
                
                if (userData.teacherInfo?.name) {
                    teacherNameDisplay.textContent = `教師：${userData.teacherInfo.name}`;
                } else {
                    teacherNameDisplay.textContent = '教師資料';
                }
                
                dataSourceInfo.style.display = 'block';
            }
            
            // 檢查必要資料
            if (!userData.cleaningTasks || !userData.assignments) {
                console.log('❌ 缺少必要資料');
                console.log('cleaningTasks:', userData.cleaningTasks?.length);
                console.log('assignments:', Object.keys(userData.assignments || {}).length);
                console.log('isStudentMode:', userData.isStudentMode);
                console.log('userData:', userData);
                
                let errorMessage = '📝 資料不完整，請重新匯入';
                if (userData.isStudentMode && userData.error) {
                    errorMessage = `📝 ${userData.error}`;
                } else if (userData.isStudentMode) {
                    errorMessage = '📝 您的教師尚未匯入清掃資料，請聯絡教師先匯入資料';
                }
                
                document.getElementById('trackingTable').innerHTML = `
                    <div class="no-data">
                        <p>${errorMessage}</p>
                        ${userData.isStudentMode ? '' : '<button onclick="goToImport()" class="primary-btn">前往匯入資料</button>'}
                        ${userData.isStudentMode ? '<p><small>如有問題請聯絡您的教師</small></p>' : ''}
                    </div>
                `;
                return;
            }
            
            console.log('✅ 資料檢查通過');
            console.log('打掃事項數量:', userData.cleaningTasks.length);
            console.log('分配任務數量:', Object.keys(userData.assignments).length);

            const startOfWeek = new Date(currentWeek);
            startOfWeek.setDate(currentWeek.getDate() - currentWeek.getDay());
            
            let tableHTML = '<table class="tracking-table"><thead><tr><th class="task-header">打掃事項 / 負責人</th>';
            
            // 生成日期標題
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                tableHTML += `<th class="date-header">${dateStr}<br>(${weekdays[i]})</th>`;
            }
            tableHTML += '</tr></thead><tbody>';

            // 生成任務行
            console.log('開始生成任務行，總任務數:', userData.cleaningTasks.length);
            userData.cleaningTasks.forEach((task, taskIndex) => {
                const taskName = task['完整事項'] || task['事項'] || '未知事項';
                const assignedStudents = userData.assignments[taskIndex] || [];
                
                console.log(`任務 ${taskIndex}: ${taskName}, 分配學生數: ${assignedStudents.length}`);
                
                if (assignedStudents.length === 0) {
                    console.log(`跳過任務 ${taskIndex}，無分配學生`);
                    return;
                }

                // 衛生股長模式：顯示所有任務和所有負責的學生
                let filteredStudents = assignedStudents;
                if (userData.isStudentMode) {
                    // 衛生股長模式：顯示所有任務和所有學生，不做過濾
                    filteredStudents = assignedStudents;
                    console.log('🛡️ 衛生股長模式：顯示所有學生', filteredStudents);
                }

                filteredStudents.forEach(studentKey => {
                    // 將 uniqueKey 轉換回顯示格式
                    const parts = studentKey.split('_');
                    const displayName = parts.length >= 2 ? `${parts[0]} ${parts.slice(1).join('_')}` : studentKey;
                    
                    tableHTML += `<tr><td class="task-cell">
                        <div class="task-info">
                            <strong>${taskName}</strong>
                            <div class="student-name">${displayName}</div>
                        </div>
                    </td>`;
                    
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        const date = new Date(startOfWeek);
                        date.setDate(startOfWeek.getDate() + dayIndex);
                        const dateKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                        const cellKey = `${taskIndex}-${studentKey}-${dateKey}`;
                        
                        const currentStatus = trackingData[cellKey] || 'empty';
                        // 管理員可以編輯所有資料，一般使用者只能編輯自己的資料
                        const cellClass = userRole === 'admin' || selectedUser === currentUser?.uid ? 'clickable' : '';
                        
                        tableHTML += `<td class="tracking-cell ${cellClass}" data-key="${cellKey}" data-student="${studentKey}">`;
                        
                        if (currentStatus === 'merit') {
                            tableHTML += '🏅';
                        } else if (currentStatus === 'demerit') {
                            tableHTML += '😈';
                        }
                        
                        tableHTML += '</td>';
                    }
                    tableHTML += '</tr>';
                });
            });

            tableHTML += '</tbody></table>';
            document.getElementById('trackingTable').innerHTML = tableHTML;

            // 添加點擊事件
            // 管理員可以修改任何人的資料，一般使用者只能修改自己的
            console.log('綁定點擊事件，使用者角色:', userRole);
            console.log('選擇的使用者:', selectedUser);
            console.log('當前使用者 UID:', currentUser?.uid);
            
            // 管理員可以修改所有人的資料，教師可以修改學生資料，學生只能修改自己的資料
            let canEdit = false;
            if (userRole === 'admin') {
                canEdit = true; // 管理員可以編輯任何人
            } else if (userRole === 'teacher') {
                canEdit = selectedUser === currentUser?.uid || await isTeacherStudent(currentUser?.uid, selectedUser);
            } else if (userData.isStudentMode) {
                canEdit = true; // 學生可以編輯自己負責的任務（已在 trackingData 存儲中隔離）
            } else {
                canEdit = selectedUser === currentUser?.uid; // 一般用戶只能編輯自己的
            }
            
            if (canEdit) {
                const clickableCells = document.querySelectorAll('.tracking-cell.clickable');
                console.log('找到可點擊單元格數量:', clickableCells.length);
                
                clickableCells.forEach(cell => {
                    cell.addEventListener('click', handleCellClick);
                    cell.style.cursor = 'pointer'; // 顯示指針游標
                });
            } else {
                // 如果無權編輯，顯示提示
                const trackingTable = document.getElementById('trackingTable');
                if (trackingTable && !trackingTable.querySelector('.no-edit-notice')) {
                    const notice = document.createElement('div');
                    notice.className = 'no-edit-notice';
                    notice.innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <strong>📖 檢視模式</strong> - 您只能查看此資料，無法修改
                        </div>
                    `;
                    trackingTable.insertBefore(notice, trackingTable.firstChild);
                }
            }

            // 顯示統計資訊
            updateStatistics();
        }

        function handleCellClick(e) {
            console.log('單元格被點擊');
            
            const cell = e.target;
            const cellKey = cell.dataset.key;
            const studentKey = cell.dataset.student;
            
            console.log('點擊的單元格:', cellKey, '學生:', studentKey);
            
            let currentStatus = trackingData[cellKey] || 'empty';
            let newStatus;
            
            // 根據使用者角色決定編輯邏輯
            if (userData.isStudentMode) {
                // 學生（衛生股長）模式：只能新增缺點，不能解除
                switch (currentStatus) {
                    case 'empty':
                        newStatus = 'demerit';
                        cell.innerHTML = '😈';
                        console.log('衛生股長標記缺點');
                        break;
                    case 'merit':
                        // 已有優點，衛生股長可以覆蓋成缺點
                        newStatus = 'demerit';
                        cell.innerHTML = '😈';
                        console.log('衛生股長覆蓋優點為缺點');
                        break;
                    case 'demerit':
                        // 已有缺點，衛生股長不能解除
                        console.log('衛生股長無法解除缺點');
                        
                        // 給予視覺反饋
                        cell.style.animation = 'shake 0.5s';
                        setTimeout(() => {
                            cell.style.animation = '';
                        }, 500);
                        
                        // 顯示提示訊息
                        const tooltip = document.createElement('div');
                        tooltip.textContent = '只有老師能解除缺點';
                        tooltip.style.cssText = `
                            position: absolute;
                            background: #dc3545;
                            color: white;
                            padding: 5px 10px;
                            border-radius: 4px;
                            font-size: 12px;
                            z-index: 1000;
                            pointer-events: none;
                        `;
                        
                        const rect = cell.getBoundingClientRect();
                        tooltip.style.left = rect.left + 'px';
                        tooltip.style.top = (rect.top - 30) + 'px';
                        
                        document.body.appendChild(tooltip);
                        setTimeout(() => {
                            document.body.removeChild(tooltip);
                        }, 2000);
                        
                        return; // 不做任何改變
                }
            } else {
                // 教師/管理員模式：完整循環 空白 → 🏅 → 😈 → 空白
                switch (currentStatus) {
                    case 'empty':
                        newStatus = 'merit';
                        cell.innerHTML = '🏅';
                        break;
                    case 'merit':
                        newStatus = 'demerit';
                        cell.innerHTML = '😈';
                        break;
                    case 'demerit':
                        newStatus = 'empty';
                        cell.innerHTML = '';
                        break;
                }
            }
            
            trackingData[cellKey] = newStatus;
            console.log('更新狀態:', cellKey, '→', newStatus);
            
            saveTrackingData();
            
            // 檢查缺失警告
            checkDemeritWarning(studentKey);
            updateStatistics();
        }

        function checkDemeritWarning(studentKey) {
            const weekKey = getWeekKey(currentWeek);
            let demeritCount = 0;
            
            Object.keys(trackingData).forEach(key => {
                if (key.includes(studentKey) && trackingData[key] === 'demerit') {
                    demeritCount++;
                }
            });
            
            if (demeritCount >= 3) {
                // 添加警告標記
                document.querySelectorAll(`[data-student="${studentKey}"]`).forEach(cell => {
                    cell.classList.add('warning-student');
                });
                
                if (demeritCount === 3) {
                    // 轉換為顯示格式
                    const parts = studentKey.split('_');
                    const displayName = parts.length >= 2 ? `${parts[0]} ${parts.slice(1).join('_')}` : studentKey;
                    alert(`⚠️ 警告：${displayName} 已累積三次缺失！`);
                }
            } else {
                // 移除警告標記
                document.querySelectorAll(`[data-student="${studentKey}"]`).forEach(cell => {
                    cell.classList.remove('warning-student');
                });
            }
        }

        function updateStatistics() {
            const stats = {};
            const students = new Set();
            
            Object.keys(trackingData).forEach(key => {
                const [taskIndex, studentName, date] = key.split('-').slice(0, 3);
                const status = trackingData[key];
                
                if (!stats[studentName]) {
                    stats[studentName] = { merit: 0, demerit: 0 };
                }
                
                if (status === 'merit') {
                    stats[studentName].merit++;
                } else if (status === 'demerit') {
                    stats[studentName].demerit++;
                }
                
                students.add(studentName);
            });
            
            let statsHTML = '<div class="stats-grid">';
            Array.from(students).forEach(student => {
                const studentStats = stats[student] || { merit: 0, demerit: 0 };
                const warningClass = studentStats.demerit >= 3 ? 'warning' : '';
                
                statsHTML += `
                    <div class="student-stats ${warningClass}">
                        <h4>${student}</h4>
                        <div class="stat-item">🏅 ${studentStats.merit}</div>
                        <div class="stat-item">😈 ${studentStats.demerit}</div>
                        ${studentStats.demerit >= 3 ? '<div class="warning-text">⚠️ 需要關注</div>' : ''}
                    </div>
                `;
            });
            statsHTML += '</div>';
            
            document.getElementById('statsContent').innerHTML = statsHTML;
            document.getElementById('statisticsPanel').style.display = 'block';
        }

        async function saveTrackingData() {
            let targetUserId = selectedUser || currentUser?.uid;
            
            // 如果是學生模式，追蹤資料要存到教師的 ID 下以保持同步
            if (userData.isStudentMode && userData.teacherId) {
                targetUserId = userData.teacherId;
            }
            
            if (!targetUserId) return;
            
            try {
                await window.firebaseService.saveTrackingData(targetUserId, trackingData);
                console.log('追蹤資料已儲存到:', targetUserId);
            } catch (error) {
                console.error('儲存追蹤資料錯誤:', error);
            }
        }

        // 初始化將在 loadUserInfo 中執行
    </script>
</body>
</html>