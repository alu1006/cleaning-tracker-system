<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“æƒè¿½è¹¤ç³»çµ± - è¿½è¹¤é é¢</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>ğŸ§¹ æ‰“æƒè¿½è¹¤ç³»çµ±</h1>
            <div class="nav-user">
                <span id="userInfo"></span>
                <button onclick="goToImport()" class="secondary-btn">ğŸ“‹ ä¿®æ”¹åˆ†é…</button>
                <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="tracking-header">
            <h2>ğŸ“Š æ‰“æƒè¿½è¹¤è¡¨</h2>
            <div class="controls">
                <button id="prevWeek" class="control-btn">â—€ ä¸Šé€±</button>
                <span id="currentWeek" class="week-display"></span>
                <button id="nextWeek" class="control-btn">ä¸‹é€± â–¶</button>
            </div>
            <div class="legend">
                <span class="legend-item">ğŸ… å„ªé»</span>
                <span class="legend-item">ğŸ˜ˆ ç¼ºå¤±</span>
                <span class="legend-item warning">âš ï¸ ä¸‰æ¬¡ç¼ºå¤±è­¦å‘Š</span>
            </div>
        </div>

        <div class="user-selector" id="userSelector" style="display: none;">
            <label for="selectedUser">é¸æ“‡ä½¿ç”¨è€…ï¼š</label>
            <select id="selectedUser">
                <option value="user1">ä½¿ç”¨è€…1</option>
                <option value="user2">ä½¿ç”¨è€…2</option>
            </select>
        </div>

        <div id="trackingTable" class="tracking-table-container">
            <div class="no-data">
                <p>ğŸ“ å°šæœªåŒ¯å…¥è³‡æ–™</p>
                <button onclick="goToImport()" class="primary-btn">å‰å¾€åŒ¯å…¥è³‡æ–™</button>
            </div>
        </div>

        <div class="statistics" id="statisticsPanel" style="display: none;">
            <h3>ğŸ“ˆ çµ±è¨ˆè³‡è¨Š</h3>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple.js"></script>
    
    <script>
        let currentUser = null;
        let userRole = null;
        let userName = null;
        let allUsers = {}; // ç®¡ç†å“¡ç”¨ï¼šå„²å­˜æ‰€æœ‰ä½¿ç”¨è€…è³‡è¨Š
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserInfo();
            } else {
                window.location.href = 'login.html';
            }
        });
        
        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUserInfo() {
            if (!currentUser) return;
            
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                userName = userData?.name || currentUser.email;
                userRole = userData?.role || 'user';
                
                document.getElementById('userInfo').textContent = `${userName} (${userRole === 'admin' ? 'ç®¡ç†å“¡' : 'ä½¿ç”¨è€…'})`;
                
                // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œè¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…
                if (userRole === 'admin') {
                    await loadAllUsers();
                }
                
                // åˆå§‹åŒ–é é¢
                await initializePage();
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:', error);
            }
        }
        
        // è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…ï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰
        async function loadAllUsers() {
            try {
                const result = await window.firebaseService.getAllUsers();
                if (result.success) {
                    result.users.forEach(user => {
                        allUsers[user.id] = user;
                    });
                    
                    // æ›´æ–°ä½¿ç”¨è€…é¸æ“‡å™¨
                    updateUserSelector();
                }
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…æ¸…å–®éŒ¯èª¤:', error);
            }
        }
        
        // æ›´æ–°ä½¿ç”¨è€…é¸æ“‡å™¨
        function updateUserSelector() {
            if (userRole !== 'admin') return;
            
            const selector = document.getElementById('selectedUser');
            selector.innerHTML = '';
            
            Object.entries(allUsers).forEach(([userId, user]) => {
                if (user.role !== 'admin') { // ä¸é¡¯ç¤ºç®¡ç†å“¡å¸³è™Ÿ
                    const option = document.createElement('option');
                    option.value = userId;
                    option.textContent = user.name || user.email;
                    selector.appendChild(option);
                }
            });
            
            // é è¨­é¸æ“‡ç¬¬ä¸€å€‹ä½¿ç”¨è€…
            if (selector.options.length > 0) {
                selectedUser = selector.options[0].value;
            }
        }

        // åˆå§‹åŒ–é é¢
        async function initializePage() {
            // è¨­å®šé è¨­é¸æ“‡çš„ä½¿ç”¨è€…
            selectedUser = currentUser?.uid;
            
            // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºä½¿ç”¨è€…é¸æ“‡å™¨
            if (userRole === 'admin') {
                document.getElementById('userSelector').style.display = 'block';
                await loadAllUsers();
                // ç®¡ç†å“¡é è¨­é¸æ“‡ç¬¬ä¸€å€‹ä¸€èˆ¬ä½¿ç”¨è€…
                const selector = document.getElementById('selectedUser');
                if (selector.options.length > 0) {
                    selectedUser = selector.options[0].value;
                }
            }
            
            console.log('åˆå§‹åŒ–é é¢ï¼Œé¸æ“‡çš„ä½¿ç”¨è€…:', selectedUser);
            
            // åˆå§‹åŒ–é€±æ¬¡é¡¯ç¤ºå’Œè¡¨æ ¼
            updateWeekDisplay();
            await generateTrackingTable();
        }

        let currentWeek = new Date();
        let selectedUser = null; // å°‡åœ¨ä½¿ç”¨è€…ç™»å…¥å¾Œè¨­å®š
        let userData = null;
        let trackingData = {};

        // é€±æ¬¡å°èˆª
        document.getElementById('prevWeek').addEventListener('click', async () => {
            currentWeek.setDate(currentWeek.getDate() - 7);
            updateWeekDisplay();
            await generateTrackingTable();
        });

        document.getElementById('nextWeek').addEventListener('click', async () => {
            currentWeek.setDate(currentWeek.getDate() + 7);
            updateWeekDisplay();
            await generateTrackingTable();
        });

        // ä½¿ç”¨è€…é¸æ“‡ï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰
        document.getElementById('selectedUser')?.addEventListener('change', async (e) => {
            selectedUser = e.target.value;
            console.log('ä½¿ç”¨è€…é¸æ“‡è®Šæ›´ç‚º:', selectedUser);
            await generateTrackingTable();
        });

        async function logout() {
            try {
                await window.firebaseService.signOut();
                sessionStorage.clear();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function goToImport() {
            window.location.href = 'import.html';
        }

        function getWeekKey(date) {
            const year = date.getFullYear();
            const weekNum = getWeekNumber(date);
            return `${year}-W${weekNum}`;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function updateWeekDisplay() {
            const startOfWeek = new Date(currentWeek);
            startOfWeek.setDate(currentWeek.getDate() - currentWeek.getDay());
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const formatDate = (date) => `${date.getMonth() + 1}/${date.getDate()}`;
            
            document.getElementById('currentWeek').textContent = 
                `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
        }

        async function loadUserData() {
            const targetUserId = selectedUser || currentUser?.uid;
            if (!targetUserId) return false;
            
            try {
                const [userDataResult, trackingResult] = await Promise.all([
                    window.firebaseService.getUserData(targetUserId),
                    window.firebaseService.getTrackingData(targetUserId)
                ]);
                
                if (userDataResult.success && userDataResult.data) {
                    userData = userDataResult.data;
                    
                    if (trackingResult.success) {
                        trackingData = trackingResult.data || {};
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™éŒ¯èª¤:', error);
            }
            return false;
        }

        async function generateTrackingTable() {
            console.log('=== é–‹å§‹ç”Ÿæˆè¿½è¹¤è¡¨æ ¼ ===');
            console.log('ç•¶å‰ä½¿ç”¨è€… UID:', currentUser?.uid);
            console.log('é¸æ“‡çš„ä½¿ç”¨è€…:', selectedUser);
            console.log('ä½¿ç”¨è€…è§’è‰²:', userRole);
            
            const dataLoaded = await loadUserData();
            console.log('è³‡æ–™è¼‰å…¥çµæœ:', dataLoaded);
            console.log('ä½¿ç”¨è€…è³‡æ–™:', userData);
            
            if (!dataLoaded || !userData) {
                console.log('âŒ è³‡æ–™è¼‰å…¥å¤±æ•—æˆ–è³‡æ–™ç‚ºç©º');
                document.getElementById('trackingTable').innerHTML = `
                    <div class="no-data">
                        <p>ğŸ“ å°šæœªåŒ¯å…¥è³‡æ–™</p>
                        <button onclick="goToImport()" class="primary-btn">å‰å¾€åŒ¯å…¥è³‡æ–™</button>
                    </div>
                `;
                return;
            }
            
            // æª¢æŸ¥å¿…è¦è³‡æ–™
            if (!userData.cleaningTasks || !userData.assignments) {
                console.log('âŒ ç¼ºå°‘å¿…è¦è³‡æ–™');
                console.log('cleaningTasks:', userData.cleaningTasks?.length);
                console.log('assignments:', Object.keys(userData.assignments || {}).length);
                document.getElementById('trackingTable').innerHTML = `
                    <div class="no-data">
                        <p>ğŸ“ è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹é‡æ–°åŒ¯å…¥</p>
                        <button onclick="goToImport()" class="primary-btn">å‰å¾€åŒ¯å…¥è³‡æ–™</button>
                    </div>
                `;
                return;
            }
            
            console.log('âœ… è³‡æ–™æª¢æŸ¥é€šé');
            console.log('æ‰“æƒäº‹é …æ•¸é‡:', userData.cleaningTasks.length);
            console.log('åˆ†é…ä»»å‹™æ•¸é‡:', Object.keys(userData.assignments).length);

            const startOfWeek = new Date(currentWeek);
            startOfWeek.setDate(currentWeek.getDate() - currentWeek.getDay());
            
            let tableHTML = '<table class="tracking-table"><thead><tr><th class="task-header">æ‰“æƒäº‹é … / è² è²¬äºº</th>';
            
            // ç”Ÿæˆæ—¥æœŸæ¨™é¡Œ
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                tableHTML += `<th class="date-header">${dateStr}<br>(${weekdays[i]})</th>`;
            }
            tableHTML += '</tr></thead><tbody>';

            // ç”Ÿæˆä»»å‹™è¡Œ
            userData.cleaningTasks.forEach((task, taskIndex) => {
                const taskName = task['å®Œæ•´äº‹é …'] || task['äº‹é …'] || 'æœªçŸ¥äº‹é …';
                const assignedStudents = userData.assignments[taskIndex] || [];
                
                if (assignedStudents.length === 0) return;

                assignedStudents.forEach(studentKey => {
                    // å°‡ uniqueKey è½‰æ›å›é¡¯ç¤ºæ ¼å¼
                    const parts = studentKey.split('_');
                    const displayName = parts.length >= 2 ? `${parts[0]} ${parts.slice(1).join('_')}` : studentKey;
                    
                    tableHTML += `<tr><td class="task-cell">
                        <div class="task-info">
                            <strong>${taskName}</strong>
                            <div class="student-name">${displayName}</div>
                        </div>
                    </td>`;
                    
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        const date = new Date(startOfWeek);
                        date.setDate(startOfWeek.getDate() + dayIndex);
                        const dateKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                        const cellKey = `${taskIndex}-${studentKey}-${dateKey}`;
                        
                        const currentStatus = trackingData[cellKey] || 'empty';
                        const cellClass = userRole === 'admin' || selectedUser === currentUser?.uid ? 'clickable' : '';
                        
                        tableHTML += `<td class="tracking-cell ${cellClass}" data-key="${cellKey}" data-student="${studentKey}">`;
                        
                        if (currentStatus === 'merit') {
                            tableHTML += 'ğŸ…';
                        } else if (currentStatus === 'demerit') {
                            tableHTML += 'ğŸ˜ˆ';
                        }
                        
                        tableHTML += '</td>';
                    }
                    tableHTML += '</tr>';
                });
            });

            tableHTML += '</tbody></table>';
            document.getElementById('trackingTable').innerHTML = tableHTML;

            // æ·»åŠ é»æ“Šäº‹ä»¶
            // ç‚ºæ‰€æœ‰å¯é»æ“Šçš„å–®å…ƒæ ¼æ·»åŠ äº‹ä»¶ç›£è½å™¨
            console.log('ç¶å®šé»æ“Šäº‹ä»¶ï¼Œä½¿ç”¨è€…è§’è‰²:', userRole);
            console.log('é¸æ“‡çš„ä½¿ç”¨è€…:', selectedUser);
            console.log('ç•¶å‰ä½¿ç”¨è€… UID:', currentUser?.uid);
            
            if (userRole === 'admin' || selectedUser === currentUser?.uid) {
                const clickableCells = document.querySelectorAll('.tracking-cell.clickable');
                console.log('æ‰¾åˆ°å¯é»æ“Šå–®å…ƒæ ¼æ•¸é‡:', clickableCells.length);
                
                clickableCells.forEach(cell => {
                    cell.addEventListener('click', handleCellClick);
                    cell.style.cursor = 'pointer'; // é¡¯ç¤ºæŒ‡é‡æ¸¸æ¨™
                });
            }

            // é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
            updateStatistics();
        }

        function handleCellClick(e) {
            console.log('å–®å…ƒæ ¼è¢«é»æ“Š');
            
            const cell = e.target;
            const cellKey = cell.dataset.key;
            const studentKey = cell.dataset.student;
            
            console.log('é»æ“Šçš„å–®å…ƒæ ¼:', cellKey, 'å­¸ç”Ÿ:', studentKey);
            
            let currentStatus = trackingData[cellKey] || 'empty';
            let newStatus;
            
            // ç‹€æ…‹å¾ªç’°ï¼šç©ºç™½ â†’ ğŸ… â†’ ğŸ˜ˆ â†’ ç©ºç™½
            switch (currentStatus) {
                case 'empty':
                    newStatus = 'merit';
                    cell.innerHTML = 'ğŸ…';
                    break;
                case 'merit':
                    newStatus = 'demerit';
                    cell.innerHTML = 'ğŸ˜ˆ';
                    break;
                case 'demerit':
                    newStatus = 'empty';
                    cell.innerHTML = '';
                    break;
            }
            
            trackingData[cellKey] = newStatus;
            console.log('æ›´æ–°ç‹€æ…‹:', cellKey, 'â†’', newStatus);
            
            saveTrackingData();
            
            // æª¢æŸ¥ç¼ºå¤±è­¦å‘Š
            checkDemeritWarning(studentKey);
            updateStatistics();
        }

        function checkDemeritWarning(studentKey) {
            const weekKey = getWeekKey(currentWeek);
            let demeritCount = 0;
            
            Object.keys(trackingData).forEach(key => {
                if (key.includes(studentKey) && trackingData[key] === 'demerit') {
                    demeritCount++;
                }
            });
            
            if (demeritCount >= 3) {
                // æ·»åŠ è­¦å‘Šæ¨™è¨˜
                document.querySelectorAll(`[data-student="${studentKey}"]`).forEach(cell => {
                    cell.classList.add('warning-student');
                });
                
                if (demeritCount === 3) {
                    // è½‰æ›ç‚ºé¡¯ç¤ºæ ¼å¼
                    const parts = studentKey.split('_');
                    const displayName = parts.length >= 2 ? `${parts[0]} ${parts.slice(1).join('_')}` : studentKey;
                    alert(`âš ï¸ è­¦å‘Šï¼š${displayName} å·²ç´¯ç©ä¸‰æ¬¡ç¼ºå¤±ï¼`);
                }
            } else {
                // ç§»é™¤è­¦å‘Šæ¨™è¨˜
                document.querySelectorAll(`[data-student="${studentKey}"]`).forEach(cell => {
                    cell.classList.remove('warning-student');
                });
            }
        }

        function updateStatistics() {
            const stats = {};
            const students = new Set();
            
            Object.keys(trackingData).forEach(key => {
                const [taskIndex, studentName, date] = key.split('-').slice(0, 3);
                const status = trackingData[key];
                
                if (!stats[studentName]) {
                    stats[studentName] = { merit: 0, demerit: 0 };
                }
                
                if (status === 'merit') {
                    stats[studentName].merit++;
                } else if (status === 'demerit') {
                    stats[studentName].demerit++;
                }
                
                students.add(studentName);
            });
            
            let statsHTML = '<div class="stats-grid">';
            Array.from(students).forEach(student => {
                const studentStats = stats[student] || { merit: 0, demerit: 0 };
                const warningClass = studentStats.demerit >= 3 ? 'warning' : '';
                
                statsHTML += `
                    <div class="student-stats ${warningClass}">
                        <h4>${student}</h4>
                        <div class="stat-item">ğŸ… ${studentStats.merit}</div>
                        <div class="stat-item">ğŸ˜ˆ ${studentStats.demerit}</div>
                        ${studentStats.demerit >= 3 ? '<div class="warning-text">âš ï¸ éœ€è¦é—œæ³¨</div>' : ''}
                    </div>
                `;
            });
            statsHTML += '</div>';
            
            document.getElementById('statsContent').innerHTML = statsHTML;
            document.getElementById('statisticsPanel').style.display = 'block';
        }

        async function saveTrackingData() {
            const targetUserId = selectedUser || currentUser?.uid;
            if (!targetUserId) return;
            
            try {
                await window.firebaseService.saveTrackingData(targetUserId, trackingData);
            } catch (error) {
                console.error('å„²å­˜è¿½è¹¤è³‡æ–™éŒ¯èª¤:', error);
            }
        }

        // åˆå§‹åŒ–å°‡åœ¨ loadUserInfo ä¸­åŸ·è¡Œ
    </script>
</body>
</html>