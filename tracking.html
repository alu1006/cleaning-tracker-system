<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“æƒè¿½è¹¤ç³»çµ± - è¿½è¹¤é é¢</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>ğŸ§¹ æ‰“æƒè¿½è¹¤ç³»çµ±</h1>
            <div class="nav-user">
                <span id="userInfo"></span>
                <button onclick="goToImport()" class="secondary-btn">ğŸ“‹ ä¿®æ”¹åˆ†é…</button>
                <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="tracking-header">
            <h2>ğŸ“Š æ‰“æƒè¿½è¹¤è¡¨</h2>
            <div id="dataSourceInfo" class="data-source-info" style="display: none;">
                <div class="source-badge">
                    <span class="source-icon">ğŸ“</span>
                    <div class="source-text">
                        <strong>æŸ¥çœ‹æ•™å¸«è³‡æ–™</strong>
                        <small id="teacherNameDisplay"></small>
                    </div>
                </div>
            </div>
            <div class="controls">
                <button id="prevWeek" class="control-btn">â—€ ä¸Šé€±</button>
                <span id="currentWeek" class="week-display"></span>
                <button id="nextWeek" class="control-btn">ä¸‹é€± â–¶</button>
            </div>
            <div class="legend">
                <span class="legend-item">ğŸ… å„ªé»</span>
                <span class="legend-item">ğŸ˜ˆ ç¼ºå¤±</span>
                <span class="legend-item warning">âš ï¸ ä¸‰æ¬¡ç¼ºå¤±è­¦å‘Š</span>
            </div>
        </div>

        <div class="user-selector" id="userSelector" style="display: none;">
            <label for="selectedUser">é¸æ“‡è¦æŸ¥çœ‹çš„ä½¿ç”¨è€…ï¼š</label>
            <select id="selectedUser">
                <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            <div class="user-info-display" id="selectedUserInfo"></div>
        </div>
        
        <div class="student-mode-banner" id="studentModeBanner" style="display: none;">
            <div class="banner-content">
                <span class="banner-icon">ğŸ›¡ï¸</span>
                <div class="banner-text">
                    <strong>è¡›ç”Ÿè‚¡é•·æ¨¡å¼</strong> - å”åŠ©è€å¸«æª¢æŸ¥æ‰“æƒç‹€æ³
                    <br><small>ä½ å¯ä»¥æ¨™è¨˜ç¼ºé» ğŸ˜ˆï¼Œä½†åªæœ‰è€å¸«èƒ½è§£é™¤ç¼ºé»æˆ–çµ¦äºˆå„ªé» ğŸ…</small>
                </div>
            </div>
        </div>

        <div id="trackingTable" class="tracking-table-container">
            <div class="no-data">
                <p>ğŸ“ å°šæœªåŒ¯å…¥è³‡æ–™</p>
                <button onclick="goToImport()" class="primary-btn">å‰å¾€åŒ¯å…¥è³‡æ–™</button>
            </div>
        </div>

        <div class="statistics" id="statisticsPanel" style="display: none;">
            <h3>ğŸ“ˆ çµ±è¨ˆè³‡è¨Š</h3>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple-public.js"></script>
    
    <script>
        let currentUser = null;
        let userRole = null;
        let userName = null;
        let allUsers = {}; // ç®¡ç†å“¡ç”¨ï¼šå„²å­˜æ‰€æœ‰ä½¿ç”¨è€…è³‡è¨Š
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserInfo();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUserInfo() {
            if (!currentUser) return;
            
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                userName = userData?.name || currentUser.displayName || currentUser.email;
                userRole = userData?.role || 'user';
                
                // æ›´æ–°ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤ºï¼ŒåŒ…å«é ­åƒï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                const userInfoElement = document.getElementById('userInfo');
                const photoURL = currentUser.photoURL || userData?.photoURL;
                
                if (photoURL) {
                    userInfoElement.innerHTML = `
                        <img src="${photoURL}" alt="User Avatar" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                        ${userName} (${userRole === 'teacher' ? 'æ•™å¸«' : 'å­¸ç”Ÿ'})
                    `;
                } else {
                    userInfoElement.textContent = `${userName} (${userRole === 'teacher' ? 'æ•™å¸«' : 'å­¸ç”Ÿ'})`;
                }
                
                // æ ¹æ“šè§’è‰²æ·»åŠ å°æ‡‰æŒ‰éˆ•
                const navUser = document.querySelector('.nav-user');
                const importBtn = navUser.querySelector('button');
                
                if (userRole === 'teacher') {
                    // æ•™å¸«ï¼šæ·»åŠ å­¸ç”Ÿç®¡ç†æŒ‰éˆ•ä¸¦è¼‰å…¥å­¸ç”Ÿè³‡æ–™
                    const studentMgmtBtn = document.createElement('button');
                    studentMgmtBtn.textContent = 'ğŸ‘¥ å­¸ç”Ÿç®¡ç†';
                    studentMgmtBtn.className = 'secondary-btn';
                    studentMgmtBtn.onclick = () => window.location.href = 'student-management.html';
                    navUser.insertBefore(studentMgmtBtn, importBtn);
                    
                    // æ•™å¸«æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨è‡ªå·±çš„è³‡æ–™ï¼Œä¸éœ€è¦è¼‰å…¥å…¶ä»–ä½¿ç”¨è€…
                }
                
                // åˆå§‹åŒ–é é¢
                await initializePage();
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:', error);
            }
        }
        
        // è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…ï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰
        async function loadAllUsers() {
            try {
                const result = await window.firebaseService.getAllUsers();
                if (result.success) {
                    result.users.forEach(user => {
                        allUsers[user.id] = user;
                    });
                    
                    // æ›´æ–°ä½¿ç”¨è€…é¸æ“‡å™¨
                    updateUserSelector();
                }
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…æ¸…å–®éŒ¯èª¤:', error);
            }
        }
        
        // è¼‰å…¥æ•™å¸«çš„å­¸ç”Ÿï¼ˆæ•™å¸«åŠŸèƒ½ï¼‰
        async function loadTeacherStudents() {
            try {
                // è¼‰å…¥å±¬æ–¼æ­¤æ•™å¸«çš„å­¸ç”Ÿ
                const studentsQuery = window.firebaseService.db.collection('students')
                    .where('teacherId', '==', currentUser.uid)
                    .where('status', '==', 'active');
                
                const studentsSnapshot = await studentsQuery.get();
                
                // æ¸…ç©º allUsersï¼ŒåªåŒ…å«é€™å€‹æ•™å¸«çš„å­¸ç”Ÿ
                allUsers = {};
                
                // è¼‰å…¥æ¯å€‹å­¸ç”Ÿçš„å®Œæ•´ä½¿ç”¨è€…è³‡æ–™
                const promises = [];
                studentsSnapshot.forEach(doc => {
                    const student = { id: doc.id, ...doc.data() };
                    promises.push(
                        window.firebaseService.db.collection('users').doc(student.id).get()
                        .then(userDoc => {
                            if (userDoc.exists) {
                                allUsers[student.id] = { 
                                    ...userDoc.data(), 
                                    id: student.id,
                                    studentNumber: student.studentNumber 
                                };
                            }
                        })
                    );
                });
                
                await Promise.all(promises);
                console.log('è¼‰å…¥æ•™å¸«å­¸ç”Ÿæ•¸é‡:', Object.keys(allUsers).length);
                
                // æ›´æ–°ä½¿ç”¨è€…é¸æ“‡å™¨
                updateUserSelector();
            } catch (error) {
                console.error('è¼‰å…¥æ•™å¸«å­¸ç”ŸéŒ¯èª¤:', error);
            }
        }
        
        // æ›´æ–°ä½¿ç”¨è€…é¸æ“‡å™¨
        function updateUserSelector() {
            if (userRole !== 'teacher') return;
            
            const selector = document.getElementById('selectedUser');
            selector.innerHTML = '';
            
            // æ·»åŠ æ‰€æœ‰ä½¿ç”¨è€…
            Object.entries(allUsers).forEach(([userId, user]) => {
                const option = document.createElement('option');
                option.value = userId;
                
                let roleText = '';
                if (user.role === 'teacher') roleText = ' (æ•™å¸«)';
                else if (user.role === 'student') roleText = ' (å­¸ç”Ÿ)';
                else roleText = ' (ä½¿ç”¨è€…)';
                
                // é¡¯ç¤ºå­¸è™Ÿï¼ˆå¦‚æœæœ‰ï¼‰
                const studentNumber = user.studentNumber ? ` ${user.studentNumber}` : '';
                option.textContent = `${user.name || user.email}${studentNumber}${roleText}`;
                selector.appendChild(option);
            });
            
            // é è¨­é¸æ“‡ç¬¬ä¸€å€‹ä½¿ç”¨è€…
            let defaultUserId = null;
            for (const [userId, user] of Object.entries(allUsers)) {
                if (userRole === 'admin' && user.role !== 'admin') { 
                    // ç®¡ç†å“¡å„ªå…ˆé¸æ“‡éç®¡ç†å“¡ä½¿ç”¨è€…
                    defaultUserId = userId;
                    break;
                } else if (userRole === 'teacher') { 
                    // æ•™å¸«é¸æ“‡ç¬¬ä¸€å€‹å­¸ç”Ÿ
                    defaultUserId = userId;
                    break;
                }
            }
            
            if (!defaultUserId && selector.options.length > 0) {
                defaultUserId = selector.options[0].value;
            }
            
            if (defaultUserId) {
                selector.value = defaultUserId;
                selectedUser = defaultUserId;
                updateSelectedUserInfo();
            }
        }

        // æ›´æ–°é¸ä¸­ä½¿ç”¨è€…çš„è³‡è¨Šé¡¯ç¤º
        function updateSelectedUserInfo() {
            const infoDiv = document.getElementById('selectedUserInfo');
            if (!selectedUser || !allUsers[selectedUser]) {
                infoDiv.innerHTML = '';
                return;
            }
            
            const user = allUsers[selectedUser];
            const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';
            const roleName = user.role === 'admin' ? 'ç®¡ç†å“¡' : 'ä½¿ç”¨è€…';
            
            infoDiv.innerHTML = `
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #007bff;">
                    <strong>ğŸ“Š æ­£åœ¨æŸ¥çœ‹ï¼š</strong>
                    <span style="margin-left: 10px;">${user.name || user.email}</span>
                    <span class="${roleClass}" style="margin-left: 10px;">${roleName}</span>
                    <br><small style="color: #666; margin-top: 5px;">Email: ${user.email}</small>
                </div>
            `;
        }

        // å³æ™‚ç›£è½å™¨è®Šæ•¸
        let unsubscribeTeacherData = null;
        let unsubscribeTrackingData = null;
        
        // åˆå§‹åŒ–é é¢
        async function initializePage() {
            // æª¢æŸ¥æ˜¯å¦ç‚ºå­¸ç”Ÿæ¨¡å¼
            const isStudentMode = sessionStorage.getItem('isStudentMode') === 'true';
            
            console.log('ğŸ”„ åˆå§‹åŒ–é é¢:', {
                userRole,
                isStudentMode,
                currentUserUid: currentUser?.uid
            });
            
            if (userRole === 'student' && isStudentMode) {
                // å­¸ç”Ÿæ¨¡å¼ï¼šéš±è—ç”¨æˆ¶é¸æ“‡å™¨å’Œä¿®æ”¹åˆ†é…æŒ‰éˆ•
                console.log('ğŸ“ å­¸ç”Ÿæ¨¡å¼ï¼šéš±è—ç”¨æˆ¶é¸æ“‡å™¨å’Œä¿®æ”¹åˆ†é…æŒ‰éˆ•');
                document.getElementById('userSelector').style.display = 'none';
                // éš±è—ä¿®æ”¹åˆ†é…æŒ‰éˆ•
                const importButtons = document.querySelectorAll('button[onclick="goToImport()"]');
                importButtons.forEach(btn => btn.style.display = 'none');
                selectedUser = currentUser?.uid;
                
                // é¡¯ç¤ºå­¸ç”Ÿæ¨¡å¼æç¤º
                const userSelectorDiv = document.getElementById('userSelector');
                const studentNotice = document.createElement('div');
                studentNotice.className = 'student-notice';
                studentNotice.innerHTML = `
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #2196f3;">
                        <strong>ğŸ“ å­¸ç”Ÿæ¨¡å¼</strong><br>
                        <small>é¡¯ç¤ºæ‚¨çš„å€‹äººæ‰“æƒä»»å‹™å’Œè¨˜éŒ„</small>
                    </div>
                `;
                userSelectorDiv.parentNode.insertBefore(studentNotice, userSelectorDiv);
                
            } else if (userRole === 'admin') {
                // ç®¡ç†å“¡ï¼šé¡¯ç¤ºç”¨æˆ¶é¸æ“‡å™¨
                console.log('ğŸ‘¨â€ğŸ’¼ ç®¡ç†å“¡æ¨¡å¼ï¼šé¡¯ç¤ºç”¨æˆ¶é¸æ“‡å™¨');
                document.getElementById('userSelector').style.display = 'block';
                selectedUser = currentUser?.uid;
                updateUserSelector();
            } else if (userRole === 'teacher') {
                // æ•™å¸«ï¼šåªæŸ¥çœ‹è‡ªå·±çš„è³‡æ–™ï¼Œä¸é¡¯ç¤ºç”¨æˆ¶é¸æ“‡å™¨
                console.log('ğŸ‘¨â€ğŸ« æ•™å¸«æ¨¡å¼ï¼šæŸ¥çœ‹è‡ªå·±çš„åŒ¯å…¥è³‡æ–™');
                document.getElementById('userSelector').style.display = 'none';
                selectedUser = currentUser?.uid;
            } else {
                // å…¶ä»–æƒ…æ³ï¼šè¨­å®šé è¨­é¸æ“‡çš„ä½¿ç”¨è€…
                selectedUser = currentUser?.uid;
            }
            
            console.log('åˆå§‹åŒ–é é¢ï¼Œé¸æ“‡çš„ä½¿ç”¨è€…:', selectedUser);
            
            // åˆå§‹åŒ–é€±æ¬¡é¡¯ç¤ºå’Œè¡¨æ ¼
            updateWeekDisplay();
            await generateTrackingTable();
            
            // è¨­å®šå³æ™‚ç›£è½å™¨
            setupRealtimeListeners();
        }
        
        // è¨­å®šå³æ™‚ç›£è½å™¨
        function setupRealtimeListeners() {
            // æ¸…ç†èˆŠçš„ç›£è½å™¨
            if (unsubscribeTeacherData) {
                unsubscribeTeacherData();
                unsubscribeTeacherData = null;
            }
            if (unsubscribeTrackingData) {
                unsubscribeTrackingData();
                unsubscribeTrackingData = null;
            }
            
            if (!currentUser) return;
            
            const isStudentMode = sessionStorage.getItem('isStudentMode') === 'true';
            
            if (userRole === 'student' && isStudentMode) {
                // å­¸ç”Ÿæ¨¡å¼ï¼šç›£è½æ•™å¸«è³‡æ–™è®ŠåŒ–
                console.log('ğŸ”” è¨­å®šå­¸ç”Ÿæ¨¡å¼å³æ™‚ç›£è½å™¨');
                
                window.firebaseService.onTeacherDataChanged(currentUser.uid, (update) => {
                    console.log('ğŸ“¡ æ”¶åˆ°æ•™å¸«è³‡æ–™æ›´æ–°:', update.type);
                    
                    if (update.type === 'userData' && update.data) {
                        // æ›´æ–°æœ¬åœ°çš„ userData
                        const oldTaskCount = userData?.cleaningTasks?.length || 0;
                        const newTaskCount = update.data.cleaningTasks?.length || 0;
                        
                        userData = {
                            ...update.data,
                            isStudentMode: true,
                            studentId: currentUser.uid,
                            teacherId: update.teacherId,
                            teacherInfo: userData?.teacherInfo,
                            studentInfo: userData?.studentInfo
                        };
                        
                        // å¦‚æœæ‰“æƒä»»å‹™æœ‰è®ŠåŒ–ï¼Œé‡æ–°ç”Ÿæˆè¡¨æ ¼
                        if (oldTaskCount !== newTaskCount || 
                            JSON.stringify(userData.assignments) !== JSON.stringify(update.data.assignments)) {
                            console.log('ğŸ”„ æ•™å¸«è³‡æ–™å·²æ›´æ–°ï¼Œé‡æ–°ç”Ÿæˆè¡¨æ ¼');
                            generateTrackingTable();
                        }
                    }
                });
                
                // ç›£è½æ•™å¸«çš„è¿½è¹¤è³‡æ–™è®ŠåŒ–ï¼ˆå­¸ç”Ÿæ¨¡å¼ä¸‹ä¹Ÿè¦åŒæ­¥æ•™å¸«çš„è¿½è¹¤ï¼‰
                const teacherId = sessionStorage.getItem('teacherId');
                if (teacherId) {
                    unsubscribeTrackingData = window.firebaseService.onTrackingDataChanged(teacherId, (doc) => {
                        if (doc.exists) {
                            trackingData = doc.data();
                            console.log('ğŸ“¡ æ•™å¸«è¿½è¹¤è³‡æ–™å·²æ›´æ–°ï¼ˆå­¸ç”Ÿæ¨¡å¼ï¼‰');
                            // æ›´æ–°çµ±è¨ˆå’Œé¡¯ç¤º
                            updateStatistics();
                        }
                    });
                }
                
            } else {
                // ä¸€èˆ¬æ¨¡å¼ï¼šç›£è½é¸ä¸­ä½¿ç”¨è€…çš„è³‡æ–™
                const targetUserId = selectedUser || currentUser.uid;
                
                unsubscribeTeacherData = window.firebaseService.onUserDataChanged(targetUserId, (doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        console.log('ğŸ“¡ ä½¿ç”¨è€…è³‡æ–™å·²æ›´æ–°');
                        generateTrackingTable();
                    }
                });
                
                unsubscribeTrackingData = window.firebaseService.onTrackingDataChanged(targetUserId, (doc) => {
                    if (doc.exists) {
                        trackingData = doc.data();
                        console.log('ğŸ“¡ è¿½è¹¤è³‡æ–™å·²æ›´æ–°');
                        updateStatistics();
                    }
                });
            }
        }
        
        // é é¢å¸è¼‰æ™‚æ¸…ç†ç›£è½å™¨
        window.addEventListener('beforeunload', () => {
            if (unsubscribeTeacherData) unsubscribeTeacherData();
            if (unsubscribeTrackingData) unsubscribeTrackingData();
        });

        let currentWeek = new Date();
        let selectedUser = null; // å°‡åœ¨ä½¿ç”¨è€…ç™»å…¥å¾Œè¨­å®š
        let userData = null;
        let trackingData = {};

        // é€±æ¬¡å°èˆª
        document.getElementById('prevWeek').addEventListener('click', async () => {
            currentWeek.setDate(currentWeek.getDate() - 7);
            updateWeekDisplay();
            await generateTrackingTable();
        });

        document.getElementById('nextWeek').addEventListener('click', async () => {
            currentWeek.setDate(currentWeek.getDate() + 7);
            updateWeekDisplay();
            await generateTrackingTable();
        });

        // ä½¿ç”¨è€…é¸æ“‡ï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰
        document.getElementById('selectedUser')?.addEventListener('change', async (e) => {
            selectedUser = e.target.value;
            console.log('ä½¿ç”¨è€…é¸æ“‡è®Šæ›´ç‚º:', selectedUser);
            updateSelectedUserInfo();
            await generateTrackingTable();
        });

        async function logout() {
            try {
                await window.firebaseService.signOut();
                sessionStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function goToImport() {
            window.location.href = 'import.html';
        }

        function getWeekKey(date) {
            const year = date.getFullYear();
            const weekNum = getWeekNumber(date);
            return `${year}-W${weekNum}`;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function updateWeekDisplay() {
            const startOfWeek = new Date(currentWeek);
            startOfWeek.setDate(currentWeek.getDate() - currentWeek.getDay());
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const formatDate = (date) => `${date.getMonth() + 1}/${date.getDate()}`;
            
            document.getElementById('currentWeek').textContent = 
                `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
        }

        async function loadUserData() {
            const targetUserId = selectedUser || currentUser?.uid;
            if (!targetUserId) return false;
            
            try {
                // æª¢æŸ¥æ˜¯å¦ç‚ºå­¸ç”Ÿæ¨¡å¼ï¼ˆå¾ sessionStorageï¼‰
                const isStudentMode = sessionStorage.getItem('isStudentMode') === 'true';
                const teacherId = sessionStorage.getItem('teacherId');
                
                if (isStudentMode && userRole === 'student' && currentUser?.uid === targetUserId) {
                    // å­¸ç”Ÿæ¨¡å¼ï¼šè¼‰å…¥æ•™å¸«çš„è³‡æ–™
                    console.log('ğŸ“ å­¸ç”Ÿæ¨¡å¼ï¼šè¼‰å…¥æ•™å¸«è³‡æ–™');
                    return await loadStudentTeacherData(targetUserId);
                } else if (await isStudent(targetUserId)) {
                    // æ•™å¸«æŸ¥çœ‹å­¸ç”Ÿçš„æƒ…æ³
                    return await loadStudentTeacherData(targetUserId);
                }
                
                // ä¸€èˆ¬æƒ…æ³ï¼šè¼‰å…¥æŒ‡å®šä½¿ç”¨è€…çš„è³‡æ–™
                const [userDataResult, trackingResult] = await Promise.all([
                    window.firebaseService.getUserData(targetUserId),
                    window.firebaseService.getTrackingData(targetUserId)
                ]);
                
                if (userDataResult.success && userDataResult.data) {
                    userData = userDataResult.data;
                    
                    if (trackingResult.success) {
                        trackingData = trackingResult.data || {};
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™éŒ¯èª¤:', error);
            }
            return false;
        }
        
        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦ç‚ºå­¸ç”Ÿ
        async function isStudent(userId) {
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(userId).get();
                return userDoc.exists && userDoc.data()?.role === 'student';
            } catch (error) {
                console.error('æª¢æŸ¥ç”¨æˆ¶è§’è‰²éŒ¯èª¤:', error);
                return false;
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæ•™å¸«çš„å­¸ç”Ÿ
        async function isTeacherStudent(teacherId, studentId) {
            try {
                const studentDoc = await window.firebaseService.db.collection('students').doc(studentId).get();
                return studentDoc.exists && studentDoc.data()?.teacherId === teacherId;
            } catch (error) {
                console.error('æª¢æŸ¥å¸«ç”Ÿé—œä¿‚éŒ¯èª¤:', error);
                return false;
            }
        }
        
        // è¼‰å…¥å­¸ç”Ÿå°æ‡‰æ•™å¸«çš„è³‡æ–™
        async function loadStudentTeacherData(studentId) {
            try {
                console.log('è¼‰å…¥å­¸ç”Ÿæ•™å¸«è³‡æ–™ï¼Œå­¸ç”ŸID:', studentId);
                
                // ä½¿ç”¨æ–°çš„ getTeacherDataForStudent æ–¹æ³•
                const teacherDataResult = await window.firebaseService.getTeacherDataForStudent(studentId);
                
                if (!teacherDataResult.success) {
                    console.log('ç„¡æ³•è¼‰å…¥æ•™å¸«è³‡æ–™:', teacherDataResult.error);
                    return false;
                }
                
                const { teacherId, teacherInfo, teacherData: teacherUserData, teacherTrackingData, studentInfo } = teacherDataResult;
                
                // è¼‰å…¥å­¸ç”Ÿè‡ªå·±çš„è¿½è¹¤è¨˜éŒ„
                const studentTrackingResult = await window.firebaseService.getTrackingData(studentId);
                
                // æª¢æŸ¥æ•™å¸«æ˜¯å¦æœ‰è³‡æ–™
                if (!teacherUserData || !teacherUserData.cleaningTasks || !teacherUserData.assignments) {
                    console.log('âŒ æ•™å¸«æ²’æœ‰æ¸…æƒè³‡æ–™');
                    console.log('teacherUserData:', teacherUserData);
                    userData = {
                        cleaningTasks: [],
                        assignments: {},
                        isStudentMode: true,
                        studentId: studentId,
                        studentInfo: studentInfo,
                        teacherId: teacherId,
                        teacherInfo: teacherInfo,
                        error: 'æ•™å¸«å°šæœªåŒ¯å…¥æ¸…æƒè³‡æ–™'
                    };
                    trackingData = {};
                    return false;
                }
                
                // è¨­ç½®å…¨åŸŸè®Šæ•¸
                userData = teacherUserData; // ä½¿ç”¨æ•™å¸«çš„ cleaningTasks å’Œ assignments
                trackingData = teacherTrackingData || {}; // ä½¿ç”¨æ•™å¸«çš„è¿½è¹¤è³‡æ–™ï¼Œç¢ºä¿åŒæ­¥
                
                // æ¨™è¨˜é€™æ˜¯å­¸ç”Ÿæ¨¡å¼ï¼Œä¸¦ä¿å­˜ç›¸é—œè³‡è¨Š
                userData.isStudentMode = true;
                userData.studentId = studentId;
                userData.studentData = studentInfo;  // ä¿®æ­£ï¼šä½¿ç”¨ studentData è€Œé studentInfo
                userData.teacherId = teacherId;
                userData.teacherInfo = teacherInfo;
                
                console.log('å­¸ç”Ÿæ•™å¸«è³‡æ–™è¼‰å…¥å®Œæˆ');
                console.log('æ•™å¸«:', teacherInfo?.name || teacherId);
                console.log('å­¸ç”Ÿ:', studentInfo?.name || studentId);
                console.log('æ‰“æƒä»»å‹™æ•¸é‡:', userData.cleaningTasks?.length || 0);
                console.log('åˆ†é…æ•¸é‡:', Object.keys(userData.assignments || {}).length);
                
                return true;
                
            } catch (error) {
                console.error('è¼‰å…¥å­¸ç”Ÿæ•™å¸«è³‡æ–™éŒ¯èª¤:', error);
                return false;
            }
        }

        async function generateTrackingTable() {
            console.log('=== é–‹å§‹ç”Ÿæˆè¿½è¹¤è¡¨æ ¼ ===');
            console.log('ç•¶å‰ä½¿ç”¨è€… UID:', currentUser?.uid);
            console.log('é¸æ“‡çš„ä½¿ç”¨è€…:', selectedUser);
            console.log('ä½¿ç”¨è€…è§’è‰²:', userRole);
            
            const dataLoaded = await loadUserData();
            console.log('è³‡æ–™è¼‰å…¥çµæœ:', dataLoaded);
            console.log('ä½¿ç”¨è€…è³‡æ–™:', userData);
            
            if (!dataLoaded || !userData) {
                console.log('âŒ è³‡æ–™è¼‰å…¥å¤±æ•—æˆ–è³‡æ–™ç‚ºç©º');
                document.getElementById('trackingTable').innerHTML = `
                    <div class="no-data">
                        <p>ğŸ“ å°šæœªåŒ¯å…¥è³‡æ–™</p>
                        <button onclick="goToImport()" class="primary-btn">å‰å¾€åŒ¯å…¥è³‡æ–™</button>
                    </div>
                `;
                return;
            }
            
            // é¡¯ç¤ºå­¸ç”Ÿæ¨¡å¼ç›¸é—œè³‡è¨Š
            if (userData.isStudentMode) {
                document.getElementById('studentModeBanner').style.display = 'block';
                console.log('ğŸ›¡ï¸ è¡›ç”Ÿè‚¡é•·æ¨¡å¼å·²å•Ÿç”¨ï¼Œå¯ä»¥æ¨™è¨˜ç¼ºé»ä½†ä¸èƒ½è§£é™¤');
                
                // é¡¯ç¤ºè³‡æ–™ä¾†æºè³‡è¨Š
                const dataSourceInfo = document.getElementById('dataSourceInfo');
                const teacherNameDisplay = document.getElementById('teacherNameDisplay');
                
                if (userData.teacherInfo?.name) {
                    teacherNameDisplay.textContent = `æ•™å¸«ï¼š${userData.teacherInfo.name}`;
                } else {
                    teacherNameDisplay.textContent = 'æ•™å¸«è³‡æ–™';
                }
                
                dataSourceInfo.style.display = 'block';
            }
            
            // æª¢æŸ¥å¿…è¦è³‡æ–™
            if (!userData.cleaningTasks || !userData.assignments) {
                console.log('âŒ ç¼ºå°‘å¿…è¦è³‡æ–™');
                console.log('cleaningTasks:', userData.cleaningTasks?.length);
                console.log('assignments:', Object.keys(userData.assignments || {}).length);
                console.log('isStudentMode:', userData.isStudentMode);
                console.log('userData:', userData);
                
                let errorMessage = 'ğŸ“ è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹é‡æ–°åŒ¯å…¥';
                if (userData.isStudentMode && userData.error) {
                    errorMessage = `ğŸ“ ${userData.error}`;
                } else if (userData.isStudentMode) {
                    errorMessage = 'ğŸ“ æ‚¨çš„æ•™å¸«å°šæœªåŒ¯å…¥æ¸…æƒè³‡æ–™ï¼Œè«‹è¯çµ¡æ•™å¸«å…ˆåŒ¯å…¥è³‡æ–™';
                }
                
                document.getElementById('trackingTable').innerHTML = `
                    <div class="no-data">
                        <p>${errorMessage}</p>
                        ${userData.isStudentMode ? '' : '<button onclick="goToImport()" class="primary-btn">å‰å¾€åŒ¯å…¥è³‡æ–™</button>'}
                        ${userData.isStudentMode ? '<p><small>å¦‚æœ‰å•é¡Œè«‹è¯çµ¡æ‚¨çš„æ•™å¸«</small></p>' : ''}
                    </div>
                `;
                return;
            }
            
            console.log('âœ… è³‡æ–™æª¢æŸ¥é€šé');
            console.log('æ‰“æƒäº‹é …æ•¸é‡:', userData.cleaningTasks.length);
            console.log('åˆ†é…ä»»å‹™æ•¸é‡:', Object.keys(userData.assignments).length);

            const startOfWeek = new Date(currentWeek);
            startOfWeek.setDate(currentWeek.getDate() - currentWeek.getDay());
            
            let tableHTML = '<table class="tracking-table"><thead><tr><th class="task-header">æ‰“æƒäº‹é … / è² è²¬äºº</th>';
            
            // ç”Ÿæˆæ—¥æœŸæ¨™é¡Œ
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                tableHTML += `<th class="date-header">${dateStr}<br>(${weekdays[i]})</th>`;
            }
            tableHTML += '</tr></thead><tbody>';

            // ç”Ÿæˆä»»å‹™è¡Œ
            console.log('é–‹å§‹ç”Ÿæˆä»»å‹™è¡Œï¼Œç¸½ä»»å‹™æ•¸:', userData.cleaningTasks.length);
            userData.cleaningTasks.forEach((task, taskIndex) => {
                const taskName = task['å®Œæ•´äº‹é …'] || task['äº‹é …'] || 'æœªçŸ¥äº‹é …';
                const assignedStudents = userData.assignments[taskIndex] || [];
                
                console.log(`ä»»å‹™ ${taskIndex}: ${taskName}, åˆ†é…å­¸ç”Ÿæ•¸: ${assignedStudents.length}`);
                
                if (assignedStudents.length === 0) {
                    console.log(`è·³éä»»å‹™ ${taskIndex}ï¼Œç„¡åˆ†é…å­¸ç”Ÿ`);
                    return;
                }

                // è¡›ç”Ÿè‚¡é•·æ¨¡å¼ï¼šé¡¯ç¤ºæ‰€æœ‰ä»»å‹™å’Œæ‰€æœ‰è² è²¬çš„å­¸ç”Ÿ
                let filteredStudents = assignedStudents;
                if (userData.isStudentMode) {
                    // è¡›ç”Ÿè‚¡é•·æ¨¡å¼ï¼šé¡¯ç¤ºæ‰€æœ‰ä»»å‹™å’Œæ‰€æœ‰å­¸ç”Ÿï¼Œä¸åšéæ¿¾
                    filteredStudents = assignedStudents;
                    console.log('ğŸ›¡ï¸ è¡›ç”Ÿè‚¡é•·æ¨¡å¼ï¼šé¡¯ç¤ºæ‰€æœ‰å­¸ç”Ÿ', filteredStudents);
                }

                filteredStudents.forEach(studentKey => {
                    // å°‡ uniqueKey è½‰æ›å›é¡¯ç¤ºæ ¼å¼
                    const parts = studentKey.split('_');
                    const displayName = parts.length >= 2 ? `${parts[0]} ${parts.slice(1).join('_')}` : studentKey;
                    
                    tableHTML += `<tr><td class="task-cell">
                        <div class="task-info">
                            <strong>${taskName}</strong>
                            <div class="student-name">${displayName}</div>
                        </div>
                    </td>`;
                    
                    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                        const date = new Date(startOfWeek);
                        date.setDate(startOfWeek.getDate() + dayIndex);
                        const dateKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                        const cellKey = `${taskIndex}-${studentKey}-${dateKey}`;
                        
                        const currentStatus = trackingData[cellKey] || 'empty';
                        // ç®¡ç†å“¡å¯ä»¥ç·¨è¼¯æ‰€æœ‰è³‡æ–™ï¼Œä¸€èˆ¬ä½¿ç”¨è€…åªèƒ½ç·¨è¼¯è‡ªå·±çš„è³‡æ–™
                        const cellClass = userRole === 'admin' || selectedUser === currentUser?.uid ? 'clickable' : '';
                        
                        tableHTML += `<td class="tracking-cell ${cellClass}" data-key="${cellKey}" data-student="${studentKey}">`;
                        
                        if (currentStatus === 'merit') {
                            tableHTML += 'ğŸ…';
                        } else if (currentStatus === 'demerit') {
                            tableHTML += 'ğŸ˜ˆ';
                        }
                        
                        tableHTML += '</td>';
                    }
                    tableHTML += '</tr>';
                });
            });

            tableHTML += '</tbody></table>';
            document.getElementById('trackingTable').innerHTML = tableHTML;

            // æ·»åŠ é»æ“Šäº‹ä»¶
            // ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹ä»»ä½•äººçš„è³‡æ–™ï¼Œä¸€èˆ¬ä½¿ç”¨è€…åªèƒ½ä¿®æ”¹è‡ªå·±çš„
            console.log('ç¶å®šé»æ“Šäº‹ä»¶ï¼Œä½¿ç”¨è€…è§’è‰²:', userRole);
            console.log('é¸æ“‡çš„ä½¿ç”¨è€…:', selectedUser);
            console.log('ç•¶å‰ä½¿ç”¨è€… UID:', currentUser?.uid);
            
            // ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹æ‰€æœ‰äººçš„è³‡æ–™ï¼Œæ•™å¸«å¯ä»¥ä¿®æ”¹å­¸ç”Ÿè³‡æ–™ï¼Œå­¸ç”Ÿåªèƒ½ä¿®æ”¹è‡ªå·±çš„è³‡æ–™
            let canEdit = false;
            if (userRole === 'admin') {
                canEdit = true; // ç®¡ç†å“¡å¯ä»¥ç·¨è¼¯ä»»ä½•äºº
            } else if (userRole === 'teacher') {
                canEdit = selectedUser === currentUser?.uid || await isTeacherStudent(currentUser?.uid, selectedUser);
            } else if (userData.isStudentMode) {
                canEdit = true; // å­¸ç”Ÿå¯ä»¥ç·¨è¼¯è‡ªå·±è² è²¬çš„ä»»å‹™ï¼ˆå·²åœ¨ trackingData å­˜å„²ä¸­éš”é›¢ï¼‰
            } else {
                canEdit = selectedUser === currentUser?.uid; // ä¸€èˆ¬ç”¨æˆ¶åªèƒ½ç·¨è¼¯è‡ªå·±çš„
            }
            
            if (canEdit) {
                const clickableCells = document.querySelectorAll('.tracking-cell.clickable');
                console.log('æ‰¾åˆ°å¯é»æ“Šå–®å…ƒæ ¼æ•¸é‡:', clickableCells.length);
                
                clickableCells.forEach(cell => {
                    cell.addEventListener('click', handleCellClick);
                    cell.style.cursor = 'pointer'; // é¡¯ç¤ºæŒ‡é‡æ¸¸æ¨™
                });
            } else {
                // å¦‚æœç„¡æ¬Šç·¨è¼¯ï¼Œé¡¯ç¤ºæç¤º
                const trackingTable = document.getElementById('trackingTable');
                if (trackingTable && !trackingTable.querySelector('.no-edit-notice')) {
                    const notice = document.createElement('div');
                    notice.className = 'no-edit-notice';
                    notice.innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <strong>ğŸ“– æª¢è¦–æ¨¡å¼</strong> - æ‚¨åªèƒ½æŸ¥çœ‹æ­¤è³‡æ–™ï¼Œç„¡æ³•ä¿®æ”¹
                        </div>
                    `;
                    trackingTable.insertBefore(notice, trackingTable.firstChild);
                }
            }

            // é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
            updateStatistics();
        }

        function handleCellClick(e) {
            console.log('å–®å…ƒæ ¼è¢«é»æ“Š');
            
            const cell = e.target;
            const cellKey = cell.dataset.key;
            const studentKey = cell.dataset.student;
            
            console.log('é»æ“Šçš„å–®å…ƒæ ¼:', cellKey, 'å­¸ç”Ÿ:', studentKey);
            
            let currentStatus = trackingData[cellKey] || 'empty';
            let newStatus;
            
            // æ ¹æ“šä½¿ç”¨è€…è§’è‰²æ±ºå®šç·¨è¼¯é‚è¼¯
            if (userData.isStudentMode) {
                // å­¸ç”Ÿï¼ˆè¡›ç”Ÿè‚¡é•·ï¼‰æ¨¡å¼ï¼šåªèƒ½æ–°å¢ç¼ºé»ï¼Œä¸èƒ½è§£é™¤
                switch (currentStatus) {
                    case 'empty':
                        newStatus = 'demerit';
                        cell.innerHTML = 'ğŸ˜ˆ';
                        console.log('è¡›ç”Ÿè‚¡é•·æ¨™è¨˜ç¼ºé»');
                        break;
                    case 'merit':
                        // å·²æœ‰å„ªé»ï¼Œè¡›ç”Ÿè‚¡é•·å¯ä»¥è¦†è“‹æˆç¼ºé»
                        newStatus = 'demerit';
                        cell.innerHTML = 'ğŸ˜ˆ';
                        console.log('è¡›ç”Ÿè‚¡é•·è¦†è“‹å„ªé»ç‚ºç¼ºé»');
                        break;
                    case 'demerit':
                        // å·²æœ‰ç¼ºé»ï¼Œè¡›ç”Ÿè‚¡é•·ä¸èƒ½è§£é™¤
                        console.log('è¡›ç”Ÿè‚¡é•·ç„¡æ³•è§£é™¤ç¼ºé»');
                        
                        // çµ¦äºˆè¦–è¦ºåé¥‹
                        cell.style.animation = 'shake 0.5s';
                        setTimeout(() => {
                            cell.style.animation = '';
                        }, 500);
                        
                        // é¡¯ç¤ºæç¤ºè¨Šæ¯
                        const tooltip = document.createElement('div');
                        tooltip.textContent = 'åªæœ‰è€å¸«èƒ½è§£é™¤ç¼ºé»';
                        tooltip.style.cssText = `
                            position: absolute;
                            background: #dc3545;
                            color: white;
                            padding: 5px 10px;
                            border-radius: 4px;
                            font-size: 12px;
                            z-index: 1000;
                            pointer-events: none;
                        `;
                        
                        const rect = cell.getBoundingClientRect();
                        tooltip.style.left = rect.left + 'px';
                        tooltip.style.top = (rect.top - 30) + 'px';
                        
                        document.body.appendChild(tooltip);
                        setTimeout(() => {
                            document.body.removeChild(tooltip);
                        }, 2000);
                        
                        return; // ä¸åšä»»ä½•æ”¹è®Š
                }
            } else {
                // æ•™å¸«/ç®¡ç†å“¡æ¨¡å¼ï¼šå®Œæ•´å¾ªç’° ç©ºç™½ â†’ ğŸ… â†’ ğŸ˜ˆ â†’ ç©ºç™½
                switch (currentStatus) {
                    case 'empty':
                        newStatus = 'merit';
                        cell.innerHTML = 'ğŸ…';
                        break;
                    case 'merit':
                        newStatus = 'demerit';
                        cell.innerHTML = 'ğŸ˜ˆ';
                        break;
                    case 'demerit':
                        newStatus = 'empty';
                        cell.innerHTML = '';
                        break;
                }
            }
            
            trackingData[cellKey] = newStatus;
            console.log('æ›´æ–°ç‹€æ…‹:', cellKey, 'â†’', newStatus);
            
            saveTrackingData();
            
            // æª¢æŸ¥ç¼ºå¤±è­¦å‘Š
            checkDemeritWarning(studentKey);
            updateStatistics();
        }

        function checkDemeritWarning(studentKey) {
            const weekKey = getWeekKey(currentWeek);
            let demeritCount = 0;
            
            Object.keys(trackingData).forEach(key => {
                if (key.includes(studentKey) && trackingData[key] === 'demerit') {
                    demeritCount++;
                }
            });
            
            if (demeritCount >= 3) {
                // æ·»åŠ è­¦å‘Šæ¨™è¨˜
                document.querySelectorAll(`[data-student="${studentKey}"]`).forEach(cell => {
                    cell.classList.add('warning-student');
                });
                
                if (demeritCount === 3) {
                    // è½‰æ›ç‚ºé¡¯ç¤ºæ ¼å¼
                    const parts = studentKey.split('_');
                    const displayName = parts.length >= 2 ? `${parts[0]} ${parts.slice(1).join('_')}` : studentKey;
                    alert(`âš ï¸ è­¦å‘Šï¼š${displayName} å·²ç´¯ç©ä¸‰æ¬¡ç¼ºå¤±ï¼`);
                }
            } else {
                // ç§»é™¤è­¦å‘Šæ¨™è¨˜
                document.querySelectorAll(`[data-student="${studentKey}"]`).forEach(cell => {
                    cell.classList.remove('warning-student');
                });
            }
        }

        function updateStatistics() {
            const stats = {};
            const students = new Set();
            
            Object.keys(trackingData).forEach(key => {
                const [taskIndex, studentName, date] = key.split('-').slice(0, 3);
                const status = trackingData[key];
                
                if (!stats[studentName]) {
                    stats[studentName] = { merit: 0, demerit: 0 };
                }
                
                if (status === 'merit') {
                    stats[studentName].merit++;
                } else if (status === 'demerit') {
                    stats[studentName].demerit++;
                }
                
                students.add(studentName);
            });
            
            let statsHTML = '<div class="stats-grid">';
            Array.from(students).forEach(student => {
                const studentStats = stats[student] || { merit: 0, demerit: 0 };
                const warningClass = studentStats.demerit >= 3 ? 'warning' : '';
                
                statsHTML += `
                    <div class="student-stats ${warningClass}">
                        <h4>${student}</h4>
                        <div class="stat-item">ğŸ… ${studentStats.merit}</div>
                        <div class="stat-item">ğŸ˜ˆ ${studentStats.demerit}</div>
                        ${studentStats.demerit >= 3 ? '<div class="warning-text">âš ï¸ éœ€è¦é—œæ³¨</div>' : ''}
                    </div>
                `;
            });
            statsHTML += '</div>';
            
            document.getElementById('statsContent').innerHTML = statsHTML;
            document.getElementById('statisticsPanel').style.display = 'block';
        }

        async function saveTrackingData() {
            let targetUserId = selectedUser || currentUser?.uid;
            
            // å¦‚æœæ˜¯å­¸ç”Ÿæ¨¡å¼ï¼Œè¿½è¹¤è³‡æ–™è¦å­˜åˆ°æ•™å¸«çš„ ID ä¸‹ä»¥ä¿æŒåŒæ­¥
            if (userData.isStudentMode && userData.teacherId) {
                targetUserId = userData.teacherId;
            }
            
            if (!targetUserId) return;
            
            try {
                await window.firebaseService.saveTrackingData(targetUserId, trackingData);
                console.log('è¿½è¹¤è³‡æ–™å·²å„²å­˜åˆ°:', targetUserId);
            } catch (error) {
                console.error('å„²å­˜è¿½è¹¤è³‡æ–™éŒ¯èª¤:', error);
            }
        }

        // åˆå§‹åŒ–å°‡åœ¨ loadUserInfo ä¸­åŸ·è¡Œ
    </script>
</body>
</html>