<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¾©å­¸ç”Ÿè¨˜éŒ„ - æ‰“æƒè¿½è¹¤ç³»çµ±</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .student-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        .fix-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .fix-btn:disabled {
            background: #ccc;
        }
        .status {
            margin-left: 10px;
            font-weight: bold;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ä¿®å¾©å­¸ç”Ÿè¨˜éŒ„</h1>
        <p>é€™å€‹å·¥å…·æœƒæª¢æŸ¥æ‰€æœ‰å­¸ç”Ÿä½¿ç”¨è€…ï¼Œä¸¦ç‚ºç¼ºå°‘ students é›†åˆè¨˜éŒ„çš„å­¸ç”Ÿå‰µå»ºå°æ‡‰è¨˜éŒ„ã€‚</p>
        
        <div id="status">è¼‰å…¥ä¸­...</div>
        
        <div id="studentList"></div>
        
        <div style="margin-top: 20px;">
            <button id="fixAllBtn" class="fix-btn">ä¿®å¾©æ‰€æœ‰ç¼ºå°‘è¨˜éŒ„çš„å­¸ç”Ÿ</button>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple.js"></script>
    
    <script>
        let currentUser = null;
        let studentsNeedingFix = [];

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await window.firebaseService.db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                
                if (userData?.role === 'admin' || userData?.role === 'teacher') {
                    await scanStudentRecords();
                } else {
                    document.getElementById('status').innerHTML = 'âŒ åªæœ‰ç®¡ç†å“¡æˆ–æ•™å¸«å¯ä»¥ä½¿ç”¨æ­¤å·¥å…·';
                }
            } else {
                document.getElementById('status').innerHTML = 'âŒ è«‹å…ˆç™»å…¥ç®¡ç†å“¡æˆ–æ•™å¸«å¸³è™Ÿ';
            }
        });

        async function scanStudentRecords() {
            document.getElementById('status').innerHTML = 'ğŸ” æƒæå­¸ç”Ÿè¨˜éŒ„ä¸­...';
            
            try {
                // 1. ç²å–æ‰€æœ‰è§’è‰²ç‚º student çš„ä½¿ç”¨è€…
                const usersSnapshot = await window.firebaseService.db.collection('users')
                    .where('role', '==', 'student').get();
                
                const studentListDiv = document.getElementById('studentList');
                studentListDiv.innerHTML = '';
                studentsNeedingFix = [];
                
                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    const userData = userDoc.data();
                    
                    // 2. æª¢æŸ¥æ˜¯å¦åœ¨ students é›†åˆä¸­æœ‰å°æ‡‰è¨˜éŒ„
                    const studentDoc = await window.firebaseService.db.collection('students').doc(userId).get();
                    
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item';
                    
                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        studentItem.innerHTML = `
                            <strong>${userData.name || userData.email}</strong> (${userData.studentNumber || 'ç„¡å­¸è™Ÿ'})
                            <span class="status success">âœ… è¨˜éŒ„æ­£å¸¸</span>
                            <br><small>æ•™å¸«ID: ${studentData.teacherId || 'æœªè¨­å®š'}</small>
                        `;
                    } else {
                        studentsNeedingFix.push({ userId, userData });
                        studentItem.innerHTML = `
                            <strong>${userData.name || userData.email}</strong> (${userData.studentNumber || 'ç„¡å­¸è™Ÿ'})
                            <span class="status error">âŒ ç¼ºå°‘ students è¨˜éŒ„</span>
                            <button class="fix-btn" onclick="fixStudentRecord('${userId}')">ä¿®å¾©</button>
                            <span id="status-${userId}"></span>
                        `;
                    }
                    
                    studentListDiv.appendChild(studentItem);
                }
                
                document.getElementById('status').innerHTML = 
                    `ğŸ“Š æƒæå®Œæˆï¼šæ‰¾åˆ° ${usersSnapshot.size} å€‹å­¸ç”Ÿå¸³è™Ÿï¼Œå…¶ä¸­ ${studentsNeedingFix.length} å€‹éœ€è¦ä¿®å¾©`;
                
                // æ›´æ–°ä¿®å¾©æ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹
                const fixAllBtn = document.getElementById('fixAllBtn');
                if (studentsNeedingFix.length > 0) {
                    fixAllBtn.disabled = false;
                    fixAllBtn.textContent = `ä¿®å¾©æ‰€æœ‰ ${studentsNeedingFix.length} å€‹å­¸ç”Ÿè¨˜éŒ„`;
                } else {
                    fixAllBtn.disabled = true;
                    fixAllBtn.textContent = 'ç„¡éœ€ä¿®å¾©';
                }
                
            } catch (error) {
                console.error('æƒæå­¸ç”Ÿè¨˜éŒ„éŒ¯èª¤:', error);
                document.getElementById('status').innerHTML = 'âŒ æƒæå¤±æ•—ï¼š' + error.message;
            }
        }

        async function fixStudentRecord(studentId) {
            const statusSpan = document.getElementById(`status-${studentId}`);
            statusSpan.innerHTML = '<span class="warning">ä¿®å¾©ä¸­...</span>';
            
            try {
                const student = studentsNeedingFix.find(s => s.userId === studentId);
                if (!student) {
                    statusSpan.innerHTML = '<span class="error">âŒ æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™</span>';
                    return;
                }
                
                // å‰µå»º students è¨˜éŒ„ï¼Œå°‡ç•¶å‰ç™»å…¥çš„æ•™å¸«è¨­ç‚ºè©²å­¸ç”Ÿçš„æ•™å¸«
                await window.firebaseService.db.collection('students').doc(studentId).set({
                    teacherId: currentUser.uid,  // è¨­å®šç•¶å‰ç™»å…¥çš„æ•™å¸«ç‚ºè©²å­¸ç”Ÿçš„æ•™å¸«
                    studentNumber: student.userData.studentNumber || '',
                    name: student.userData.name || student.userData.email,
                    email: student.userData.email,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                statusSpan.innerHTML = '<span class="success">âœ… ä¿®å¾©æˆåŠŸ</span>';
                
                // å¾éœ€è¦ä¿®å¾©çš„åˆ—è¡¨ä¸­ç§»é™¤
                studentsNeedingFix = studentsNeedingFix.filter(s => s.userId !== studentId);
                
                // æ›´æ–°ä¿®å¾©æ‰€æœ‰æŒ‰éˆ•
                const fixAllBtn = document.getElementById('fixAllBtn');
                if (studentsNeedingFix.length > 0) {
                    fixAllBtn.textContent = `ä¿®å¾©æ‰€æœ‰ ${studentsNeedingFix.length} å€‹å­¸ç”Ÿè¨˜éŒ„`;
                } else {
                    fixAllBtn.disabled = true;
                    fixAllBtn.textContent = 'ç„¡éœ€ä¿®å¾©';
                }
                
            } catch (error) {
                console.error('ä¿®å¾©å­¸ç”Ÿè¨˜éŒ„éŒ¯èª¤:', error);
                statusSpan.innerHTML = '<span class="error">âŒ ä¿®å¾©å¤±æ•—</span>';
            }
        }

        // ä¿®å¾©æ‰€æœ‰å­¸ç”Ÿè¨˜éŒ„
        document.getElementById('fixAllBtn').addEventListener('click', async () => {
            const fixAllBtn = document.getElementById('fixAllBtn');
            fixAllBtn.disabled = true;
            fixAllBtn.textContent = 'ä¿®å¾©ä¸­...';
            
            const studentsToFix = [...studentsNeedingFix]; // è¤‡è£½é™£åˆ—
            
            for (const student of studentsToFix) {
                await fixStudentRecord(student.userId);
                // çŸ­æš«å»¶é²é¿å…éæ–¼é »ç¹çš„è«‹æ±‚
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            alert('æ‰€æœ‰å­¸ç”Ÿè¨˜éŒ„ä¿®å¾©å®Œæˆï¼');
        });
    </script>
</body>
</html>