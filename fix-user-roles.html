<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¾©ä½¿ç”¨è€…è§’è‰² - æ‰“æƒè¿½è¹¤ç³»çµ±</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .user-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            flex: 1;
        }
        .role-selector {
            margin: 0 15px;
        }
        .role-selector select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .update-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .update-btn:disabled {
            background: #ccc;
        }
        .admin { background: #ffe6e6; }
        .teacher { background: #e6f3ff; }
        .student { background: #fff4e6; }
        .user { background: #f0f0f0; }
        .status {
            margin-left: 10px;
            font-weight: bold;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘¥ ä¿®å¾©ä½¿ç”¨è€…è§’è‰²</h1>
        <p>é€™å€‹å·¥å…·å¯ä»¥ä¿®æ­£æ‰€æœ‰ä½¿ç”¨è€…çš„è§’è‰²è¨­å®šã€‚</p>
        
        <div id="status">è¼‰å…¥ä¸­...</div>
        
        <div id="userList"></div>
        
        <div style="margin-top: 20px;">
            <button id="batchUpdateBtn" class="update-btn">æ‰¹é‡æ›´æ–°ï¼šå°‡æ‰€æœ‰ 'user' è§’è‰²æ”¹ç‚º 'teacher'</button>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple.js"></script>
    
    <script>
        let currentUser = null;
        let allUsers = [];

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await window.firebaseService.db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                
                if (userData?.role === 'admin') {
                    await loadAllUsers();
                } else {
                    document.getElementById('status').innerHTML = 'âŒ åªæœ‰ç®¡ç†å“¡å¯ä»¥ä½¿ç”¨æ­¤å·¥å…·';
                }
            } else {
                document.getElementById('status').innerHTML = 'âŒ è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ';
            }
        });

        async function loadAllUsers() {
            document.getElementById('status').innerHTML = 'ğŸ” è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…...';
            
            try {
                const result = await window.firebaseService.getAllUsers();
                
                if (result.success) {
                    allUsers = result.users;
                    displayUsers();
                    document.getElementById('status').innerHTML = 
                        `ğŸ“Š è¼‰å…¥å®Œæˆï¼šå…± ${allUsers.length} å€‹ä½¿ç”¨è€…`;
                } else {
                    document.getElementById('status').innerHTML = 'âŒ è¼‰å…¥å¤±æ•—ï¼š' + result.error;
                }
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…éŒ¯èª¤:', error);
                document.getElementById('status').innerHTML = 'âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message;
            }
        }

        function displayUsers() {
            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = '';
            
            allUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = `user-item ${user.role}`;
                
                const roleOptions = ['admin', 'teacher', 'student', 'user'];
                const selectOptions = roleOptions.map(role => 
                    `<option value="${role}" ${role === user.role ? 'selected' : ''}>${role}</option>`
                ).join('');
                
                userItem.innerHTML = `
                    <div class="user-info">
                        <strong>${user.name || user.email}</strong><br>
                        <small>${user.email}</small><br>
                        <small>ç•¶å‰è§’è‰²: <span style="font-weight: bold; color: ${getRoleColor(user.role)}">${user.role}</span></small>
                    </div>
                    <div class="role-selector">
                        <select id="role-${user.id}" onchange="markForUpdate('${user.id}')">
                            ${selectOptions}
                        </select>
                    </div>
                    <button class="update-btn" onclick="updateUserRole('${user.id}')" id="btn-${user.id}">
                        æ›´æ–°è§’è‰²
                    </button>
                    <span id="status-${user.id}" class="status"></span>
                `;
                
                userListDiv.appendChild(userItem);
            });
        }

        function getRoleColor(role) {
            switch(role) {
                case 'admin': return '#dc3545';
                case 'teacher': return '#007bff';
                case 'student': return '#fd7e14';
                case 'user': return '#6c757d';
                default: return '#000';
            }
        }

        function markForUpdate(userId) {
            const btn = document.getElementById(`btn-${userId}`);
            const select = document.getElementById(`role-${userId}`);
            const user = allUsers.find(u => u.id === userId);
            
            if (select.value !== user.role) {
                btn.style.background = '#ffc107';
                btn.textContent = 'éœ€è¦æ›´æ–°';
            } else {
                btn.style.background = '#28a745';
                btn.textContent = 'æ›´æ–°è§’è‰²';
            }
        }

        async function updateUserRole(userId) {
            const statusSpan = document.getElementById(`status-${userId}`);
            const btn = document.getElementById(`btn-${userId}`);
            const select = document.getElementById(`role-${userId}`);
            const newRole = select.value;
            
            statusSpan.innerHTML = '<span style="color: #ffc107;">æ›´æ–°ä¸­...</span>';
            btn.disabled = true;
            
            try {
                await window.firebaseService.db.collection('users').doc(userId).update({
                    role: newRole
                });
                
                // æ›´æ–°æœ¬åœ°è³‡æ–™
                const userIndex = allUsers.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].role = newRole;
                }
                
                statusSpan.innerHTML = '<span class="success">âœ… æ›´æ–°æˆåŠŸ</span>';
                btn.style.background = '#28a745';
                btn.textContent = 'æ›´æ–°è§’è‰²';
                
                // æ›´æ–° UI èƒŒæ™¯è‰²
                const userItem = btn.closest('.user-item');
                userItem.className = `user-item ${newRole}`;
                
                // æ›´æ–°è§’è‰²é¡¯ç¤º
                const roleSpan = userItem.querySelector('small span');
                roleSpan.textContent = newRole;
                roleSpan.style.color = getRoleColor(newRole);
                
            } catch (error) {
                console.error('æ›´æ–°è§’è‰²éŒ¯èª¤:', error);
                statusSpan.innerHTML = '<span class="error">âŒ æ›´æ–°å¤±æ•—</span>';
            } finally {
                btn.disabled = false;
            }
        }

        // æ‰¹é‡æ›´æ–°åŠŸèƒ½
        document.getElementById('batchUpdateBtn').addEventListener('click', async () => {
            const btn = document.getElementById('batchUpdateBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'æ‰¹é‡æ›´æ–°ä¸­...';
            
            const userRoleUsers = allUsers.filter(u => u.role === 'user');
            
            if (userRoleUsers.length === 0) {
                alert('æ²’æœ‰æ‰¾åˆ°éœ€è¦æ›´æ–°çš„ "user" è§’è‰²ä½¿ç”¨è€…');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦å°‡ ${userRoleUsers.length} å€‹ 'user' è§’è‰²æ”¹ç‚º 'teacher' å—ï¼Ÿ`)) {
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }
            
            for (const user of userRoleUsers) {
                try {
                    await window.firebaseService.db.collection('users').doc(user.id).update({
                        role: 'teacher'
                    });
                    
                    // æ›´æ–°å°æ‡‰çš„ select å’Œç‹€æ…‹
                    const select = document.getElementById(`role-${user.id}`);
                    const statusSpan = document.getElementById(`status-${user.id}`);
                    if (select && statusSpan) {
                        select.value = 'teacher';
                        statusSpan.innerHTML = '<span class="success">âœ… æ‰¹é‡æ›´æ–°</span>';
                    }
                    
                } catch (error) {
                    console.error(`æ›´æ–° ${user.email} è§’è‰²éŒ¯èª¤:`, error);
                }
            }
            
            alert('æ‰¹é‡æ›´æ–°å®Œæˆï¼');
            await loadAllUsers(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡¯ç¤º
            
            btn.disabled = false;
            btn.textContent = originalText;
        });
    </script>
</body>
</html>