<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打掃追蹤系統 - 登入</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <h1>🧹 打掃追蹤系統</h1>
            <form id="loginForm">
                <div class="input-group">
                    <label for="email">電子信箱</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="input-group">
                    <label for="password">密碼</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">登入</button>
            </form>
            <div class="auth-options">
                <button type="button" id="googleLoginBtn" class="google-btn">🔍 Google 登入</button>
            </div>
            
            <div class="user-info">
                <h3>🔥 Firebase 雲端帳號</h3>
                <p>🔍 推薦使用 Google 帳號快速登入</p>
                <p>📧 或使用電子信箱和密碼登入</p>
            </div>
        </div>
    </div>

    <!-- Firebase 配置 -->
    <script src="firebase-simple-public.js"></script>
    
    <script>
        // 等待頁面和 Firebase 完全載入
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成');
            
            // 檢查 Firebase 服務是否載入
            setTimeout(() => {
                if (window.firebaseService) {
                    console.log('✅ Firebase 服務已載入');
                    console.log('可用方法:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.firebaseService)));
                } else {
                    console.error('❌ Firebase 服務未載入');
                }
            }, 100);
        });
        
        // Google 登入處理
        document.getElementById('googleLoginBtn').addEventListener('click', async function() {
            const btn = document.getElementById('googleLoginBtn');
            const originalText = btn.textContent;
            btn.textContent = '處理中...';
            btn.disabled = true;
            
            try {
                // 檢查 firebaseService 是否存在
                if (!window.firebaseService) {
                    throw new Error('Firebase 服務尚未載入，請重新整理頁面');
                }
                
                // 檢查 signInWithGoogle 方法是否存在
                if (typeof window.firebaseService.signInWithGoogle !== 'function') {
                    console.error('firebaseService 方法:', Object.keys(window.firebaseService));
                    throw new Error('signInWithGoogle 方法不存在，請檢查 Firebase 設定');
                }
                
                const result = await window.firebaseService.signInWithGoogle();
                
                if (result.success) {
                    console.log('Google 登入成功:', result.user.email);
                    
                    // 儲存使用者資訊到 sessionStorage
                    sessionStorage.setItem('currentUser', result.user.uid);
                    sessionStorage.setItem('userEmail', result.user.email);
                    sessionStorage.setItem('userRole', 'teacher'); // Google 用戶預設為 teacher
                    sessionStorage.setItem('userName', result.user.displayName || result.user.email);
                    
                    // 根據使用者資料決定跳轉
                    setTimeout(async () => {
                        try {
                            const userDataResult = await firebase.firestore().collection('userData').doc(result.user.uid).get();
                            
                            if (userDataResult.exists && userDataResult.data()?.cleaningTasks?.length > 0 && userDataResult.data()?.assignments) {
                                console.log('Google 用戶有完整資料，跳轉到追蹤頁面');
                                window.location.href = 'tracking.html';
                            } else {
                                console.log('Google 用戶無完整資料，跳轉到匯入頁面');
                                window.location.href = 'import.html';
                            }
                        } catch (error) {
                            console.warn('無法檢查現有資料:', error);
                            window.location.href = 'import.html';
                        }
                    }, 300);
                } else {
                    alert('Google 登入失敗：' + result.error);
                }
            } catch (error) {
                console.error('Google 登入錯誤:', error);
                alert('Google 登入發生錯誤，請稍後再試');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });
        
        // 表單提交處理
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // 顯示載入狀態
            const submitBtn = document.querySelector('.login-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '處理中...';
            submitBtn.disabled = true;
            
            try {
                let result;
                
                // 登入使用者
                result = await window.firebaseService.signIn(email, password);
                
                if (result.success) {
                    try {
                        console.log('使用者登入成功:', result.user.email);
                        
                        // 嘗試取得使用者資料，如果不存在則建立
                        let userData = null;
                        try {
                            const userDoc = await firebase.firestore().collection('users').doc(result.user.uid).get();
                            userData = userDoc.data();
                            
                            console.log('🔍 登入時檢查使用者資料:', {
                                uid: result.user.uid,
                                email: result.user.email,
                                userDocExists: userDoc.exists,
                                userData: userData,
                                userRole: userData?.role
                            });
                            
                            // 如果使用者資料不存在，建立預設資料
                            if (!userData) {
                                console.log('⚠️ 沒有找到 users 記錄，建立新使用者資料...');
                                
                                // 檢查是否為學生：先查詢 students 集合
                                let role = 'teacher'; // 預設為教師
                                let name = '使用者';
                                
                                {
                                    // 檢查是否在 students 集合中
                                    try {
                                        const studentDoc = await firebase.firestore().collection('students').doc(result.user.uid).get();
                                        if (studentDoc.exists) {
                                            role = 'student';
                                            name = studentDoc.data().name || '學生';
                                            console.log('✅ 檢測到學生記錄，角色設為 student');
                                        } else {
                                            console.log('⚠️ 未找到學生記錄，角色設為 teacher');
                                        }
                                    } catch (error) {
                                        console.warn('檢查學生記錄錯誤，使用預設角色 teacher:', error);
                                    }
                                }
                                
                                userData = {
                                    email: result.user.email,
                                    role: role,
                                    name: name,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                
                                await firebase.firestore().collection('users').doc(result.user.uid).set(userData);
                                console.log('使用者資料建立完成，角色:', userData.role);
                            }
                        } catch (firestoreError) {
                            console.warn('Firestore 存取錯誤，使用預設資料:', firestoreError);
                            // 如果 Firestore 有問題，使用預設資料
                            userData = {
                                email: result.user.email,
                                role: 'user',
                                name: '使用者'
                            };
                        }
                        
                        // 儲存使用者資訊到 sessionStorage
                        sessionStorage.setItem('currentUser', result.user.uid);
                        sessionStorage.setItem('userEmail', result.user.email);
                        sessionStorage.setItem('userRole', userData.role || 'user');
                        sessionStorage.setItem('userName', userData.name || result.user.email);
                        
                        console.log('使用者資訊已儲存，檢查是否有現有資料...');
                        
                        // 根據使用者角色決定跳轉目標
                        setTimeout(async () => {
                            try {
                                const userRole = userData.role || 'user';
                                
                                if (userRole === 'teacher') {
                                    // 教師跳轉到學生管理頁面
                                    console.log('教師登入，跳轉到學生管理頁面');
                                    window.location.href = 'student-management.html';
                                } else if (userRole === 'student') {
                                    // 學生用戶：檢查是否有關聯教師的資料
                                    console.log('學生登入，檢查教師資料...');
                                    
                                    try {
                                        // 使用新的 getTeacherDataForStudent 方法
                                        const teacherDataResult = await window.firebaseService.getTeacherDataForStudent(result.user.uid);
                                        
                                        if (teacherDataResult.success) {
                                            console.log('找到關聯教師:', teacherDataResult.teacherId);
                                            console.log('學生資訊:', teacherDataResult.studentInfo);
                                            
                                            // 儲存教師資訊和學生資訊到 sessionStorage 供其他頁面使用
                                            sessionStorage.setItem('teacherId', teacherDataResult.teacherId);
                                            sessionStorage.setItem('teacherName', teacherDataResult.teacherInfo?.name || '教師');
                                            sessionStorage.setItem('isStudentMode', 'true');
                                            sessionStorage.setItem('studentId', result.user.uid);
                                            sessionStorage.setItem('studentName', teacherDataResult.studentInfo?.name || '學生');
                                            sessionStorage.setItem('studentNumber', teacherDataResult.studentInfo?.studentNumber || '');
                                            
                                            // 學生總是跳轉到追蹤頁面，不管教師是否有資料
                                            console.log('學生登入成功，跳轉到追蹤頁面（學生模式）');
                                            window.location.href = 'tracking.html';
                                        } else {
                                            console.log('學生沒有關聯教師，錯誤:', teacherDataResult.error);
                                            alert('學生帳號設定錯誤：' + teacherDataResult.error + '\n請聯絡教師確認帳號設定。');
                                            // 清除錯誤的登入狀態
                                            await window.firebaseService.signOut();
                                            sessionStorage.clear();
                                            return;
                                        }
                                    } catch (error) {
                                        console.warn('檢查學生教師資料錯誤:', error);
                                        alert('檢查教師資料時發生錯誤，請稍後重試。');
                                        window.location.href = 'import.html';
                                    }
                                } else {
                                    // 一般使用者檢查是否已有資料
                                    const userDataResult = await firebase.firestore().collection('userData').doc(result.user.uid).get();
                                    
                                    if (userDataResult.exists && userDataResult.data()?.cleaningTasks?.length > 0 && userDataResult.data()?.assignments) {
                                        console.log('偵測到完整資料（包含分配），跳轉到追蹤頁面');
                                        window.location.href = 'tracking.html';
                                    } else {
                                        console.log('未偵測到完整資料，跳轉到匯入頁面');
                                        window.location.href = 'import.html';
                                    }
                                }
                            } catch (error) {
                                console.warn('無法檢查現有資料:', error);
                                // 預設行為：教師到學生管理，其他到匯入
                                if (userData.role === 'teacher') {
                                    window.location.href = 'student-management.html';
                                } else {
                                    window.location.href = 'import.html';
                                }
                            }
                        }, 300);
                        
                    } catch (loginError) {
                        console.error('登入後處理錯誤:', loginError);
                        alert('登入成功，但資料處理發生錯誤。請重新整理頁面。錯誤：' + loginError.message);
                    }
                } else {
                    alert('錯誤：' + result.error);
                }
            } catch (error) {
                console.error('Firebase 錯誤:', error);
                alert('系統錯誤，請稍後再試');
            } finally {
                // 恢復按鈕狀態
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // 防止在管理員帳號建立期間觸發跳轉
        let isCreatingAdmin = false;
        
        // 檢查是否已經登入
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user && !isCreatingAdmin) {
                // 短暫延遲，避免在帳號建立過程中跳轉
                setTimeout(async () => {
                    if (window.firebaseService.auth.currentUser) {
                        // 使用者已登入，根據角色決定跳轉位置
                        try {
                            // 先取得使用者角色，如果沒有則檢查是否為學生
                            const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                            let userData = userDoc.data();
                            let userRole = userData?.role;
                            
                            // 如果沒有角色資訊，檢查是否為學生
                            if (!userRole) {
                                try {
                                    const studentDoc = await firebase.firestore().collection('students').doc(user.uid).get();
                                    if (studentDoc.exists) {
                                        userRole = 'student';
                                        console.log('✅ 從 students 集合檢測到學生身份');
                                    } else {
                                        // 預設為教師
                                        userRole = 'teacher';
                                        console.log('⚠️ 未找到使用者記錄，根據 email 設定角色:', userRole);
                                    }
                                } catch (error) {
                                    console.warn('檢查學生記錄錯誤，使用預設角色:', error);
                                    userRole = 'teacher';
                                }
                            }
                            
                            if (userRole === 'teacher') {
                                console.log('教師已登入，跳轉到學生管理頁面');
                                window.location.href = 'student-management.html';
                            } else if (userRole === 'student') {
                                // 學生用戶：檢查是否有關聯教師的資料
                                console.log('學生已登入，檢查教師資料...');
                                
                                try {
                                    // 使用新的 getTeacherDataForStudent 方法
                                    const teacherDataResult = await window.firebaseService.getTeacherDataForStudent(user.uid);
                                    
                                    if (teacherDataResult.success) {
                                        // 儲存教師資訊和學生資訊到 sessionStorage
                                        sessionStorage.setItem('teacherId', teacherDataResult.teacherId);
                                        sessionStorage.setItem('teacherName', teacherDataResult.teacherInfo?.name || '教師');
                                        sessionStorage.setItem('isStudentMode', 'true');
                                        sessionStorage.setItem('studentId', user.uid);
                                        sessionStorage.setItem('studentName', teacherDataResult.studentInfo?.name || '學生');
                                        sessionStorage.setItem('studentNumber', teacherDataResult.studentInfo?.studentNumber || '');
                                        
                                        // 學生總是跳轉到追蹤頁面
                                        console.log('學生已登入，跳轉到追蹤頁面（學生模式）');
                                        window.location.href = 'tracking.html';
                                    } else {
                                        console.log('學生帳號設定錯誤:', teacherDataResult.error);
                                        window.location.href = 'import.html';
                                    }
                                } catch (error) {
                                    console.warn('檢查學生教師資料錯誤:', error);
                                    window.location.href = 'import.html';
                                }
                            } else {
                                // 一般使用者檢查是否有完整資料
                                const userDataResult = await firebase.firestore().collection('userData').doc(user.uid).get();
                                
                                if (userDataResult.exists && userDataResult.data()?.cleaningTasks?.length > 0 && userDataResult.data()?.assignments) {
                                    console.log('用戶已登入且有完整資料，跳轉到追蹤頁面');
                                    window.location.href = 'tracking.html';
                                } else {
                                    console.log('用戶已登入但沒有完整資料，跳轉到匯入頁面');
                                    window.location.href = 'import.html';
                                }
                            }
                        } catch (error) {
                            console.warn('檢查現有資料時發生錯誤，預設跳轉到匯入頁面:', error);
                            window.location.href = 'import.html';
                        }
                    }
                }, 500);
            }
        });
        
        // 開發模式：顯示示範帳號（如果存在）
        setTimeout(() => {
            document.getElementById('demo-accounts').style.display = 'block';
        }, 2000);
    </script>
</body>
</html>