<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“æƒè¿½è¹¤ç³»çµ± - ç™»å…¥</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <h1>ğŸ§¹ æ‰“æƒè¿½è¹¤ç³»çµ±</h1>
            <form id="loginForm">
                <div class="input-group">
                    <label for="email">é›»å­ä¿¡ç®±</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="input-group">
                    <label for="password">å¯†ç¢¼</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">ç™»å…¥</button>
            </form>
            <div class="auth-options">
                <button type="button" id="googleLoginBtn" class="google-btn">ğŸ” Google ç™»å…¥</button>
            </div>
            
            <div class="user-info">
                <h3>ğŸ”¥ Firebase é›²ç«¯å¸³è™Ÿ</h3>
                <p>ğŸ” æ¨è–¦ä½¿ç”¨ Google å¸³è™Ÿå¿«é€Ÿç™»å…¥</p>
                <p>ğŸ“§ æˆ–ä½¿ç”¨é›»å­ä¿¡ç®±å’Œå¯†ç¢¼ç™»å…¥</p>
            </div>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple-public.js"></script>
    
    <script>
        // ç­‰å¾…é é¢å’Œ Firebase å®Œå…¨è¼‰å…¥
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆ');
            
            // æª¢æŸ¥ Firebase æœå‹™æ˜¯å¦è¼‰å…¥
            setTimeout(() => {
                if (window.firebaseService) {
                    console.log('âœ… Firebase æœå‹™å·²è¼‰å…¥');
                    console.log('å¯ç”¨æ–¹æ³•:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.firebaseService)));
                } else {
                    console.error('âŒ Firebase æœå‹™æœªè¼‰å…¥');
                }
            }, 100);
        });
        
        // Google ç™»å…¥è™•ç†
        document.getElementById('googleLoginBtn').addEventListener('click', async function() {
            const btn = document.getElementById('googleLoginBtn');
            const originalText = btn.textContent;
            btn.textContent = 'è™•ç†ä¸­...';
            btn.disabled = true;
            
            try {
                // æª¢æŸ¥ firebaseService æ˜¯å¦å­˜åœ¨
                if (!window.firebaseService) {
                    throw new Error('Firebase æœå‹™å°šæœªè¼‰å…¥ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
                
                // æª¢æŸ¥ signInWithGoogle æ–¹æ³•æ˜¯å¦å­˜åœ¨
                if (typeof window.firebaseService.signInWithGoogle !== 'function') {
                    console.error('firebaseService æ–¹æ³•:', Object.keys(window.firebaseService));
                    throw new Error('signInWithGoogle æ–¹æ³•ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥ Firebase è¨­å®š');
                }
                
                const result = await window.firebaseService.signInWithGoogle();
                
                if (result.success) {
                    console.log('Google ç™»å…¥æˆåŠŸ:', result.user.email);
                    
                    // å„²å­˜ä½¿ç”¨è€…è³‡è¨Šåˆ° sessionStorage
                    sessionStorage.setItem('currentUser', result.user.uid);
                    sessionStorage.setItem('userEmail', result.user.email);
                    sessionStorage.setItem('userRole', 'teacher'); // Google ç”¨æˆ¶é è¨­ç‚º teacher
                    sessionStorage.setItem('userName', result.user.displayName || result.user.email);
                    
                    // æ ¹æ“šä½¿ç”¨è€…è³‡æ–™æ±ºå®šè·³è½‰
                    setTimeout(async () => {
                        try {
                            const userDataResult = await firebase.firestore().collection('userData').doc(result.user.uid).get();
                            
                            if (userDataResult.exists && userDataResult.data()?.cleaningTasks?.length > 0 && userDataResult.data()?.assignments) {
                                console.log('Google ç”¨æˆ¶æœ‰å®Œæ•´è³‡æ–™ï¼Œè·³è½‰åˆ°è¿½è¹¤é é¢');
                                window.location.href = 'tracking.html';
                            } else {
                                console.log('Google ç”¨æˆ¶ç„¡å®Œæ•´è³‡æ–™ï¼Œè·³è½‰åˆ°åŒ¯å…¥é é¢');
                                window.location.href = 'import.html';
                            }
                        } catch (error) {
                            console.warn('ç„¡æ³•æª¢æŸ¥ç¾æœ‰è³‡æ–™:', error);
                            window.location.href = 'import.html';
                        }
                    }, 300);
                } else {
                    alert('Google ç™»å…¥å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                console.error('Google ç™»å…¥éŒ¯èª¤:', error);
                alert('Google ç™»å…¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });
        
        // è¡¨å–®æäº¤è™•ç†
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const submitBtn = document.querySelector('.login-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'è™•ç†ä¸­...';
            submitBtn.disabled = true;
            
            try {
                let result;
                
                // ç™»å…¥ä½¿ç”¨è€…
                result = await window.firebaseService.signIn(email, password);
                
                if (result.success) {
                    try {
                        console.log('ä½¿ç”¨è€…ç™»å…¥æˆåŠŸ:', result.user.email);
                        
                        // å˜—è©¦å–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å»ºç«‹
                        let userData = null;
                        try {
                            const userDoc = await firebase.firestore().collection('users').doc(result.user.uid).get();
                            userData = userDoc.data();
                            
                            console.log('ğŸ” ç™»å…¥æ™‚æª¢æŸ¥ä½¿ç”¨è€…è³‡æ–™:', {
                                uid: result.user.uid,
                                email: result.user.email,
                                userDocExists: userDoc.exists,
                                userData: userData,
                                userRole: userData?.role
                            });
                            
                            // å¦‚æœä½¿ç”¨è€…è³‡æ–™ä¸å­˜åœ¨ï¼Œå»ºç«‹é è¨­è³‡æ–™
                            if (!userData) {
                                console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ° users è¨˜éŒ„ï¼Œå»ºç«‹æ–°ä½¿ç”¨è€…è³‡æ–™...');
                                
                                // æª¢æŸ¥æ˜¯å¦ç‚ºå­¸ç”Ÿï¼šå…ˆæŸ¥è©¢ students é›†åˆ
                                let role = 'teacher'; // é è¨­ç‚ºæ•™å¸«
                                let name = 'ä½¿ç”¨è€…';
                                
                                {
                                    // æª¢æŸ¥æ˜¯å¦åœ¨ students é›†åˆä¸­
                                    try {
                                        const studentDoc = await firebase.firestore().collection('students').doc(result.user.uid).get();
                                        if (studentDoc.exists) {
                                            role = 'student';
                                            name = studentDoc.data().name || 'å­¸ç”Ÿ';
                                            console.log('âœ… æª¢æ¸¬åˆ°å­¸ç”Ÿè¨˜éŒ„ï¼Œè§’è‰²è¨­ç‚º student');
                                        } else {
                                            console.log('âš ï¸ æœªæ‰¾åˆ°å­¸ç”Ÿè¨˜éŒ„ï¼Œè§’è‰²è¨­ç‚º teacher');
                                        }
                                    } catch (error) {
                                        console.warn('æª¢æŸ¥å­¸ç”Ÿè¨˜éŒ„éŒ¯èª¤ï¼Œä½¿ç”¨é è¨­è§’è‰² teacher:', error);
                                    }
                                }
                                
                                userData = {
                                    email: result.user.email,
                                    role: role,
                                    name: name,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                
                                await firebase.firestore().collection('users').doc(result.user.uid).set(userData);
                                console.log('ä½¿ç”¨è€…è³‡æ–™å»ºç«‹å®Œæˆï¼Œè§’è‰²:', userData.role);
                            }
                        } catch (firestoreError) {
                            console.warn('Firestore å­˜å–éŒ¯èª¤ï¼Œä½¿ç”¨é è¨­è³‡æ–™:', firestoreError);
                            // å¦‚æœ Firestore æœ‰å•é¡Œï¼Œä½¿ç”¨é è¨­è³‡æ–™
                            userData = {
                                email: result.user.email,
                                role: 'user',
                                name: 'ä½¿ç”¨è€…'
                            };
                        }
                        
                        // å„²å­˜ä½¿ç”¨è€…è³‡è¨Šåˆ° sessionStorage
                        sessionStorage.setItem('currentUser', result.user.uid);
                        sessionStorage.setItem('userEmail', result.user.email);
                        sessionStorage.setItem('userRole', userData.role || 'user');
                        sessionStorage.setItem('userName', userData.name || result.user.email);
                        
                        console.log('ä½¿ç”¨è€…è³‡è¨Šå·²å„²å­˜ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™...');
                        
                        // æ ¹æ“šä½¿ç”¨è€…è§’è‰²æ±ºå®šè·³è½‰ç›®æ¨™
                        setTimeout(async () => {
                            try {
                                const userRole = userData.role || 'user';
                                
                                if (userRole === 'teacher') {
                                    // æ•™å¸«è·³è½‰åˆ°å­¸ç”Ÿç®¡ç†é é¢
                                    console.log('æ•™å¸«ç™»å…¥ï¼Œè·³è½‰åˆ°å­¸ç”Ÿç®¡ç†é é¢');
                                    window.location.href = 'student-management.html';
                                } else if (userRole === 'student') {
                                    // å­¸ç”Ÿç”¨æˆ¶ï¼šæª¢æŸ¥æ˜¯å¦æœ‰é—œè¯æ•™å¸«çš„è³‡æ–™
                                    console.log('å­¸ç”Ÿç™»å…¥ï¼Œæª¢æŸ¥æ•™å¸«è³‡æ–™...');
                                    
                                    try {
                                        // ä½¿ç”¨æ–°çš„ getTeacherDataForStudent æ–¹æ³•
                                        const teacherDataResult = await window.firebaseService.getTeacherDataForStudent(result.user.uid);
                                        
                                        if (teacherDataResult.success) {
                                            console.log('æ‰¾åˆ°é—œè¯æ•™å¸«:', teacherDataResult.teacherId);
                                            console.log('å­¸ç”Ÿè³‡è¨Š:', teacherDataResult.studentInfo);
                                            
                                            // å„²å­˜æ•™å¸«è³‡è¨Šå’Œå­¸ç”Ÿè³‡è¨Šåˆ° sessionStorage ä¾›å…¶ä»–é é¢ä½¿ç”¨
                                            sessionStorage.setItem('teacherId', teacherDataResult.teacherId);
                                            sessionStorage.setItem('teacherName', teacherDataResult.teacherInfo?.name || 'æ•™å¸«');
                                            sessionStorage.setItem('isStudentMode', 'true');
                                            sessionStorage.setItem('studentId', result.user.uid);
                                            sessionStorage.setItem('studentName', teacherDataResult.studentInfo?.name || 'å­¸ç”Ÿ');
                                            sessionStorage.setItem('studentNumber', teacherDataResult.studentInfo?.studentNumber || '');
                                            
                                            // å­¸ç”Ÿç¸½æ˜¯è·³è½‰åˆ°è¿½è¹¤é é¢ï¼Œä¸ç®¡æ•™å¸«æ˜¯å¦æœ‰è³‡æ–™
                                            console.log('å­¸ç”Ÿç™»å…¥æˆåŠŸï¼Œè·³è½‰åˆ°è¿½è¹¤é é¢ï¼ˆå­¸ç”Ÿæ¨¡å¼ï¼‰');
                                            window.location.href = 'tracking.html';
                                        } else {
                                            console.log('å­¸ç”Ÿæ²’æœ‰é—œè¯æ•™å¸«ï¼ŒéŒ¯èª¤:', teacherDataResult.error);
                                            alert('å­¸ç”Ÿå¸³è™Ÿè¨­å®šéŒ¯èª¤ï¼š' + teacherDataResult.error + '\nè«‹è¯çµ¡æ•™å¸«ç¢ºèªå¸³è™Ÿè¨­å®šã€‚');
                                            // æ¸…é™¤éŒ¯èª¤çš„ç™»å…¥ç‹€æ…‹
                                            await window.firebaseService.signOut();
                                            sessionStorage.clear();
                                            return;
                                        }
                                    } catch (error) {
                                        console.warn('æª¢æŸ¥å­¸ç”Ÿæ•™å¸«è³‡æ–™éŒ¯èª¤:', error);
                                        alert('æª¢æŸ¥æ•™å¸«è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚');
                                        window.location.href = 'import.html';
                                    }
                                } else {
                                    // ä¸€èˆ¬ä½¿ç”¨è€…æª¢æŸ¥æ˜¯å¦å·²æœ‰è³‡æ–™
                                    const userDataResult = await firebase.firestore().collection('userData').doc(result.user.uid).get();
                                    
                                    if (userDataResult.exists && userDataResult.data()?.cleaningTasks?.length > 0 && userDataResult.data()?.assignments) {
                                        console.log('åµæ¸¬åˆ°å®Œæ•´è³‡æ–™ï¼ˆåŒ…å«åˆ†é…ï¼‰ï¼Œè·³è½‰åˆ°è¿½è¹¤é é¢');
                                        window.location.href = 'tracking.html';
                                    } else {
                                        console.log('æœªåµæ¸¬åˆ°å®Œæ•´è³‡æ–™ï¼Œè·³è½‰åˆ°åŒ¯å…¥é é¢');
                                        window.location.href = 'import.html';
                                    }
                                }
                            } catch (error) {
                                console.warn('ç„¡æ³•æª¢æŸ¥ç¾æœ‰è³‡æ–™:', error);
                                // é è¨­è¡Œç‚ºï¼šæ•™å¸«åˆ°å­¸ç”Ÿç®¡ç†ï¼Œå…¶ä»–åˆ°åŒ¯å…¥
                                if (userData.role === 'teacher') {
                                    window.location.href = 'student-management.html';
                                } else {
                                    window.location.href = 'import.html';
                                }
                            }
                        }, 300);
                        
                    } catch (loginError) {
                        console.error('ç™»å…¥å¾Œè™•ç†éŒ¯èª¤:', loginError);
                        alert('ç™»å…¥æˆåŠŸï¼Œä½†è³‡æ–™è™•ç†ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹é‡æ–°æ•´ç†é é¢ã€‚éŒ¯èª¤ï¼š' + loginError.message);
                    }
                } else {
                    alert('éŒ¯èª¤ï¼š' + result.error);
                }
            } catch (error) {
                console.error('Firebase éŒ¯èª¤:', error);
                alert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // é˜²æ­¢åœ¨ç®¡ç†å“¡å¸³è™Ÿå»ºç«‹æœŸé–“è§¸ç™¼è·³è½‰
        let isCreatingAdmin = false;
        
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç™»å…¥
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user && !isCreatingAdmin) {
                // çŸ­æš«å»¶é²ï¼Œé¿å…åœ¨å¸³è™Ÿå»ºç«‹éç¨‹ä¸­è·³è½‰
                setTimeout(async () => {
                    if (window.firebaseService.auth.currentUser) {
                        // ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œæ ¹æ“šè§’è‰²æ±ºå®šè·³è½‰ä½ç½®
                        try {
                            // å…ˆå–å¾—ä½¿ç”¨è€…è§’è‰²ï¼Œå¦‚æœæ²’æœ‰å‰‡æª¢æŸ¥æ˜¯å¦ç‚ºå­¸ç”Ÿ
                            const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                            let userData = userDoc.data();
                            let userRole = userData?.role;
                            
                            // å¦‚æœæ²’æœ‰è§’è‰²è³‡è¨Šï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºå­¸ç”Ÿ
                            if (!userRole) {
                                try {
                                    const studentDoc = await firebase.firestore().collection('students').doc(user.uid).get();
                                    if (studentDoc.exists) {
                                        userRole = 'student';
                                        console.log('âœ… å¾ students é›†åˆæª¢æ¸¬åˆ°å­¸ç”Ÿèº«ä»½');
                                    } else {
                                        // é è¨­ç‚ºæ•™å¸«
                                        userRole = 'teacher';
                                        console.log('âš ï¸ æœªæ‰¾åˆ°ä½¿ç”¨è€…è¨˜éŒ„ï¼Œæ ¹æ“š email è¨­å®šè§’è‰²:', userRole);
                                    }
                                } catch (error) {
                                    console.warn('æª¢æŸ¥å­¸ç”Ÿè¨˜éŒ„éŒ¯èª¤ï¼Œä½¿ç”¨é è¨­è§’è‰²:', error);
                                    userRole = 'teacher';
                                }
                            }
                            
                            if (userRole === 'teacher') {
                                console.log('æ•™å¸«å·²ç™»å…¥ï¼Œè·³è½‰åˆ°å­¸ç”Ÿç®¡ç†é é¢');
                                window.location.href = 'student-management.html';
                            } else if (userRole === 'student') {
                                // å­¸ç”Ÿç”¨æˆ¶ï¼šæª¢æŸ¥æ˜¯å¦æœ‰é—œè¯æ•™å¸«çš„è³‡æ–™
                                console.log('å­¸ç”Ÿå·²ç™»å…¥ï¼Œæª¢æŸ¥æ•™å¸«è³‡æ–™...');
                                
                                try {
                                    // ä½¿ç”¨æ–°çš„ getTeacherDataForStudent æ–¹æ³•
                                    const teacherDataResult = await window.firebaseService.getTeacherDataForStudent(user.uid);
                                    
                                    if (teacherDataResult.success) {
                                        // å„²å­˜æ•™å¸«è³‡è¨Šå’Œå­¸ç”Ÿè³‡è¨Šåˆ° sessionStorage
                                        sessionStorage.setItem('teacherId', teacherDataResult.teacherId);
                                        sessionStorage.setItem('teacherName', teacherDataResult.teacherInfo?.name || 'æ•™å¸«');
                                        sessionStorage.setItem('isStudentMode', 'true');
                                        sessionStorage.setItem('studentId', user.uid);
                                        sessionStorage.setItem('studentName', teacherDataResult.studentInfo?.name || 'å­¸ç”Ÿ');
                                        sessionStorage.setItem('studentNumber', teacherDataResult.studentInfo?.studentNumber || '');
                                        
                                        // å­¸ç”Ÿç¸½æ˜¯è·³è½‰åˆ°è¿½è¹¤é é¢
                                        console.log('å­¸ç”Ÿå·²ç™»å…¥ï¼Œè·³è½‰åˆ°è¿½è¹¤é é¢ï¼ˆå­¸ç”Ÿæ¨¡å¼ï¼‰');
                                        window.location.href = 'tracking.html';
                                    } else {
                                        console.log('å­¸ç”Ÿå¸³è™Ÿè¨­å®šéŒ¯èª¤:', teacherDataResult.error);
                                        window.location.href = 'import.html';
                                    }
                                } catch (error) {
                                    console.warn('æª¢æŸ¥å­¸ç”Ÿæ•™å¸«è³‡æ–™éŒ¯èª¤:', error);
                                    window.location.href = 'import.html';
                                }
                            } else {
                                // ä¸€èˆ¬ä½¿ç”¨è€…æª¢æŸ¥æ˜¯å¦æœ‰å®Œæ•´è³‡æ–™
                                const userDataResult = await firebase.firestore().collection('userData').doc(user.uid).get();
                                
                                if (userDataResult.exists && userDataResult.data()?.cleaningTasks?.length > 0 && userDataResult.data()?.assignments) {
                                    console.log('ç”¨æˆ¶å·²ç™»å…¥ä¸”æœ‰å®Œæ•´è³‡æ–™ï¼Œè·³è½‰åˆ°è¿½è¹¤é é¢');
                                    window.location.href = 'tracking.html';
                                } else {
                                    console.log('ç”¨æˆ¶å·²ç™»å…¥ä½†æ²’æœ‰å®Œæ•´è³‡æ–™ï¼Œè·³è½‰åˆ°åŒ¯å…¥é é¢');
                                    window.location.href = 'import.html';
                                }
                            }
                        } catch (error) {
                            console.warn('æª¢æŸ¥ç¾æœ‰è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œé è¨­è·³è½‰åˆ°åŒ¯å…¥é é¢:', error);
                            window.location.href = 'import.html';
                        }
                    }
                }, 500);
            }
        });
        
        // é–‹ç™¼æ¨¡å¼ï¼šé¡¯ç¤ºç¤ºç¯„å¸³è™Ÿï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        setTimeout(() => {
            document.getElementById('demo-accounts').style.display = 'block';
        }, 2000);
    </script>
</body>
</html>