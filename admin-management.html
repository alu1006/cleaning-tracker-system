<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“æƒè¿½è¹¤ç³»çµ± - ç®¡ç†å“¡é¢æ¿</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>ğŸ”‘ ç®¡ç†å“¡é¢æ¿</h1>
            <div class="nav-user">
                <span id="userInfo"></span>
                <button onclick="goToImport()" class="secondary-btn">ğŸ“‹ åŒ¯å…¥è³‡æ–™</button>
                <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="admin-header">
            <h2>ğŸ‘¨â€ğŸ« è€å¸«å¸³è™Ÿç®¡ç†</h2>
            <div class="info-box" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                <p><strong>ğŸ”‘ ç®¡ç†å“¡æ¬Šé™ï¼š</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>ğŸ“Š æŸ¥çœ‹æ‰€æœ‰è€å¸«çš„å¸³è™Ÿè³‡æ–™å’Œæ‰“æƒè¨­å®š</li>
                    <li>ğŸ‘¥ ç›£æ§æ¯ä½è€å¸«ç®¡ç†çš„å­¸ç”Ÿæ•¸é‡</li>
                    <li>ğŸ” æª¢è¦–å­¸ç”Ÿç¸½è¦½å’Œåˆ†é…ç‹€æ³</li>
                    <li>ğŸ› ï¸ å”åŠ©è€å¸«è§£æ±ºå¸³è™Ÿå’Œæ¬Šé™å•é¡Œ</li>
                </ul>
            </div>
            <div class="admin-stats">
                <div class="stat-card">
                    <span class="stat-number" id="teacherCount">0</span>
                    <span class="stat-label">è€å¸«ç¸½æ•¸</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="studentCount">0</span>
                    <span class="stat-label">å­¸ç”Ÿç¸½æ•¸</span>
                </div>
            </div>
        </div>

        <div class="teacher-management">
            <div class="section-header">
                <h3>ğŸ“‹ æ‰€æœ‰è€å¸«åˆ—è¡¨</h3>
                <button onclick="refreshData()" class="secondary-btn">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
            
            <div id="teachersList" class="teachers-list">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <div class="student-overview">
            <div class="section-header">
                <h3>ğŸ‘¨â€ğŸ“ å­¸ç”Ÿç¸½è¦½</h3>
                <select id="teacherFilter" onchange="filterStudents()">
                    <option value="">æ‰€æœ‰è€å¸«çš„å­¸ç”Ÿ</option>
                </select>
            </div>
            
            <div id="studentsList" class="students-list">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple-public.js"></script>
    <script src="firestore-service.js"></script>
    
    <script>
        let currentUser = null;
        let userRole = null;
        let allTeachers = {};
        let allStudents = {};

        // Firebase é©—è­‰ç‹€æ…‹ç›£è½
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserInfo();
            } else {
                window.location.href = 'index.html';
            }
        });

        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šä¸¦æª¢æŸ¥æ¬Šé™
        async function loadUserInfo() {
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                userRole = userData?.role || 'student';
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                if (userRole !== 'admin') {
                    alert('âŒ æ­¤é é¢åƒ…é™ç®¡ç†å“¡å­˜å–');
                    window.location.href = 'index.html';
                    return;
                }

                document.getElementById('userInfo').textContent = 
                    `${userData?.name || currentUser.email} (ç®¡ç†å“¡)`;
                
                // è¼‰å…¥æ‰€æœ‰è³‡æ–™
                await loadAllData();
                
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:', error);
                alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
                window.location.href = 'index.html';
            }
        }

        // è¼‰å…¥æ‰€æœ‰è€å¸«å’Œå­¸ç”Ÿè³‡æ–™
        async function loadAllData() {
            try {
                // è¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…
                const usersSnapshot = await window.firebaseService.db.collection('users').get();
                const teachers = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.role === 'teacher') {
                        allTeachers[doc.id] = {
                            id: doc.id,
                            ...userData
                        };
                        teachers.push(allTeachers[doc.id]);
                    }
                });

                // è¼‰å…¥æ‰€æœ‰å­¸ç”Ÿ
                const studentsSnapshot = await window.firebaseService.db.collection('students').get();
                allStudents = {};
                
                studentsSnapshot.forEach(doc => {
                    allStudents[doc.id] = {
                        id: doc.id,
                        ...doc.data()
                    };
                });

                // æ›´æ–°çµ±è¨ˆå’Œåˆ—è¡¨
                updateStats();
                displayTeachers(teachers);
                displayStudents();
                updateTeacherFilter();
                
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
                alert('è¼‰å…¥è³‡æ–™å¤±æ•—');
            }
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            const teacherCount = Object.keys(allTeachers).length;
            const studentCount = Object.keys(allStudents).length;
            
            document.getElementById('teacherCount').textContent = teacherCount;
            document.getElementById('studentCount').textContent = studentCount;
        }

        // é¡¯ç¤ºè€å¸«åˆ—è¡¨
        function displayTeachers(teachers) {
            const container = document.getElementById('teachersList');
            
            if (teachers.length === 0) {
                container.innerHTML = '<div class="no-data">ğŸ“ å°šç„¡è€å¸«å¸³è™Ÿ</div>';
                return;
            }

            const teachersHTML = teachers.map(teacher => {
                const studentCount = Object.values(allStudents).filter(s => s.teacherId === teacher.id).length;
                
                return `
                    <div class="teacher-card">
                        <div class="teacher-info">
                            <h4>ğŸ‘¨â€ğŸ« ${teacher.name || 'æœªå‘½å'}</h4>
                            <p>ğŸ“§ ${teacher.email}</p>
                            <p>ğŸ‘¨â€ğŸ“ ç®¡ç†å­¸ç”Ÿ: ${studentCount} äºº</p>
                            <p>ğŸ“… å»ºç«‹æ™‚é–“: ${teacher.createdAt ? new Date(teacher.createdAt.toDate()).toLocaleDateString() : 'æœªçŸ¥'}</p>
                        </div>
                        <div class="teacher-actions">
                            <button onclick="viewTeacherStudents('${teacher.id}')" class="primary-btn">æŸ¥çœ‹å­¸ç”Ÿ</button>
                            <button onclick="viewTeacherData('${teacher.id}')" class="secondary-btn">æŸ¥çœ‹è³‡æ–™</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = teachersHTML;
        }

        // é¡¯ç¤ºå­¸ç”Ÿåˆ—è¡¨
        function displayStudents(filterTeacherId = null) {
            const container = document.getElementById('studentsList');
            let studentsToShow = Object.values(allStudents);
            
            if (filterTeacherId) {
                studentsToShow = studentsToShow.filter(s => s.teacherId === filterTeacherId);
            }
            
            if (studentsToShow.length === 0) {
                container.innerHTML = '<div class="no-data">ğŸ“ æ²’æœ‰å­¸ç”Ÿè³‡æ–™</div>';
                return;
            }

            const studentsHTML = studentsToShow.map(student => {
                const teacher = allTeachers[student.teacherId];
                const teacherName = teacher ? teacher.name || teacher.email : 'æœªçŸ¥è€å¸«';
                
                return `
                    <div class="student-card compact">
                        <div class="student-info">
                            <h5>ğŸ‘¨â€ğŸ“ ${student.name || 'æœªå‘½å'}</h5>
                            <p>ğŸ†” ${student.studentNumber || 'ç„¡å­¸è™Ÿ'}</p>
                            <p>ğŸ“§ ${student.email}</p>
                            <p>ğŸ‘¨â€ğŸ« è€å¸«: ${teacherName}</p>
                        </div>
                        <div class="student-status">
                            <span class="status-badge status-${student.status || 'active'}">
                                ${student.status === 'active' ? 'æ´»èº' : 'åœç”¨'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = studentsHTML;
        }

        // æ›´æ–°è€å¸«éæ¿¾å™¨
        function updateTeacherFilter() {
            const select = document.getElementById('teacherFilter');
            select.innerHTML = '<option value="">æ‰€æœ‰è€å¸«çš„å­¸ç”Ÿ</option>';
            
            Object.values(allTeachers).forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = `${teacher.name || teacher.email}`;
                select.appendChild(option);
            });
        }

        // éæ¿¾å­¸ç”Ÿ
        function filterStudents() {
            const teacherId = document.getElementById('teacherFilter').value;
            displayStudents(teacherId || null);
        }

        // æŸ¥çœ‹ç‰¹å®šè€å¸«çš„å­¸ç”Ÿ
        function viewTeacherStudents(teacherId) {
            const teacherFilter = document.getElementById('teacherFilter');
            teacherFilter.value = teacherId;
            filterStudents();
            
            // æ»¾å‹•åˆ°å­¸ç”Ÿå€åŸŸ
            document.querySelector('.student-overview').scrollIntoView({ behavior: 'smooth' });
        }

        // æŸ¥çœ‹è€å¸«è³‡æ–™
        async function viewTeacherData(teacherId) {
            try {
                const result = await window.firebaseService.loadUserData(teacherId);
                if (result.success && result.data) {
                    const teacher = allTeachers[teacherId];
                    const hasData = result.data.cleaningTasks && result.data.cleaningTasks.length > 0;
                    
                    alert(`ğŸ‘¨â€ğŸ« ${teacher.name || teacher.email}\n\n` +
                          `ğŸ“‹ æ‰“æƒäº‹é …: ${result.data.cleaningTasks?.length || 0} é …\n` +
                          `ğŸ‘¥ å­¸ç”Ÿåˆ†é…: ${Object.keys(result.data.assignments || {}).length} çµ„\n` +
                          `ğŸ“Š è³‡æ–™ç‹€æ…‹: ${hasData ? 'å·²è¨­å®š' : 'æœªè¨­å®š'}\n` +
                          `ğŸ“… æœ€å¾Œæ›´æ–°: ${result.data.lastUpdate ? new Date(result.data.lastUpdate.toDate()).toLocaleString() : 'ç„¡'}`);
                } else {
                    alert('è©²è€å¸«å°šæœªè¨­å®šæ‰“æƒè³‡æ–™');
                }
            } catch (error) {
                console.error('è¼‰å…¥è€å¸«è³‡æ–™éŒ¯èª¤:', error);
                alert('è¼‰å…¥è³‡æ–™å¤±æ•—');
            }
        }

        // é‡æ–°æ•´ç†è³‡æ–™
        async function refreshData() {
            document.getElementById('teachersList').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            document.getElementById('studentsList').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            await loadAllData();
        }

        // å°èˆªå‡½æ•¸
        function goToImport() {
            window.location.href = 'import.html';
        }

        async function logout() {
            try {
                await window.firebaseService.signOut();
                sessionStorage.clear();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
    </script>
</body>
</html>