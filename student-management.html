<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç®¡ç† - æ‰“æƒè¿½è¹¤ç³»çµ±</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>ğŸ§¹ æ‰“æƒè¿½è¹¤ç³»çµ±</h1>
            <div class="nav-user">
                <span id="userInfo"></span>
                <button onclick="goToTracking()" class="secondary-btn">ğŸ“‹ è¿½è¹¤é é¢</button>
                <button onclick="goToImport()" class="secondary-btn">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
                <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="tracking-header">
            <h2>ğŸ“ æˆ‘çš„å­¸ç”Ÿå¸³è™Ÿç®¡ç†</h2>
            <button id="addStudentBtn" class="primary-btn">â• æ–°å¢å­¸ç”Ÿå¸³è™Ÿ</button>
        </div>

        <div class="step-container">
            <h3>ğŸ“Š å­¸ç”Ÿçµ±è¨ˆ</h3>
            <div class="stats-section">
                <div class="stat-card">
                    <h3 id="totalStudents">0</h3>
                    <p>å­¸ç”Ÿç¸½æ•¸</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeStudents">0</h3>
                    <p>æ´»èºå­¸ç”Ÿ</p>
                </div>
                <div class="stat-card">
                    <h3 id="studentsWithData">0</h3>
                    <p>æœ‰è³‡æ–™å­¸ç”Ÿ</p>
                </div>
            </div>
        </div>

        <div class="step-container">
            <h3>ğŸ‘¥ å­¸ç”Ÿåˆ—è¡¨</h3>
            <div class="tracking-table-container">
                <table id="studentsTable" class="tracking-table">
                    <thead>
                        <tr>
                            <th>å­¸ç”Ÿå§“å</th>
                            <th>å­¸è™Ÿ</th>
                            <th>é›»å­ä¿¡ç®±</th>
                            <th>ç‹€æ…‹</th>
                            <th>å»ºç«‹æ™‚é–“</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ–°å¢å­¸ç”Ÿæ¨¡æ…‹æ¡† -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• æ–°å¢å­¸ç”Ÿå¸³è™Ÿ</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div class="input-group">
                        <label for="studentName">å­¸ç”Ÿå§“å *</label>
                        <input type="text" id="studentName" required placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å">
                        <small class="error-message" id="nameError" style="display: none;"></small>
                    </div>
                    
                    <div class="input-group">
                        <label for="studentNumber">å­¸è™Ÿ</label>
                        <input type="text" id="studentNumber" placeholder="é¸å¡«ï¼Œä¾‹å¦‚ï¼š412101">
                        <small class="info-message">å­¸è™Ÿæœƒé¡¯ç¤ºåœ¨ç³»çµ±ä¸­ï¼Œä¾¿æ–¼è­˜åˆ¥</small>
                    </div>
                    
                    <div class="input-group">
                        <label for="studentEmail">é›»å­ä¿¡ç®± *</label>
                        <input type="email" id="studentEmail" required placeholder="student@example.com">
                        <small class="info-message">å­¸ç”Ÿå°‡ä½¿ç”¨æ­¤ä¿¡ç®±ç™»å…¥ç³»çµ±</small>
                        <small class="error-message" id="emailError" style="display: none;"></small>
                    </div>
                    
                    <div class="input-group">
                        <label for="studentPassword">åˆå§‹å¯†ç¢¼ *</label>
                        <div class="password-input">
                            <input type="password" id="studentPassword" required placeholder="ç³»çµ±å°‡è‡ªå‹•ç”Ÿæˆå®‰å…¨å¯†ç¢¼">
                            <button type="button" id="generatePasswordBtn" class="generate-btn">ğŸ² ç”Ÿæˆå¯†ç¢¼</button>
                            <button type="button" id="togglePasswordBtn" class="toggle-btn">ğŸ‘ï¸</button>
                        </div>
                        <small class="info-message">å»ºè­°å­¸ç”Ÿé¦–æ¬¡ç™»å…¥å¾Œä¿®æ”¹å¯†ç¢¼</small>
                        <div class="password-strength" id="passwordStrength" style="display: none;"></div>
                    </div>
                    
                    <div class="form-summary" id="formSummary" style="display: none;">
                        <h4>ğŸ“ å¸³è™Ÿè³‡è¨Šç¢ºèª</h4>
                        <div class="summary-item">
                            <span>å§“åï¼š</span><span id="summaryName"></span>
                        </div>
                        <div class="summary-item">
                            <span>å­¸è™Ÿï¼š</span><span id="summaryNumber"></span>
                        </div>
                        <div class="summary-item">
                            <span>ä¿¡ç®±ï¼š</span><span id="summaryEmail"></span>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn">å–æ¶ˆ</button>
                        <button type="submit" class="primary-btn" id="submitBtn">
                            <span class="btn-text">å»ºç«‹å¸³è™Ÿ</span>
                            <span class="btn-loading" style="display: none;">
                                <span class="spinner"></span> å»ºç«‹ä¸­...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple.js"></script>
    
    <script>
        let currentUser = null;
        let userRole = null;
        let students = [];
        
        // å…¨å±€è®Šæ•¸ï¼Œä¾›è¡¨å–®è™•ç†ä½¿ç”¨
        let modal = null;

        // ç«‹å³åŸ·è¡Œå‚™ç”¨åˆå§‹åŒ–æ–¹æ³•
        directInitializeModal();

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ¬Šé™
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log('ğŸ”„ é–‹å§‹è¼‰å…¥ç”¨æˆ¶è³‡è¨Š...');
                await loadUserInfo();
                console.log('âœ… ç”¨æˆ¶è³‡è¨Šè¼‰å…¥å®Œæˆï¼Œè§’è‰²:', userRole);
                
                if (userRole !== 'teacher') {
                    alert('æ¬Šé™ä¸è¶³ï¼Œåƒ…æ•™å¸«å¯ä»¥å­˜å–å­¸ç”Ÿç®¡ç†åŠŸèƒ½');
                    window.location.href = 'login.html';
                    return;
                }
                
                try {
                    // æª¢æŸ¥æ˜¯å¦æœ‰å¾…å®Œæˆçš„å­¸ç”Ÿå‰µå»º
                    await checkPendingStudentCreation();
                    
                    console.log('ğŸ”„ æº–å‚™åˆå§‹åŒ–æ¨¡æ…‹æ¡†æ§åˆ¶å™¨...');
                    // åˆå§‹åŒ–æ¨¡æ…‹æ¡†æ§åˆ¶å™¨
                    initializeModalControls();
                    
                    // åˆå§‹åŒ–è¡¨å–®äº‹ä»¶ç›£è½å™¨
                    initializeFormEventListeners();
                } catch (error) {
                    console.error('âŒ åˆå§‹åŒ–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                    // å³ä½¿æœ‰éŒ¯èª¤ä¹Ÿè¦å˜—è©¦åˆå§‹åŒ–æ¨¡æ…‹æ¡†
                    console.log('ğŸ”„ å˜—è©¦ç›´æ¥åˆå§‹åŒ–æ¨¡æ…‹æ¡†...');
                    initializeModalControls();
                    // ä½¿ç”¨å‚™ç”¨æ–¹æ³•
                    directInitializeModal();
                }
                
                console.log('ğŸ”„ é–‹å§‹è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨...');
                await loadStudents();
            } else {
                window.location.href = 'login.html';
            }
        });

        // æª¢æŸ¥å¾…å®Œæˆçš„å­¸ç”Ÿå‰µå»º
        async function checkPendingStudentCreation() {
            const pendingData = sessionStorage.getItem('pendingStudentCreation');
            if (pendingData) {
                try {
                    const { studentUid, studentData, teacherId } = JSON.parse(pendingData);
                    console.log('ğŸ”„ ç™¼ç¾å¾…å®Œæˆçš„å­¸ç”Ÿå‰µå»º:', { studentUid, teacherId });
                    
                    // ç¢ºèªç•¶å‰ç”¨æˆ¶æ˜¯æ­£ç¢ºçš„æ•™å¸«
                    if (currentUser.uid === teacherId) {
                        console.log('âœ… æ•™å¸«èº«ä»½ç¢ºèªï¼Œé–‹å§‹å®Œæˆå­¸ç”Ÿè³‡æ–™å‰µå»º...');
                        
                        const result = await window.firebaseService.completeStudentDataCreation(studentUid, studentData, teacherId);
                        
                        if (result.success) {
                            console.log('âœ… å­¸ç”Ÿè³‡æ–™å‰µå»ºå®Œæˆ');
                            
                            // é¡å¤–é©—è­‰ï¼šæª¢æŸ¥å­¸ç”Ÿè¨˜éŒ„æ˜¯å¦æ­£ç¢ºå‰µå»º
                            try {
                                const studentDoc = await window.firebaseService.db.collection('students').doc(studentUid).get();
                                if (studentDoc.exists) {
                                    const studentRecord = studentDoc.data();
                                    console.log('ğŸ” é©—è­‰å­¸ç”Ÿè¨˜éŒ„:', {
                                        studentId: studentUid,
                                        teacherId: studentRecord.teacherId,
                                        name: studentRecord.name,
                                        email: studentRecord.email,
                                        status: studentRecord.status
                                    });
                                    
                                    if (studentRecord.teacherId === teacherId) {
                                        console.log('âœ… å¸«ç”Ÿé—œè¯é©—è­‰æˆåŠŸ');
                                        alert(`å­¸ç”Ÿå¸³è™Ÿå®Œæ•´å‰µå»ºæˆåŠŸï¼\n\nâœ… èªè­‰å¸³è™Ÿå·²å‰µå»º\nâœ… ä½¿ç”¨è€…è¨˜éŒ„å·²å‰µå»º\nâœ… å¸«ç”Ÿé—œè¯å·²å»ºç«‹ä¸¦é©—è­‰\nğŸ‘¨â€ğŸ« æ•™å¸«ID: ${teacherId}\n\nğŸ¯ å­¸ç”Ÿ: ${studentData.name}`);
                                    } else {
                                        console.error('âŒ å¸«ç”Ÿé—œè¯é©—è­‰å¤±æ•—ï¼Œè¨˜éŒ„ä¸­çš„æ•™å¸«ID:', studentRecord.teacherId);
                                        alert(`å­¸ç”Ÿå¸³è™Ÿå‰µå»ºå®Œæˆï¼Œä½†å¸«ç”Ÿé—œè¯å¯èƒ½æœ‰å•é¡Œ\næœŸæœ›æ•™å¸«ID: ${teacherId}\nå¯¦éš›æ•™å¸«ID: ${studentRecord.teacherId}`);
                                    }
                                } else {
                                    console.error('âŒ å­¸ç”Ÿè¨˜éŒ„æœªæ‰¾åˆ°');
                                    alert('å­¸ç”Ÿå¸³è™Ÿå‰µå»ºç•°å¸¸ï¼šæ‰¾ä¸åˆ°å­¸ç”Ÿè¨˜éŒ„');
                                }
                            } catch (verifyError) {
                                console.error('âŒ é©—è­‰å­¸ç”Ÿè¨˜éŒ„éŒ¯èª¤:', verifyError);
                                alert('å­¸ç”Ÿå¸³è™Ÿå‰µå»ºå®Œæˆï¼Œä½†é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤');
                            }
                        } else {
                            console.error('âŒ å®Œæˆå­¸ç”Ÿè³‡æ–™å‰µå»ºå¤±æ•—:', result.error);
                            alert(`å­¸ç”Ÿå¸³è™Ÿèªè­‰å·²å‰µå»ºï¼Œä½†è³‡æ–™å‰µå»ºå¤±æ•—ï¼š\n${result.error}\n\nè«‹ä½¿ç”¨ä¿®å¾©å·¥å…·æˆ–è¯çµ¡ç®¡ç†å“¡ã€‚`);
                        }
                    } else {
                        console.warn('âš ï¸ æ•™å¸«èº«ä»½ä¸ç¬¦ï¼Œæ¸…é™¤å¾…è™•ç†è³‡æ–™');
                    }
                    
                    // æ¸…é™¤ sessionStorage
                    sessionStorage.removeItem('pendingStudentCreation');
                    
                } catch (error) {
                    console.error('è™•ç†å¾…å®Œæˆå­¸ç”Ÿå‰µå»ºéŒ¯èª¤:', error);
                    sessionStorage.removeItem('pendingStudentCreation');
                }
            }
        }

        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUserInfo() {
            if (!currentUser) return;
            
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                const userName = userData?.name || currentUser.displayName || currentUser.email;
                userRole = userData?.role || 'user';
                const userInfoElement = document.getElementById('userInfo');
                const photoURL = currentUser.photoURL || userData?.photoURL;
                
                console.log('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š:', { userRole, userName, userData });
                
                if (photoURL) {
                    userInfoElement.innerHTML = `
                        <img src="${photoURL}" alt="User Avatar" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                        ${userName} (${userRole === 'teacher' ? 'æ•™å¸«' : 'ä½¿ç”¨è€…'})
                    `;
                } else {
                    userInfoElement.textContent = `${userName} (${userRole === 'teacher' ? 'æ•™å¸«' : 'ä½¿ç”¨è€…'})`;
                }
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:', error);
            }
        }

        // è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨
        async function loadStudents() {
            if (!currentUser) {
                console.log('âŒ loadStudents: æ²’æœ‰ç•¶å‰ç”¨æˆ¶');
                return;
            }

            console.log('ğŸ” loadStudents æª¢æŸ¥:', {
                currentUserUid: currentUser.uid,
                currentUserEmail: currentUser.email,
                userRole: userRole
            });

            try {
                console.log('ğŸ‘¨â€ğŸ« æ•™å¸«æ¨¡å¼ï¼šè¼‰å…¥è‡ªå·±çš„å­¸ç”Ÿï¼Œæ•™å¸«ID:', currentUser.uid);
                const studentsQuery = window.firebaseService.db.collection('students')
                    .where('teacherId', '==', currentUser.uid);

                console.log('ğŸ“ åŸ·è¡Œ Firestore æŸ¥è©¢...');
                const snapshot = await studentsQuery.get();
                students = [];
                snapshot.forEach(doc => {
                    students.push({ id: doc.id, ...doc.data() });
                });

                console.log('âœ… è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨æˆåŠŸ:', students);
                updateStudentsTable();
                updateStats();
            } catch (error) {
                console.error('âŒ è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨éŒ¯èª¤:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    code: error.code,
                    message: error.message,
                    currentUserUid: currentUser?.uid,
                    userRole: userRole
                });
                
                // å˜—è©¦ç°¡åŒ–æŸ¥è©¢ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
                if (error.code === 'permission-denied' || error.message.includes('permission')) {
                    console.log('âš ï¸ æ¬Šé™è¢«æ‹’çµ•ï¼Œå¯èƒ½æ˜¯ Firestore å®‰å…¨è¦å‰‡å•é¡Œ');
                    alert('è¼‰å…¥å­¸ç”Ÿè³‡æ–™æ¬Šé™ä¸è¶³ã€‚è«‹æª¢æŸ¥æ‚¨çš„å¸³è™Ÿæ¬Šé™æˆ–è¯çµ¡ç®¡ç†å“¡ã€‚');
                } else if (error.code === 'invalid-argument') {
                    console.log('âš ï¸ æŸ¥è©¢åƒæ•¸éŒ¯èª¤ï¼Œå˜—è©¦ä¸ä½¿ç”¨æŸ¥è©¢æ¢ä»¶');
                    try {
                        // å‚™ç”¨æ–¹æ¡ˆï¼šè¼‰å…¥æ‰€æœ‰å­¸ç”Ÿç„¶å¾Œåœ¨å‰ç«¯éæ¿¾
                        const allStudentsSnapshot = await window.firebaseService.db.collection('students').get();
                        students = [];
                        allStudentsSnapshot.forEach(doc => {
                            const studentData = { id: doc.id, ...doc.data() };
                            // æ•™å¸«åªé¡¯ç¤ºè‡ªå·±çš„å­¸ç”Ÿ
                            if (studentData.teacherId === currentUser.uid) {
                                students.push(studentData);
                            }
                        });
                        console.log('âœ… å‚™ç”¨æ–¹æ¡ˆè¼‰å…¥æˆåŠŸ:', students);
                        updateStudentsTable();
                        updateStats();
                    } catch (backupError) {
                        console.error('âŒ å‚™ç”¨æ–¹æ¡ˆä¹Ÿå¤±æ•—:', backupError);
                        alert('ç„¡æ³•è¼‰å…¥å­¸ç”Ÿè³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯çµ¡ç®¡ç†å“¡ã€‚');
                    }
                } else {
                    alert('è¼‰å…¥å­¸ç”Ÿè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                }
            }
        }

        // æ›´æ–°å­¸ç”Ÿè¡¨æ ¼
        function updateStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            students.forEach(student => {
                const row = document.createElement('tr');
                const createdAt = student.createdAt ? new Date(student.createdAt.toDate()).toLocaleDateString('zh-TW') : 'æœªçŸ¥';
                
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.studentNumber || 'æœªè¨­å®š'}</td>
                    <td>${student.email}</td>
                    <td>
                        <span class="status ${student.status}">${student.status === 'active' ? 'æ´»èº' : 'åœç”¨'}</span>
                    </td>
                    <td>${createdAt}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="viewStudent('${student.id}')" class="action-btn view" title="æŸ¥çœ‹å­¸ç”Ÿè©³ç´°è³‡æ–™">
                                <span>ğŸ‘€</span>
                                <span>æŸ¥çœ‹</span>
                            </button>
                            <button onclick="toggleStudentStatus('${student.id}')" class="action-btn ${student.status === 'active' ? 'disable' : 'enable'}" 
                                    title="${student.status === 'active' ? 'åœç”¨æ­¤å­¸ç”Ÿå¸³è™Ÿ' : 'å•Ÿç”¨æ­¤å­¸ç”Ÿå¸³è™Ÿ'}">
                                <span>${student.status === 'active' ? 'â¸ï¸' : 'â–¶ï¸'}</span>
                                <span>${student.status === 'active' ? 'åœç”¨' : 'å•Ÿç”¨'}</span>
                            </button>
                            <button onclick="confirmDeleteStudent('${student.id}', '${student.name}')" class="action-btn delete" title="åˆªé™¤æ­¤å­¸ç”Ÿå¸³è™Ÿ">
                                <span>ğŸ—‘ï¸</span>
                                <span>åˆªé™¤</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('activeStudents').textContent = 
                students.filter(s => s.status === 'active').length;
            document.getElementById('studentsWithData').textContent = 'è¨ˆç®—ä¸­...';

            // ç•°æ­¥è¨ˆç®—æœ‰è³‡æ–™çš„å­¸ç”Ÿæ•¸
            countStudentsWithData();
        }

        // è¨ˆç®—æœ‰è³‡æ–™çš„å­¸ç”Ÿæ•¸
        async function countStudentsWithData() {
            let count = 0;
            for (const student of students) {
                try {
                    const userDataDoc = await window.firebaseService.db
                        .collection('userData').doc(student.id).get();
                    if (userDataDoc.exists && userDataDoc.data()?.cleaningTasks?.length > 0) {
                        count++;
                    }
                } catch (error) {
                    console.warn('æª¢æŸ¥å­¸ç”Ÿè³‡æ–™éŒ¯èª¤:', error);
                }
            }
            document.getElementById('studentsWithData').textContent = count;
        }

        // å‚™ç”¨åˆå§‹åŒ–æ–¹æ³• - ç›´æ¥ç¶å®šåˆ° DOM å…ƒç´ 
        function directInitializeModal() {
            console.log('ğŸš¨ ä½¿ç”¨å‚™ç”¨æ–¹æ³•åˆå§‹åŒ–æ¨¡æ…‹æ¡†...');
            
            // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM å·²åŠ è¼‰
            setTimeout(function() {
                const modal = document.getElementById('addStudentModal');
                const addBtn = document.getElementById('addStudentBtn');
                const closeBtn = document.querySelector('.close');
                const cancelBtn = document.querySelector('.cancel-btn');

                console.log('DOM å…ƒç´ æª¢æŸ¥ (å‚™ç”¨æ–¹æ³•):');
                console.log('- modal:', modal);
                console.log('- addBtn:', addBtn);
                console.log('- closeBtn:', closeBtn);
                console.log('- cancelBtn:', cancelBtn);
                
                // æª¢æŸ¥æ¨¡æ…‹æ¡†å…§å®¹
                if (modal) {
                    console.log('æ¨¡æ…‹æ¡†è©³ç´°è³‡è¨Š:');
                    console.log('- innerHTML é•·åº¦:', modal.innerHTML.length);
                    console.log('- è¨ˆç®—æ¨£å¼ display:', window.getComputedStyle(modal).display);
                    console.log('- è¨ˆç®—æ¨£å¼ z-index:', window.getComputedStyle(modal).zIndex);
                    console.log('- è¨ˆç®—æ¨£å¼ position:', window.getComputedStyle(modal).position);
                }

                if (addBtn) {
                    console.log('ğŸ”„ è¨­ç½®æŒ‰éˆ•é»æ“Šäº‹ä»¶...');
                    addBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ğŸ–±ï¸ æŒ‰éˆ•é»æ“Š (å‚™ç”¨æ–¹æ³•)');
                        if (modal) {
                            modal.style.display = 'block';
                            modal.style.zIndex = '99999';
                            modal.style.position = 'fixed';
                            modal.style.top = '0';
                            modal.style.left = '0';
                            modal.style.width = '100vw';
                            modal.style.height = '100vh';
                            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
                            modal.style.backdropFilter = 'blur(2px)';
                            // é˜²æ­¢é é¢æ»¾å‹•
                            document.body.style.overflow = 'hidden';
                            console.log('âœ… æ¨¡æ…‹æ¡†é¡¯ç¤º (å‚™ç”¨æ–¹æ³•)');
                            console.log('æ¨¡æ…‹æ¡†ç•¶å‰æ¨£å¼:', {
                                display: modal.style.display,
                                zIndex: modal.style.zIndex,
                                position: modal.style.position,
                                visibility: window.getComputedStyle(modal).visibility,
                                opacity: window.getComputedStyle(modal).opacity
                            });
                        } else {
                            console.error('âŒ æ¨¡æ…‹æ¡†å…ƒç´ æœªæ‰¾åˆ°');
                        }
                    };
                    
                    // é¡å¤–çš„äº‹ä»¶ç›£è½å™¨
                    addBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ğŸ–±ï¸ æŒ‰éˆ•é»æ“Š (addEventListener å‚™ç”¨æ–¹æ³•)');
                        if (modal) {
                            modal.style.display = 'block';
                            modal.style.zIndex = '99999';
                            document.body.style.overflow = 'hidden';
                            console.log('âœ… æ¨¡æ…‹æ¡†é¡¯ç¤º (addEventListener å‚™ç”¨æ–¹æ³•)');
                        }
                    });
                    
                    console.log('âœ… å‚™ç”¨æ–¹æ³•è¨­ç½®å®Œæˆ');
                } else {
                    console.error('âŒ å‚™ç”¨æ–¹æ³•ï¼šæ‰¾ä¸åˆ°æŒ‰éˆ•');
                }
                
                // æ¸¬è©¦æŒ‰éˆ•æ˜¯å¦å¯é»æ“Š
                if (addBtn) {
                    console.log('æŒ‰éˆ•å±¬æ€§æª¢æŸ¥:');
                    console.log('- disabled:', addBtn.disabled);
                    console.log('- style.display:', addBtn.style.display);
                    console.log('- style.pointerEvents:', addBtn.style.pointerEvents);
                    console.log('- offsetParent:', addBtn.offsetParent);
                }
            }, 100);
        }

        // åˆå§‹åŒ–æ¨¡æ…‹æ¡†æ§åˆ¶ï¼ˆåœ¨DOMè¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œï¼‰
        function initializeModalControls() {
            console.log('ğŸ”„ é–‹å§‹åˆå§‹åŒ–æ¨¡æ…‹æ¡†æ§åˆ¶å™¨...');
            
            modal = document.getElementById('addStudentModal');
            const addBtn = document.getElementById('addStudentBtn');
            const closeBtn = document.querySelector('.close');
            const cancelBtn = document.querySelector('.cancel-btn');

            console.log('æ¨¡æ…‹æ¡†å…ƒç´ æª¢æŸ¥:');
            console.log('- modal:', modal);
            console.log('- addBtn:', addBtn);
            console.log('- closeBtn:', closeBtn);
            console.log('- cancelBtn:', cancelBtn);

            if (modal && addBtn && closeBtn && cancelBtn) {
                addBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('ğŸ–±ï¸ æ–°å¢å­¸ç”ŸæŒ‰éˆ•è¢«é»æ“Š');
                    modal.style.display = 'block';
                    modal.style.zIndex = '99999';
                    document.body.style.overflow = 'hidden';
                    console.log('âœ… æ¨¡æ…‹æ¡†å·²é¡¯ç¤º');
                });

                closeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('ğŸ–±ï¸ é—œé–‰æŒ‰éˆ•è¢«é»æ“Š');
                    closeModal();
                });

                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('ğŸ–±ï¸ å–æ¶ˆæŒ‰éˆ•è¢«é»æ“Š');
                    closeModal();
                });

                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        console.log('ğŸ–±ï¸ èƒŒæ™¯è¢«é»æ“Šï¼Œé—œé–‰æ¨¡æ…‹æ¡†');
                        closeModal();
                    }
                });
                
                console.log('âœ… æ¨¡æ…‹æ¡†æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ æ¨¡æ…‹æ¡†å…ƒç´ æœªæ‰¾åˆ°');
                console.error('ç¼ºå¤±çš„å…ƒç´ :');
                if (!modal) console.error('- addStudentModal æœªæ‰¾åˆ°');
                if (!addBtn) console.error('- addStudentBtn æœªæ‰¾åˆ°');
                if (!closeBtn) console.error('- close æŒ‰éˆ•æœªæ‰¾åˆ°');
                if (!cancelBtn) console.error('- cancel-btn æœªæ‰¾åˆ°');
            }
        }

        // ç”Ÿæˆå®‰å…¨å¯†ç¢¼
        function generateSecurePassword() {
            const length = 12;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let password = "";
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }

        // æª¢æŸ¥å¯†ç¢¼å¼·åº¦
        function checkPasswordStrength(password) {
            if (password.length < 6) return { strength: 'weak', text: 'å¯†ç¢¼å¤ªçŸ­ï¼ˆè‡³å°‘6ä½ï¼‰' };
            if (password.length < 8) return { strength: 'medium', text: 'å¯†ç¢¼å¼·åº¦ä¸­ç­‰' };
            
            let score = 0;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            
            if (score >= 3 && password.length >= 8) return { strength: 'strong', text: 'å¯†ç¢¼å¼·åº¦é«˜' };
            if (score >= 2) return { strength: 'medium', text: 'å¯†ç¢¼å¼·åº¦ä¸­ç­‰' };
            return { strength: 'weak', text: 'å¯†ç¢¼å¼·åº¦è¼ƒå¼±' };
        }

        // é©—è­‰è¡¨å–®
        function validateForm() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const password = document.getElementById('studentPassword').value;
            
            let isValid = true;
            
            // é©—è­‰å§“å
            if (!name) {
                showError('nameError', 'è«‹è¼¸å…¥å­¸ç”Ÿå§“å');
                document.getElementById('studentName').classList.add('error');
                isValid = false;
            } else if (name.length < 2) {
                showError('nameError', 'å§“åè‡³å°‘éœ€è¦2å€‹å­—ç¬¦');
                document.getElementById('studentName').classList.add('error');
                isValid = false;
            } else {
                hideError('nameError');
                document.getElementById('studentName').classList.remove('error');
                document.getElementById('studentName').classList.add('success');
            }
            
            // é©—è­‰éƒµç®±
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email) {
                showError('emailError', 'è«‹è¼¸å…¥é›»å­ä¿¡ç®±');
                document.getElementById('studentEmail').classList.add('error');
                isValid = false;
            } else if (!emailRegex.test(email)) {
                showError('emailError', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­ä¿¡ç®±æ ¼å¼');
                document.getElementById('studentEmail').classList.add('error');
                isValid = false;
            } else {
                hideError('emailError');
                document.getElementById('studentEmail').classList.remove('error');
                document.getElementById('studentEmail').classList.add('success');
            }
            
            // æ›´æ–°æ‘˜è¦
            if (isValid) {
                updateFormSummary();
            }
            
            return isValid;
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function updateFormSummary() {
            const name = document.getElementById('studentName').value.trim();
            const number = document.getElementById('studentNumber').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            
            if (name && email) {
                document.getElementById('summaryName').textContent = name;
                document.getElementById('summaryNumber').textContent = number || 'æœªå¡«å¯«';
                document.getElementById('summaryEmail').textContent = email;
                document.getElementById('formSummary').style.display = 'block';
            } else {
                document.getElementById('formSummary').style.display = 'none';
            }
        }

        function resetForm() {
            const form = document.getElementById('addStudentForm');
            form.reset();
            
            // æ¸…é™¤éŒ¯èª¤ç‹€æ…‹
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.success').forEach(el => el.classList.remove('success'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('formSummary').style.display = 'none';
            document.getElementById('passwordStrength').style.display = 'none';
            
            // é‡æ–°ç”Ÿæˆå¯†ç¢¼
            const passwordInput = document.getElementById('studentPassword');
            const password = generateSecurePassword();
            passwordInput.value = password;
            
            const strength = checkPasswordStrength(password);
            const strengthElement = document.getElementById('passwordStrength');
            strengthElement.textContent = strength.text;
            strengthElement.className = `password-strength ${strength.strength}`;
            strengthElement.style.display = 'block';
            
            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            const submitBtn = document.getElementById('submitBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
            submitBtn.disabled = false;
        }

        function closeModal() {
            if (modal) {
                modal.style.display = 'none';
                // æ¢å¾©é é¢æ»¾å‹•
                document.body.style.overflow = 'auto';
                // é‡ç½®è¡¨å–®
                resetForm();
            }
        }

        function showSuccessMessage(message) {
            // ä½¿ç”¨æ›´å‹å¥½çš„æˆåŠŸæç¤º
            const successAlert = document.createElement('div');
            successAlert.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
                z-index: 10000;
                text-align: center;
                font-size: 14px;
                line-height: 1.5;
                max-width: 400px;
                animation: successFadeIn 0.3s ease-out;
            `;
            
            successAlert.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 10px;">ğŸ‰</div>
                <div style="white-space: pre-line;">${message}</div>
            `;
            
            document.body.appendChild(successAlert);
            
            setTimeout(() => {
                document.body.removeChild(successAlert);
            }, 3000);
        }

        // åˆå§‹åŒ–è¡¨å–®äº‹ä»¶ç›£è½å™¨
        function initializeFormEventListeners() {
            const form = document.getElementById('addStudentForm');
            const generateBtn = document.getElementById('generatePasswordBtn');
            const toggleBtn = document.getElementById('togglePasswordBtn');
            const passwordInput = document.getElementById('studentPassword');
            const nameInput = document.getElementById('studentName');
            const emailInput = document.getElementById('studentEmail');

            // ç”Ÿæˆå¯†ç¢¼æŒ‰éˆ•
            if (generateBtn) {
                generateBtn.addEventListener('click', () => {
                    const password = generateSecurePassword();
                    passwordInput.value = password;
                    
                    const strength = checkPasswordStrength(password);
                    const strengthElement = document.getElementById('passwordStrength');
                    strengthElement.textContent = strength.text;
                    strengthElement.className = `password-strength ${strength.strength}`;
                    strengthElement.style.display = 'block';
                });
                
                // é é¢è¼‰å…¥æ™‚è‡ªå‹•ç”Ÿæˆå¯†ç¢¼
                const password = generateSecurePassword();
                passwordInput.value = password;
                
                const strength = checkPasswordStrength(password);
                const strengthElement = document.getElementById('passwordStrength');
                strengthElement.textContent = strength.text;
                strengthElement.className = `password-strength ${strength.strength}`;
                strengthElement.style.display = 'block';
            }

            // å¯†ç¢¼é¡¯ç¤º/éš±è—æŒ‰éˆ•
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        toggleBtn.textContent = 'ğŸ™ˆ';
                    } else {
                        passwordInput.type = 'password';
                        toggleBtn.textContent = 'ğŸ‘ï¸';
                    }
                });
            }

            // å³æ™‚é©—è­‰
            if (nameInput) {
                nameInput.addEventListener('input', validateForm);
            }
            
            if (emailInput) {
                emailInput.addEventListener('input', validateForm);
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('input', () => {
                    const strength = checkPasswordStrength(passwordInput.value);
                    const strengthElement = document.getElementById('passwordStrength');
                    strengthElement.textContent = strength.text;
                    strengthElement.className = `password-strength ${strength.strength}`;
                    strengthElement.style.display = 'block';
                });
            }
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // è¡¨å–®é©—è­‰
                    if (!validateForm()) {
                        console.log('âŒ è¡¨å–®é©—è­‰å¤±æ•—');
                        return;
                    }
                    
                    const name = document.getElementById('studentName').value.trim();
                    const studentNumber = document.getElementById('studentNumber').value.trim();
                    const email = document.getElementById('studentEmail').value.trim();
                    const password = document.getElementById('studentPassword').value;

                    const submitBtn = document.getElementById('submitBtn');
                    const btnText = submitBtn.querySelector('.btn-text');
                    const btnLoading = submitBtn.querySelector('.btn-loading');
                    
                    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'flex';
                    submitBtn.disabled = true;

            try {
                const result = await window.firebaseService.createUser(email, password, {
                    role: 'student',
                    name: name,
                    studentNumber: studentNumber,
                    teacherId: currentUser.uid
                });

                if (result.success) {
                    console.log('âœ… å­¸ç”Ÿå¸³è™Ÿå‰µå»ºæˆåŠŸï¼ŒUID:', result.user.uid);
                    
                    if (result.dataCreated && result.needsImmediateReload) {
                        console.log('âœ… å­¸ç”Ÿè³‡æ–™å‰µå»ºå®Œæˆï¼Œéœ€è¦é‡æ–°è¼‰å…¥é é¢');
                        
                        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                        showSuccessMessage(`å­¸ç”Ÿå¸³è™Ÿ ${name} å‰µå»ºæˆåŠŸï¼\n\nâœ… èªè­‰å¸³è™Ÿå·²å‰µå»º\nâœ… å­¸ç”Ÿè³‡æ–™å·²å»ºç«‹\nâœ… å¸«ç”Ÿé—œè¯å·²å»ºç«‹\n\nå³å°‡é‡æ–°è¼‰å…¥é é¢ï¼Œè«‹é‡æ–°ç™»å…¥ç¹¼çºŒæ“ä½œ`);
                        
                        // é—œé–‰æ¨¡æ…‹æ¡†
                        closeModal();
                        
                        // é‡æ–°è¼‰å…¥é é¢
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                        return;
                        
                    } else if (result.dataCreated && result.needsTeacherReLogin) {
                        
                    } else if (result.needsDataCreation) {
                        console.log('âš ï¸ éœ€è¦å®Œæˆè³‡æ–™å‰µå»ºæµç¨‹');
                        
                        // ä¿å­˜è³‡æ–™åˆ° sessionStorageï¼Œä»¥ä¾¿é é¢é‡æ–°æ•´ç†å¾Œä½¿ç”¨
                        sessionStorage.setItem('pendingStudentCreation', JSON.stringify({
                            studentUid: result.user.uid,
                            studentData: result.studentData,
                            teacherId: result.teacherId
                        }));
                        
                        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                        showSuccessMessage(`å­¸ç”Ÿå¸³è™Ÿ ${name} å‰µå»ºæˆåŠŸï¼\n\nâœ… èªè­‰å¸³è™Ÿå·²å‰µå»º\nâš ï¸ å³å°‡é‡æ–°æ•´ç†é é¢ä»¥å®Œæˆå­¸ç”Ÿè³‡æ–™å‰µå»º...`);
                        
                        // é—œé–‰æ¨¡æ…‹æ¡†ï¼ˆæœƒè‡ªå‹•é‡ç½®è¡¨å–®ï¼‰
                        closeModal();
                        
                        // é‡æ–°æ•´ç†é é¢
                        window.location.reload();
                        return;
                        
                    } else if (result.currentUserPreserved) {
                        console.log('âœ… æ•™å¸«ç™»å…¥ç‹€æ…‹å·²ä¿æŒ');
                        
                        // ç«‹å³é©—è­‰ students é›†åˆè¨˜éŒ„
                        try {
                            const studentDoc = await window.firebaseService.db.collection('students').doc(result.user.uid).get();
                            if (studentDoc.exists) {
                                const studentData = studentDoc.data();
                                console.log('âœ… students é›†åˆè¨˜éŒ„ç¢ºèª:', studentData);
                                alert(`å­¸ç”Ÿå¸³è™Ÿå»ºç«‹æˆåŠŸï¼\n\nâœ… ä½¿ç”¨è€…è¨˜éŒ„å·²å‰µå»º\nâœ… å¸«ç”Ÿé—œè¯å·²å»ºç«‹\nğŸ‘¨â€ğŸ« æ•™å¸«ID: ${studentData.teacherId}\n\nğŸ¯ æ•™å¸«ç™»å…¥ç‹€æ…‹å·²ä¿æŒä¸è®Š`);
                            } else {
                                console.warn('âŒ students é›†åˆç¼ºå°‘è¨˜éŒ„');
                                alert(`å­¸ç”Ÿå¸³è™Ÿå»ºç«‹æˆåŠŸï¼Œä½†å¸«ç”Ÿé—œè¯å¯èƒ½æœ‰å•é¡Œã€‚\nè«‹æª¢æŸ¥ Firebase Console çš„ students é›†åˆï¼Œæˆ–ä½¿ç”¨ä¿®å¾©å·¥å…·ã€‚`);
                            }
                        } catch (verifyError) {
                            console.error('é©—è­‰å­¸ç”Ÿè¨˜éŒ„éŒ¯èª¤:', verifyError);
                            alert('å­¸ç”Ÿå¸³è™Ÿå»ºç«‹æˆåŠŸï¼Œä½†ç„¡æ³•é©—è­‰å¸«ç”Ÿé—œè¯ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
                        }
                        
                    } else {
                        // èˆŠçš„è™•ç†æ–¹å¼ï¼ˆå‚™ç”¨ï¼‰
                        alert(`å­¸ç”Ÿå¸³è™Ÿå»ºç«‹æˆåŠŸï¼\n\nâœ… ä½¿ç”¨è€…è¨˜éŒ„å·²å‰µå»º`);
                    }
                    
                    modal.style.display = 'none';
                    document.getElementById('addStudentForm').reset();
                    document.getElementById('studentPassword').value = 'student123';
                    await loadStudents();
                    
                } else {
                    console.error('âŒ å­¸ç”Ÿå¸³è™Ÿå‰µå»ºå¤±æ•—:', result.error);
                    alert('å»ºç«‹å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                console.error('å»ºç«‹å­¸ç”Ÿå¸³è™ŸéŒ¯èª¤:', error);
                alert('å»ºç«‹éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
                });
                console.log('âœ… è¡¨å–®äº‹ä»¶ç›£è½å™¨åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ è¡¨å–®å…ƒç´ æœªæ‰¾åˆ°');
            }
        }

        // æŸ¥çœ‹å­¸ç”Ÿè³‡æ–™
        function viewStudent(studentId) {
            // è·³è½‰åˆ°è¿½è¹¤é é¢ä¸¦é¡¯ç¤ºè©²å­¸ç”Ÿçš„è³‡æ–™
            sessionStorage.setItem('viewingStudentId', studentId);
            window.location.href = 'tracking.html';
        }

        // åˆ‡æ›å­¸ç”Ÿç‹€æ…‹
        async function toggleStudentStatus(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const newStatus = student.status === 'active' ? 'inactive' : 'active';
            
            try {
                await window.firebaseService.db.collection('students').doc(studentId).update({
                    status: newStatus
                });
                
                alert(`å­¸ç”Ÿç‹€æ…‹å·²${newStatus === 'active' ? 'å•Ÿç”¨' : 'åœç”¨'}`);
                await loadStudents();
            } catch (error) {
                console.error('æ›´æ–°å­¸ç”Ÿç‹€æ…‹éŒ¯èª¤:', error);
                alert('æ›´æ–°ç‹€æ…‹å¤±æ•—');
            }
        }

        // åˆªé™¤å­¸ç”Ÿ
        // ç¢ºèªåˆªé™¤å­¸ç”Ÿï¼ˆå„ªåŒ–çš„ç¢ºèªå°è©±æ¡†ï¼‰
        function confirmDeleteStudent(studentId, studentName) {
            const confirmDelete = confirm(
                `âš ï¸ å±éšªæ“ä½œç¢ºèª\n\n` +
                `æ‚¨å³å°‡åˆªé™¤å­¸ç”Ÿï¼š${studentName}\n` +
                `å­¸ç”ŸIDï¼š${studentId}\n\n` +
                `æ­¤æ“ä½œå°‡æœƒï¼š\n` +
                `â€¢ åˆªé™¤å­¸ç”Ÿçš„ Firebase å¸³è™Ÿ\n` +
                `â€¢ åˆªé™¤æ‰€æœ‰ç›¸é—œçš„è¿½è¹¤è³‡æ–™\n` +
                `â€¢ ç„¡æ³•å¾©åŸ\n\n` +
                `ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`
            );
            
            if (confirmDelete) {
                deleteStudent(studentId);
            }
        }

        async function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const deleteBtn = document.querySelector(`button[onclick*="${studentId}"][onclick*="confirmDeleteStudent"]`);
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<span>ğŸ”„</span><span>åˆªé™¤ä¸­...</span>';
            }

            try {
                // åˆªé™¤å­¸ç”Ÿè¨˜éŒ„ã€ä½¿ç”¨è€…å¸³è™Ÿå’Œæ‰€æœ‰ç›¸é—œè³‡æ–™
                const batch = window.firebaseService.db.batch();
                
                // åˆªé™¤ students é›†åˆä¸­çš„è¨˜éŒ„
                batch.delete(window.firebaseService.db.collection('students').doc(studentId));
                
                // åˆªé™¤ users é›†åˆä¸­çš„è¨˜éŒ„
                batch.delete(window.firebaseService.db.collection('users').doc(studentId));
                
                // åˆªé™¤ userData é›†åˆä¸­çš„è¨˜éŒ„
                batch.delete(window.firebaseService.db.collection('userData').doc(studentId));
                
                // åˆªé™¤ trackingData é›†åˆä¸­çš„è¨˜éŒ„
                batch.delete(window.firebaseService.db.collection('trackingData').doc(studentId));

                await batch.commit();
                
                showSuccessMessage(`å­¸ç”Ÿ ${student.name} å·²æˆåŠŸåˆªé™¤ï¼\n\nâœ… å¸³è™Ÿå·²åˆªé™¤\nâœ… æ‰€æœ‰ç›¸é—œè³‡æ–™å·²æ¸…é™¤`);
                await loadStudents();
                
            } catch (error) {
                console.error('åˆªé™¤å­¸ç”ŸéŒ¯èª¤:', error);
                
                // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
                const errorMsg = error.code === 'permission-denied' 
                    ? 'æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åˆªé™¤å­¸ç”Ÿè³‡æ–™' 
                    : `åˆªé™¤å¤±æ•—ï¼š${error.message}`;
                    
                alert(`âŒ ${errorMsg}\n\nè«‹æª¢æŸ¥ï¼š\nâ€¢ ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸\nâ€¢ æ˜¯å¦æœ‰è¶³å¤ æ¬Šé™\nâ€¢ ç¨å¾Œå†è©¦`);
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<span>ğŸ—‘ï¸</span><span>åˆªé™¤</span>';
                }
            }
        }

        // å°èˆªå‡½æ•¸
        function goToTracking() {
            window.location.href = 'tracking.html';
        }

        function goToImport() {
            window.location.href = 'import.html';
        }

        function logout() {
            window.firebaseService.signOut().then(() => {
                sessionStorage.clear();
                window.location.href = 'login.html';
            });
        }
    </script>
</body>
</html>