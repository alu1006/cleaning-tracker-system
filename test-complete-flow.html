<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´æµç¨‹æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .passed { background: #d4edda; border-color: #c3e6cb; }
        .failed { background: #f8d7da; border-color: #f5c6cb; }
        .pending { background: #fff3cd; border-color: #ffeaa7; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 8px 15px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 12px; }
        .log { max-height: 200px; overflow-y: auto; }
    </style>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>ğŸ§ª å¸«ç”Ÿç³»çµ±å®Œæ•´æµç¨‹æ¸¬è©¦</h1>
    
    <div class="test-section info">
        <h3>ğŸ“‹ æ¸¬è©¦è¨ˆåŠƒ</h3>
        <ol>
            <li>æ¸¬è©¦æ•™å¸« Google ç™»å…¥</li>
            <li>æ¸¬è©¦æ•™å¸«å‰µå»ºå­¸ç”Ÿå¸³è™Ÿ</li>
            <li>æ¸¬è©¦å­¸ç”Ÿç™»å…¥</li>
            <li>æ¸¬è©¦å­¸ç”ŸæŸ¥çœ‹æ•™å¸«è³‡æ–™</li>
            <li>æ¸¬è©¦å­¸ç”Ÿè¨ªå• import.html å’Œ tracking.html</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>ğŸ”§ æ§åˆ¶é¢æ¿</h3>
        <button onclick="runAllTests()">ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
        <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
        <button onclick="resetTest()">ğŸ”„ é‡ç½®æ¸¬è©¦</button>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š æ¸¬è©¦çµæœ</h3>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h3>
        <div id="testLogs" class="log"></div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple-public.js"></script>
    
    <script>
        let testResults = {};
        let currentUser = null;
        
        // æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('testLogs');
            const color = type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[TEST] ${message}`);
        }

        // æ›´æ–°æ¸¬è©¦çµæœé¡¯ç¤º
        function updateResults() {
            const resultsDiv = document.getElementById('testResults');
            let html = '<table border="1" style="width: 100%; border-collapse: collapse;">';
            html += '<tr><th>æ¸¬è©¦é …ç›®</th><th>ç‹€æ…‹</th><th>è©³æƒ…</th></tr>';
            
            for (const [test, result] of Object.entries(testResults)) {
                const status = result.passed ? 'âœ… é€šé' : result.failed ? 'âŒ å¤±æ•—' : 'â³ é€²è¡Œä¸­';
                const rowClass = result.passed ? 'passed' : result.failed ? 'failed' : 'pending';
                html += `<tr class="${rowClass}">
                    <td>${test}</td>
                    <td>${status}</td>
                    <td>${result.details || ''}</td>
                </tr>`;
            }
            html += '</table>';
            resultsDiv.innerHTML = html;
        }

        // è¨­å®šæ¸¬è©¦çµæœ
        function setTestResult(testName, passed, details = '') {
            testResults[testName] = { 
                passed: passed, 
                failed: !passed, 
                details: details,
                timestamp: new Date()
            };
            updateResults();
        }

        // æ¸…é™¤æ—¥èªŒ
        function clearLogs() {
            document.getElementById('testLogs').innerHTML = '';
        }

        // é‡ç½®æ¸¬è©¦
        function resetTest() {
            testResults = {};
            updateResults();
            clearLogs();
            if (currentUser) {
                window.firebaseService.signOut();
            }
            sessionStorage.clear();
            log('ğŸ”„ æ¸¬è©¦å·²é‡ç½®', 'info');
        }

        // ç­‰å¾…å‡½æ•¸
        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // æ¸¬è©¦ 1: Firebase é€£æ¥
        async function testFirebaseConnection() {
            log('ğŸ”¥ æ¸¬è©¦ Firebase é€£æ¥...', 'info');
            try {
                if (!window.firebaseService) {
                    throw new Error('Firebase æœå‹™æœªè¼‰å…¥');
                }
                
                if (!window.firebaseService.auth || !window.firebaseService.db) {
                    throw new Error('Firebase Auth æˆ– Firestore æœªåˆå§‹åŒ–');
                }

                log('âœ… Firebase é€£æ¥æ­£å¸¸', 'success');
                setTestResult('Firebase é€£æ¥', true, 'Auth å’Œ Firestore æ­£å¸¸');
                return true;
            } catch (error) {
                log(`âŒ Firebase é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                setTestResult('Firebase é€£æ¥', false, error.message);
                return false;
            }
        }

        // æ¸¬è©¦ 2: å­¸ç”Ÿç™»å…¥
        async function testStudentLogin() {
            log('ğŸ“ æ¸¬è©¦å­¸ç”Ÿç™»å…¥...', 'info');
            try {
                // å…ˆç™»å‡ºç¾æœ‰ç”¨æˆ¶
                if (currentUser) {
                    await window.firebaseService.signOut();
                    await wait(1000);
                }

                const result = await window.firebaseService.signIn('123@gmail.com', '123456');
                
                if (!result.success) {
                    throw new Error(`ç™»å…¥å¤±æ•—: ${result.error}`);
                }

                currentUser = result.user;
                log(`âœ… å­¸ç”Ÿç™»å…¥æˆåŠŸ: ${result.user.email}`, 'success');

                // æª¢æŸ¥ç”¨æˆ¶è§’è‰²
                const userDoc = await window.firebaseService.db.collection('users').doc(result.user.uid).get();
                const userData = userDoc.data();

                if (userData?.role !== 'student') {
                    throw new Error(`ç”¨æˆ¶è§’è‰²ä¸æ­£ç¢º: ${userData?.role}, æ‡‰è©²æ˜¯ student`);
                }

                log(`âœ… ç”¨æˆ¶è§’è‰²é©—è­‰é€šé: ${userData.role}`, 'success');
                setTestResult('å­¸ç”Ÿç™»å…¥', true, `${result.user.email} - ${userData.role}`);
                return true;
            } catch (error) {
                log(`âŒ å­¸ç”Ÿç™»å…¥å¤±æ•—: ${error.message}`, 'error');
                setTestResult('å­¸ç”Ÿç™»å…¥', false, error.message);
                return false;
            }
        }

        // æ¸¬è©¦ 3: å­¸ç”Ÿè¨˜éŒ„æª¢æŸ¥
        async function testStudentRecord() {
            log('ğŸ‘¥ æ¸¬è©¦å­¸ç”Ÿè¨˜éŒ„æª¢æŸ¥...', 'info');
            try {
                if (!currentUser) {
                    throw new Error('æ²’æœ‰ç™»å…¥ç”¨æˆ¶');
                }

                const studentDoc = await window.firebaseService.db.collection('students').doc(currentUser.uid).get();
                
                if (!studentDoc.exists) {
                    throw new Error('å­¸ç”Ÿè¨˜éŒ„ä¸å­˜åœ¨');
                }

                const studentData = studentDoc.data();
                
                if (!studentData.teacherId) {
                    throw new Error('å­¸ç”Ÿè¨˜éŒ„ç¼ºå°‘ teacherId');
                }

                log(`âœ… å­¸ç”Ÿè¨˜éŒ„é©—è­‰é€šé`, 'success');
                log(`   - å­¸ç”Ÿå§“å: ${studentData.name}`, 'info');
                log(`   - å­¸è™Ÿ: ${studentData.studentNumber}`, 'info');
                log(`   - æ•™å¸«ID: ${studentData.teacherId}`, 'info');

                setTestResult('å­¸ç”Ÿè¨˜éŒ„æª¢æŸ¥', true, `æ•™å¸«ID: ${studentData.teacherId.substring(0, 8)}...`);
                return studentData.teacherId;
            } catch (error) {
                log(`âŒ å­¸ç”Ÿè¨˜éŒ„æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
                setTestResult('å­¸ç”Ÿè¨˜éŒ„æª¢æŸ¥', false, error.message);
                return null;
            }
        }

        // æ¸¬è©¦ 4: ç²å–æ•™å¸«è³‡æ–™
        async function testGetTeacherData() {
            log('ğŸ‘¨â€ğŸ« æ¸¬è©¦ç²å–æ•™å¸«è³‡æ–™...', 'info');
            try {
                if (!currentUser) {
                    throw new Error('æ²’æœ‰ç™»å…¥ç”¨æˆ¶');
                }

                const result = await window.firebaseService.getTeacherDataForStudent(currentUser.uid);
                
                if (!result.success) {
                    throw new Error(`ç²å–æ•™å¸«è³‡æ–™å¤±æ•—: ${result.error}`);
                }

                log(`âœ… æˆåŠŸç²å–æ•™å¸«è³‡æ–™`, 'success');
                log(`   - æ•™å¸«å§“å: ${result.teacherInfo?.name || 'N/A'}`, 'info');
                log(`   - æ•™å¸«ä¿¡ç®±: ${result.teacherInfo?.email || 'N/A'}`, 'info');
                
                const hasCleaningTasks = result.teacherData?.cleaningTasks?.length > 0;
                const hasAssignments = result.teacherData?.assignments ? Object.keys(result.teacherData.assignments).length > 0 : false;
                
                log(`   - æ‰“æƒä»»å‹™æ•¸é‡: ${result.teacherData?.cleaningTasks?.length || 0}`, 'info');
                log(`   - åˆ†é…è³‡æ–™: ${hasAssignments ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'info');

                setTestResult('ç²å–æ•™å¸«è³‡æ–™', true, `ä»»å‹™: ${result.teacherData?.cleaningTasks?.length || 0}å€‹`);
                return result;
            } catch (error) {
                log(`âŒ ç²å–æ•™å¸«è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
                setTestResult('ç²å–æ•™å¸«è³‡æ–™', false, error.message);
                return null;
            }
        }

        // æ¸¬è©¦ 5: SessionStorage è¨­å®š
        async function testSessionStorageSetup() {
            log('ğŸ’¾ æ¸¬è©¦ SessionStorage è¨­å®š...', 'info');
            try {
                if (!currentUser) {
                    throw new Error('æ²’æœ‰ç™»å…¥ç”¨æˆ¶');
                }

                // æ¨¡æ“¬æ­£ç¢ºçš„ SessionStorage è¨­å®š
                const teacherResult = await window.firebaseService.getTeacherDataForStudent(currentUser.uid);
                
                if (!teacherResult.success) {
                    throw new Error('ç„¡æ³•ç²å–æ•™å¸«è³‡æ–™ä¾†è¨­å®š SessionStorage');
                }

                sessionStorage.setItem('currentUser', currentUser.uid);
                sessionStorage.setItem('userEmail', currentUser.email);
                sessionStorage.setItem('userRole', 'student');
                sessionStorage.setItem('teacherId', teacherResult.teacherId);
                sessionStorage.setItem('teacherName', teacherResult.teacherInfo?.name || 'æ•™å¸«');
                sessionStorage.setItem('isStudentMode', 'true');
                sessionStorage.setItem('studentId', currentUser.uid);

                log(`âœ… SessionStorage è¨­å®šå®Œæˆ`, 'success');

                // é©—è­‰è¨­å®š
                const requiredKeys = ['currentUser', 'userRole', 'teacherId', 'isStudentMode'];
                let allSet = true;
                for (const key of requiredKeys) {
                    const value = sessionStorage.getItem(key);
                    if (!value) {
                        allSet = false;
                        log(`   âš ï¸ ç¼ºå°‘ ${key}`, 'warn');
                    } else {
                        log(`   âœ“ ${key}: ${value}`, 'info');
                    }
                }

                if (!allSet) {
                    throw new Error('éƒ¨åˆ† SessionStorage é …ç›®æœªè¨­å®š');
                }

                setTestResult('SessionStorage è¨­å®š', true, 'æ‰€æœ‰å¿…è¦é …ç›®å·²è¨­å®š');
                return true;
            } catch (error) {
                log(`âŒ SessionStorage è¨­å®šå¤±æ•—: ${error.message}`, 'error');
                setTestResult('SessionStorage è¨­å®š', false, error.message);
                return false;
            }
        }

        // æ¸¬è©¦ 6: é é¢å°èˆªæ¸¬è©¦
        async function testPageNavigation() {
            log('ğŸ§­ æ¸¬è©¦é é¢å°èˆª...', 'info');
            try {
                // æª¢æŸ¥æ™ºèƒ½è·¯ç”±é‚è¼¯
                const teacherId = sessionStorage.getItem('teacherId');
                if (!teacherId) {
                    throw new Error('æ‰¾ä¸åˆ°æ•™å¸«ID');
                }

                // æª¢æŸ¥æ•™å¸«æ˜¯å¦æœ‰å®Œæ•´è³‡æ–™
                const teacherUserDataResult = await window.firebaseService.db.collection('userData').doc(teacherId).get();
                
                const hasCompleteData = teacherUserDataResult.exists && 
                                      teacherUserDataResult.data()?.cleaningTasks?.length > 0 && 
                                      teacherUserDataResult.data()?.assignments;

                const expectedPage = hasCompleteData ? 'tracking.html' : 'import.html';
                
                log(`âœ… è·¯ç”±é‚è¼¯æ¸¬è©¦é€šé`, 'success');
                log(`   - æ•™å¸«æœ‰å®Œæ•´è³‡æ–™: ${hasCompleteData ? 'æ˜¯' : 'å¦'}`, 'info');
                log(`   - æ‡‰è©²è·³è½‰åˆ°: ${expectedPage}`, 'info');

                setTestResult('é é¢å°èˆªæ¸¬è©¦', true, `æ‡‰è·³è½‰åˆ°: ${expectedPage}`);
                return true;
            } catch (error) {
                log(`âŒ é é¢å°èˆªæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                setTestResult('é é¢å°èˆªæ¸¬è©¦', false, error.message);
                return false;
            }
        }

        // åŸ·è¡Œå®Œæ•´æ¸¬è©¦
        async function runAllTests() {
            log('ğŸš€ é–‹å§‹åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹...', 'info');
            resetTest();

            const tests = [
                { name: 'Firebase é€£æ¥', func: testFirebaseConnection },
                { name: 'å­¸ç”Ÿç™»å…¥', func: testStudentLogin },
                { name: 'å­¸ç”Ÿè¨˜éŒ„æª¢æŸ¥', func: testStudentRecord },
                { name: 'ç²å–æ•™å¸«è³‡æ–™', func: testGetTeacherData },
                { name: 'SessionStorage è¨­å®š', func: testSessionStorageSetup },
                { name: 'é é¢å°èˆªæ¸¬è©¦', func: testPageNavigation }
            ];

            let allPassed = true;
            for (const test of tests) {
                log(`\n--- åŸ·è¡Œ ${test.name} ---`, 'info');
                const result = await test.func();
                if (!result) {
                    allPassed = false;
                    log(`âš ï¸ ${test.name} å¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡Œå¾ŒçºŒæ¸¬è©¦...`, 'warn');
                }
                await wait(1000); // æ¸¬è©¦é–“éš”
            }

            log('\n=== æ¸¬è©¦å®Œæˆ ===', 'info');
            if (allPassed) {
                log('ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼å¸«ç”Ÿç³»çµ±åŠŸèƒ½æ­£å¸¸', 'success');
            } else {
                log('âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥å•é¡Œ', 'warn');
            }
        }

        // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
        window.firebaseService.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                log(`ğŸ” ç”¨æˆ¶ç‹€æ…‹è®Šæ›´: ${user.email} å·²ç™»å…¥`, 'info');
            } else {
                log(`ğŸ” ç”¨æˆ¶ç‹€æ…‹è®Šæ›´: å·²ç™»å‡º`, 'info');
            }
        });

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸ“„ æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ', 'info');
            updateResults();
        });
    </script>
</body>
</html>