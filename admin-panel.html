<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±ç®¡ç†é¢æ¿ - æ‰“æƒè¿½è¹¤ç³»çµ±</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <h1>ğŸ”‘ ç³»çµ±ç®¡ç†é¢æ¿</h1>
            <div class="nav-user">
                <span id="userInfo"></span>
                <button onclick="goToImport()" class="secondary-btn">ğŸ“‹ è³‡æ–™åŒ¯å…¥</button>
                <button onclick="goToTracking()" class="secondary-btn">ğŸ“Š è¿½è¹¤é é¢</button>
                <button onclick="logout()" class="logout-btn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="admin-section">
            <h2>ğŸ‘¥ æ‰€æœ‰ä½¿ç”¨è€…å¸³è™Ÿ</h2>
            <div class="account-stats">
                <div class="stat-card">
                    <h3 id="adminCount">0</h3>
                    <p>ç®¡ç†å“¡</p>
                </div>
                <div class="stat-card">
                    <h3 id="userCount">0</h3>
                    <p>ä¸€èˆ¬ä½¿ç”¨è€…</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalCount">0</h3>
                    <p>ç¸½è¨ˆå¸³è™Ÿ</p>
                </div>
            </div>
            
            <div class="accounts-table">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ä½¿ç”¨è€…ID</th>
                            <th>é›»å­ä¿¡ç®±</th>
                            <th>é¡¯ç¤ºåç¨±</th>
                            <th>è§’è‰²</th>
                            <th>æ•™å¸«ID/åç¨±</th>
                            <th>è¨»å†Šæ™‚é–“</th>
                            <th>è³‡æ–™ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="accountsTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px;">
                                <div class="loading">â³ è¼‰å…¥ä¸­...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section">
            <h2>ğŸ“Š ç³»çµ±çµ±è¨ˆ</h2>
            <div id="systemStats" class="system-stats">
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple.js"></script>
    
    <script>
        let currentUser = null;
        let allUsers = [];

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹å’Œæ¬Šé™
        window.firebaseService.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await checkAdminPermission();
                await loadUserInfo();
                await loadAllAccounts();
            } else {
                window.location.href = 'login.html';
            }
        });

        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        async function checkAdminPermission() {
            if (!currentUser) return;
            
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                if (!userData || userData.role !== 'admin') {
                    alert('âŒ å­˜å–è¢«æ‹’ï¼šåªæœ‰ç®¡ç†å“¡å¯ä»¥é€²å…¥æ­¤é é¢');
                    window.location.href = 'tracking.html';
                    return;
                }
            } catch (error) {
                console.error('æª¢æŸ¥æ¬Šé™éŒ¯èª¤:', error);
                alert('âŒ ç„¡æ³•é©—è­‰æ¬Šé™ï¼Œè«‹é‡æ–°ç™»å…¥');
                window.location.href = 'login.html';
            }
        }

        // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
        async function loadUserInfo() {
            if (!currentUser) return;
            
            try {
                const userDoc = await window.firebaseService.db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                document.getElementById('userInfo').textContent = 
                    `${userData?.name || currentUser.email} (ç®¡ç†å“¡)`;
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨ŠéŒ¯èª¤:', error);
            }
        }

        // è¼‰å…¥æ‰€æœ‰å¸³è™Ÿ
        async function loadAllAccounts() {
            try {
                const result = await window.firebaseService.getAllUsers();
                
                if (result.success) {
                    allUsers = result.users;
                    await displayAccounts();
                    updateStats();
                } else {
                    console.error('è¼‰å…¥å¸³è™Ÿå¤±æ•—:', result.error);
                    document.getElementById('accountsTableBody').innerHTML = `
                        <tr><td colspan="8" style="text-align: center; color: red;">
                            âŒ è¼‰å…¥å¤±æ•—: ${result.error}
                        </td></tr>
                    `;
                }
            } catch (error) {
                console.error('è¼‰å…¥æ‰€æœ‰å¸³è™ŸéŒ¯èª¤:', error);
                document.getElementById('accountsTableBody').innerHTML = `
                    <tr><td colspan="8" style="text-align: center; color: red;">
                        âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢
                    </td></tr>
                `;
            }
        }

        // é¡¯ç¤ºå¸³è™Ÿåˆ—è¡¨
        async function displayAccounts() {
            const tbody = document.getElementById('accountsTableBody');
            
            if (allUsers.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="8" style="text-align: center;">
                        ğŸ“ å°šæœªæœ‰å…¶ä»–ä½¿ç”¨è€…è¨»å†Š
                    </td></tr>
                `;
                return;
            }
            
            let html = '';
            
            // ç‚ºæ¯å€‹ä½¿ç”¨è€…åŠ è¼‰æ•™å¸«è³‡è¨Š
            for (const user of allUsers) {
                const createdAt = user.createdAt ? 
                    new Date(user.createdAt.seconds * 1000).toLocaleDateString('zh-TW') : 
                    'æœªçŸ¥';
                
                let roleClass, roleName;
                if (user.role === 'admin') {
                    roleClass = 'role-admin';
                    roleName = 'ç®¡ç†å“¡';
                } else if (user.role === 'teacher') {
                    roleClass = 'role-teacher';
                    roleName = 'æ•™å¸«';
                } else if (user.role === 'student') {
                    roleClass = 'role-student';
                    roleName = 'å­¸ç”Ÿ';
                } else {
                    roleClass = 'role-user';
                    roleName = 'ä½¿ç”¨è€…';
                }
                
                let teacherInfo = '-';
                
                // å¦‚æœæ˜¯å­¸ç”Ÿï¼ŒåŠ è¼‰æ•™å¸«è³‡è¨Š
                if (user.role === 'student') {
                    try {
                        const teacherData = await window.firebaseService.getTeacherDataForStudent(user.id);
                        if (teacherData.success) {
                            const teacherName = teacherData.teacherInfo?.name || 'æœªçŸ¥æ•™å¸«';
                            const teacherIdShort = teacherData.teacherId.substring(0, 8);
                            teacherInfo = `<div style="font-size: 0.9em;">
                                <div><strong>${teacherName}</strong></div>
                                <div style="color: #666;"><code>${teacherIdShort}...</code></div>
                            </div>`;
                        } else {
                            teacherInfo = '<span style="color: red;">âŒ ç„¡é—œè¯æ•™å¸«</span>';
                        }
                    } catch (error) {
                        teacherInfo = '<span style="color: red;">âŒ æŸ¥è©¢éŒ¯èª¤</span>';
                    }
                }
                
                html += `
                    <tr>
                        <td><code>${user.id.substring(0, 8)}...</code></td>
                        <td>${user.email}</td>
                        <td>${user.name || 'æœªè¨­å®š'}</td>
                        <td><span class="${roleClass}">${roleName}</span></td>
                        <td>${teacherInfo}</td>
                        <td>${createdAt}</td>
                        <td><button class="check-btn" onclick="checkUserData('${user.id}')">æª¢æŸ¥è³‡æ–™</button></td>
                        <td><button class="view-btn" onclick="viewUserData('${user.id}')">æŸ¥çœ‹è©³æƒ…</button></td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html;
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            const adminCount = allUsers.filter(user => user.role === 'admin').length;
            const userCount = allUsers.filter(user => user.role !== 'admin').length;
            const totalCount = allUsers.length;
            
            document.getElementById('adminCount').textContent = adminCount;
            document.getElementById('userCount').textContent = userCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        // æª¢æŸ¥ä½¿ç”¨è€…è³‡æ–™
        async function checkUserData(userId) {
            try {
                const [userData, trackingData] = await Promise.all([
                    window.firebaseService.getUserData(userId),
                    window.firebaseService.getTrackingData(userId)
                ]);
                
                const hasCleaningTasks = userData.success && userData.data?.cleaningTasks?.length > 0;
                const hasStudents = userData.success && userData.data?.students?.length > 0;
                const hasAssignments = userData.success && userData.data?.assignments;
                const hasTrackingData = trackingData.success && Object.keys(trackingData.data || {}).length > 0;
                
                let status = 'ğŸ“ å°šæœªåŒ¯å…¥è³‡æ–™';
                if (hasCleaningTasks && hasStudents && hasAssignments) {
                    status = hasTrackingData ? 
                        'âœ… å®Œæ•´è³‡æ–™ + è¿½è¹¤è¨˜éŒ„' : 
                        'âš ï¸ å·²åŒ¯å…¥è³‡æ–™ï¼Œå°šæœªé–‹å§‹è¿½è¹¤';
                } else if (hasCleaningTasks || hasStudents) {
                    status = 'ğŸ”„ éƒ¨åˆ†è³‡æ–™å·²åŒ¯å…¥';
                }
                
                alert(`ä½¿ç”¨è€…è³‡æ–™ç‹€æ…‹ï¼š\n\n${status}\n\nè©³ç´°ï¼š\n- æ‰“æƒäº‹é …: ${hasCleaningTasks ? 'âœ…' : 'âŒ'}\n- å­¸ç”Ÿåå–®: ${hasStudents ? 'âœ…' : 'âŒ'}\n- ä»»å‹™åˆ†é…: ${hasAssignments ? 'âœ…' : 'âŒ'}\n- è¿½è¹¤è¨˜éŒ„: ${hasTrackingData ? 'âœ…' : 'âŒ'}`);
            } catch (error) {
                alert('æª¢æŸ¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            }
        }

        // æŸ¥çœ‹ä½¿ç”¨è€…è©³æƒ…
        function viewUserData(userId) {
            // åœ¨trackingé é¢ä¸­æŸ¥çœ‹ç‰¹å®šä½¿ç”¨è€…çš„è³‡æ–™
            const trackingUrl = `tracking.html?viewUser=${userId}`;
            window.open(trackingUrl, '_blank');
        }

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            try {
                await window.firebaseService.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // å°èˆªå‡½æ•¸
        function goToImport() {
            window.location.href = 'import.html';
        }

        function goToTracking() {
            window.location.href = 'tracking.html';
        }
    </script>
</body>
</html>