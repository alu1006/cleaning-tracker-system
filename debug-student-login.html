<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç™»å…¥è¨ºæ–·å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .debug-title { font-weight: bold; color: #333; margin-bottom: 10px; }
        .debug-info { background: #f9f9f9; padding: 10px; font-family: monospace; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input { padding: 8px; width: 300px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 15px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
    </style>
</head>
<body>
    <h1>ğŸ” å­¸ç”Ÿç™»å…¥è¨ºæ–·å·¥å…·</h1>
    
    <div class="debug-section">
        <div class="debug-title">1. å­¸ç”Ÿç™»å…¥æ¸¬è©¦</div>
        <div class="input-group">
            <label>å­¸ç”Ÿå¸³è™Ÿï¼ˆEmailï¼‰ï¼š</label>
            <input type="email" id="studentEmail" placeholder="student@example.com">
        </div>
        <div class="input-group">
            <label>å¯†ç¢¼ï¼š</label>
            <input type="password" id="studentPassword" placeholder="password">
        </div>
        <button onclick="testStudentLogin()">æ¸¬è©¦å­¸ç”Ÿç™»å…¥</button>
        <div id="loginResult" class="debug-info"></div>
    </div>

    <div class="debug-section">
        <div class="debug-title">2. å­¸ç”Ÿè¨˜éŒ„æª¢æŸ¥</div>
        <div class="input-group">
            <label>å­¸ç”Ÿ UIDï¼š</label>
            <input type="text" id="studentUid" placeholder="å­¸ç”Ÿçš„ Firebase UID">
        </div>
        <button onclick="checkStudentRecord()">æª¢æŸ¥å­¸ç”Ÿè¨˜éŒ„</button>
        <div id="studentRecordResult" class="debug-info"></div>
    </div>

    <div class="debug-section">
        <div class="debug-title">3. æ•™å¸«è³‡æ–™æª¢æŸ¥</div>
        <div class="input-group">
            <label>æ•™å¸« UIDï¼š</label>
            <input type="text" id="teacherUid" placeholder="æ•™å¸«çš„ Firebase UID">
        </div>
        <button onclick="checkTeacherData()">æª¢æŸ¥æ•™å¸«è³‡æ–™</button>
        <div id="teacherDataResult" class="debug-info"></div>
    </div>

    <div class="debug-section">
        <div class="debug-title">4. å­¸ç”Ÿ-æ•™å¸«é—œè¯æ¸¬è©¦</div>
        <button onclick="testStudentTeacherAssociation()">æ¸¬è©¦å­¸ç”Ÿ-æ•™å¸«é—œè¯</button>
        <div id="associationResult" class="debug-info"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-simple.js"></script>

    <script>
        let currentUser = null;

        // åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            try {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç™»å…¥
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        log('loginResult', `å·²ç™»å…¥ä½¿ç”¨è€…: ${user.email} (${user.uid})`, 'success');
                    } else {
                        currentUser = null;
                        log('loginResult', 'å°šæœªç™»å…¥', 'warning');
                    }
                });
            } catch (error) {
                log('loginResult', `åˆå§‹åŒ–éŒ¯èª¤: ${error.message}`, 'error');
            }
        });

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : (type === 'warning' ? 'warning' : ''));
            element.innerHTML = `<div class="${className}">[${timestamp}] ${message}</div>` + element.innerHTML;
        }

        async function testStudentLogin() {
            const email = document.getElementById('studentEmail').value;
            const password = document.getElementById('studentPassword').value;

            if (!email || !password) {
                log('loginResult', 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼', 'error');
                return;
            }

            log('loginResult', `é–‹å§‹æ¸¬è©¦å­¸ç”Ÿç™»å…¥: ${email}`);

            try {
                // ç™»å…¥
                const result = await window.firebaseService.signIn(email, password);
                if (!result.success) {
                    log('loginResult', `ç™»å…¥å¤±æ•—: ${result.error}`, 'error');
                    return;
                }

                currentUser = result.user;
                log('loginResult', `ç™»å…¥æˆåŠŸ: ${result.user.email} (${result.user.uid})`, 'success');

                // æª¢æŸ¥ä½¿ç”¨è€…è§’è‰²
                const userData = await window.firebaseService.getUserData(result.user.uid);
                if (userData.success) {
                    const role = userData.data?.role || 'user';
                    log('loginResult', `ä½¿ç”¨è€…è§’è‰²: ${role}`);
                    
                    if (role === 'student') {
                        log('loginResult', 'ç¢ºèªç‚ºå­¸ç”Ÿè§’è‰²ï¼Œæª¢æŸ¥æ•™å¸«é—œè¯...', 'success');
                        await checkStudentTeacherConnection(result.user.uid);
                    } else {
                        log('loginResult', `éå­¸ç”Ÿè§’è‰² (${role})`, 'warning');
                    }
                } else {
                    log('loginResult', `ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™: ${userData.error}`, 'error');
                }

            } catch (error) {
                log('loginResult', `ç™»å…¥æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function checkStudentTeacherConnection(studentId) {
            try {
                log('loginResult', `æª¢æŸ¥å­¸ç”Ÿ ${studentId} çš„æ•™å¸«é—œè¯...`);
                
                const teacherDataResult = await window.firebaseService.getTeacherDataForStudent(studentId);
                
                if (teacherDataResult.success) {
                    log('loginResult', `âœ… æ‰¾åˆ°é—œè¯æ•™å¸«: ${teacherDataResult.teacherId}`, 'success');
                    log('loginResult', `æ•™å¸«å§“å: ${teacherDataResult.teacherInfo?.name || 'æœªçŸ¥'}`);
                    log('loginResult', `å­¸ç”Ÿå§“å: ${teacherDataResult.studentInfo?.name || 'æœªçŸ¥'}`);
                    log('loginResult', `å­¸ç”Ÿå­¸è™Ÿ: ${teacherDataResult.studentInfo?.studentNumber || 'æœªçŸ¥'}`);
                    
                    // æª¢æŸ¥æ•™å¸«æ˜¯å¦æœ‰åŒ¯å…¥è³‡æ–™
                    if (teacherDataResult.userData && teacherDataResult.userData.cleaningTasks) {
                        log('loginResult', `âœ… æ•™å¸«æœ‰åŒ¯å…¥è³‡æ–™ (${teacherDataResult.userData.cleaningTasks.length} é …æ‰“æƒä»»å‹™)`, 'success');
                        log('loginResult', `åˆ†é…ä»»å‹™æ•¸: ${Object.keys(teacherDataResult.userData.assignments || {}).length}`);
                    } else {
                        log('loginResult', `âŒ æ•™å¸«å°šæœªåŒ¯å…¥æ¸…æƒè³‡æ–™`, 'warning');
                    }
                } else {
                    log('loginResult', `âŒ ç„¡æ³•æ‰¾åˆ°é—œè¯æ•™å¸«: ${teacherDataResult.error}`, 'error');
                }
            } catch (error) {
                log('loginResult', `æª¢æŸ¥æ•™å¸«é—œè¯éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function checkStudentRecord() {
            const studentUid = document.getElementById('studentUid').value;
            if (!studentUid) {
                log('studentRecordResult', 'è«‹è¼¸å…¥å­¸ç”Ÿ UID', 'error');
                return;
            }

            try {
                log('studentRecordResult', `æª¢æŸ¥å­¸ç”Ÿè¨˜éŒ„: ${studentUid}`);
                
                const studentDoc = await window.firebaseService.db.collection('students').doc(studentUid).get();
                
                if (studentDoc.exists) {
                    const studentData = studentDoc.data();
                    log('studentRecordResult', `âœ… æ‰¾åˆ°å­¸ç”Ÿè¨˜éŒ„:`, 'success');
                    log('studentRecordResult', JSON.stringify(studentData, null, 2));
                    
                    if (studentData.teacherId) {
                        log('studentRecordResult', `é—œè¯æ•™å¸« ID: ${studentData.teacherId}`, 'success');
                    } else {
                        log('studentRecordResult', `âŒ ç¼ºå°‘æ•™å¸« ID`, 'error');
                    }
                } else {
                    log('studentRecordResult', `âŒ æ‰¾ä¸åˆ°å­¸ç”Ÿè¨˜éŒ„`, 'error');
                }
            } catch (error) {
                log('studentRecordResult', `æª¢æŸ¥å­¸ç”Ÿè¨˜éŒ„éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function checkTeacherData() {
            const teacherUid = document.getElementById('teacherUid').value;
            if (!teacherUid) {
                log('teacherDataResult', 'è«‹è¼¸å…¥æ•™å¸« UID', 'error');
                return;
            }

            try {
                log('teacherDataResult', `æª¢æŸ¥æ•™å¸«è³‡æ–™: ${teacherUid}`);
                
                const userData = await window.firebaseService.getUserData(teacherUid);
                
                if (userData.success) {
                    log('teacherDataResult', `âœ… æ‰¾åˆ°æ•™å¸«è³‡æ–™:`, 'success');
                    
                    if (userData.data.cleaningTasks) {
                        log('teacherDataResult', `æ¸…æƒä»»å‹™æ•¸: ${userData.data.cleaningTasks.length}`);
                        log('teacherDataResult', `åˆ†é…ä»»å‹™æ•¸: ${Object.keys(userData.data.assignments || {}).length}`);
                        log('teacherDataResult', `å­¸ç”Ÿåå–®æ•¸: ${userData.data.students?.length || 0}`);
                    } else {
                        log('teacherDataResult', `âŒ æ•™å¸«å°šæœªåŒ¯å…¥æ¸…æƒè³‡æ–™`, 'warning');
                    }
                } else {
                    log('teacherDataResult', `âŒ ç„¡æ³•å–å¾—æ•™å¸«è³‡æ–™: ${userData.error}`, 'error');
                }
            } catch (error) {
                log('teacherDataResult', `æª¢æŸ¥æ•™å¸«è³‡æ–™éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testStudentTeacherAssociation() {
            if (!currentUser) {
                log('associationResult', 'è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            try {
                log('associationResult', `æ¸¬è©¦ç•¶å‰ä½¿ç”¨è€…çš„å­¸ç”Ÿ-æ•™å¸«é—œè¯: ${currentUser.uid}`);
                
                // æ¸¬è©¦ getTeacherDataForStudent æ–¹æ³•
                const result = await window.firebaseService.getTeacherDataForStudent(currentUser.uid);
                
                if (result.success) {
                    log('associationResult', `âœ… é—œè¯æ¸¬è©¦æˆåŠŸ`, 'success');
                    log('associationResult', `æ•™å¸« ID: ${result.teacherId}`);
                    log('associationResult', `æ•™å¸«å§“å: ${result.teacherInfo?.name || 'æœªçŸ¥'}`);
                    log('associationResult', `å­¸ç”Ÿå§“å: ${result.studentInfo?.name || 'æœªçŸ¥'}`);
                    log('associationResult', `å­¸ç”Ÿå­¸è™Ÿ: ${result.studentInfo?.studentNumber || 'æœªçŸ¥'}`);
                    
                    // è©³ç´°è³‡æ–™æª¢æŸ¥
                    if (result.userData) {
                        log('associationResult', `æ•™å¸«è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥:`);
                        log('associationResult', `- æ¸…æƒä»»å‹™: ${result.userData.cleaningTasks?.length || 0} é …`);
                        log('associationResult', `- åˆ†é…ä»»å‹™: ${Object.keys(result.userData.assignments || {}).length} é …`);
                        log('associationResult', `- å­¸ç”Ÿåå–®: ${result.userData.students?.length || 0} äºº`);
                    } else {
                        log('associationResult', `âŒ æ•™å¸«ç„¡ä½¿ç”¨è€…è³‡æ–™`, 'error');
                    }
                } else {
                    log('associationResult', `âŒ é—œè¯æ¸¬è©¦å¤±æ•—: ${result.error}`, 'error');
                }
            } catch (error) {
                log('associationResult', `é—œè¯æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>