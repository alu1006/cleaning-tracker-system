<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦å­¸ç”ŸæŸ¥çœ‹æ•™å¸«è³‡æ–™</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .info { background: #f0f8ff; }
        .success { background: #f0fff0; }
        .error { background: #fff0f0; }
        button { padding: 8px 15px; margin: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>ğŸ§ª å­¸ç”ŸæŸ¥çœ‹æ•™å¸«è³‡æ–™æ¸¬è©¦</h1>
    
    <div class="section info">
        <h3>ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿ</h3>
        <ol>
            <li>ä½¿ç”¨å­¸ç”Ÿå¸³è™Ÿç™»å…¥ (ä¾‹å¦‚: 123@gmail.com)</li>
            <li>æª¢æŸ¥ sessionStorage æ˜¯å¦æ­£ç¢ºè¨­ç½®</li>
            <li>æ¸¬è©¦ getTeacherDataForStudent æ–¹æ³•</li>
            <li>é©—è­‰å­¸ç”Ÿèƒ½å¦çœ‹åˆ°æ•™å¸«çš„æ‰“æƒè¡¨è³‡æ–™</li>
        </ol>
    </div>

    <div class="section">
        <h3>ğŸ” ç™»å…¥æ¸¬è©¦</h3>
        <input type="email" id="email" placeholder="å­¸ç”Ÿä¿¡ç®±" value="123@gmail.com">
        <input type="password" id="password" placeholder="å¯†ç¢¼" value="123456">
        <button onclick="testLogin()">ç™»å…¥æ¸¬è©¦</button>
        <button onclick="logout()">ç™»å‡º</button>
    </div>

    <div class="section">
        <h3>ğŸ“Š ç•¶å‰ç‹€æ…‹</h3>
        <div id="currentStatus"></div>
    </div>

    <div class="section">
        <h3>ğŸ” SessionStorage æª¢æŸ¥</h3>
        <button onclick="checkSessionStorage()">æª¢æŸ¥ SessionStorage</button>
        <div id="sessionData"></div>
    </div>

    <div class="section">
        <h3>ğŸ‘¨â€ğŸ« æ•™å¸«è³‡æ–™æŸ¥è©¢</h3>
        <button onclick="getTeacherData()">ç²å–æ•™å¸«è³‡æ–™</button>
        <div id="teacherData"></div>
    </div>

    <div class="section">
        <h3>ğŸ“‹ Firestore ç›´æ¥æŸ¥è©¢</h3>
        <button onclick="checkFirestoreDirectly()">ç›´æ¥æŸ¥è©¢ Firestore</button>
        <div id="firestoreData"></div>
    </div>

    <!-- Firebase é…ç½® -->
    <script src="firebase-simple-public.js"></script>
    
    <script>
        let currentUser = null;

        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatus() {
            const statusDiv = document.getElementById('currentStatus');
            statusDiv.innerHTML = `
                <p><strong>ç•¶å‰ä½¿ç”¨è€…:</strong> ${currentUser ? currentUser.email : 'æœªç™»å…¥'}</p>
                <p><strong>UID:</strong> ${currentUser ? currentUser.uid : 'N/A'}</p>
                <p><strong>æ™‚é–“:</strong> ${new Date().toLocaleString()}</p>
            `;
        }

        // ç›£è½èªè­‰ç‹€æ…‹
        window.firebaseService.onAuthStateChanged((user) => {
            currentUser = user;
            updateStatus();
        });

        // ç™»å…¥æ¸¬è©¦
        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                console.log('ğŸ” å˜—è©¦ç™»å…¥:', email);
                const result = await window.firebaseService.signIn(email, password);
                
                if (result.success) {
                    console.log('âœ… ç™»å…¥æˆåŠŸ');
                    alert('ç™»å…¥æˆåŠŸï¼');
                    
                    // æª¢æŸ¥ä½¿ç”¨è€…è§’è‰²
                    const userDoc = await window.firebaseService.db.collection('users').doc(result.user.uid).get();
                    const userData = userDoc.data();
                    
                    console.log('ä½¿ç”¨è€…è³‡æ–™:', userData);
                    
                    if (userData?.role === 'student') {
                        console.log('ğŸ“ æª¢æ¸¬åˆ°å­¸ç”Ÿè§’è‰²ï¼Œè¨­ç½® sessionStorage');
                        
                        // æ¨¡æ“¬è¨­ç½®å­¸ç”Ÿæ¨¡å¼
                        sessionStorage.setItem('currentUser', result.user.uid);
                        sessionStorage.setItem('userEmail', result.user.email);
                        sessionStorage.setItem('userRole', 'student');
                        sessionStorage.setItem('userName', userData.name || result.user.email);
                        
                        // ç²å–æ•™å¸«è³‡æ–™
                        const teacherResult = await window.firebaseService.getTeacherDataForStudent(result.user.uid);
                        if (teacherResult.success) {
                            sessionStorage.setItem('teacherId', teacherResult.teacherId);
                            sessionStorage.setItem('teacherName', teacherResult.teacherInfo?.name || 'æ•™å¸«');
                            sessionStorage.setItem('isStudentMode', 'true');
                            console.log('âœ… å­¸ç”Ÿæ¨¡å¼ sessionStorage è¨­ç½®å®Œæˆ');
                        }
                    }
                } else {
                    console.error('âŒ ç™»å…¥å¤±æ•—:', result.error);
                    alert('ç™»å…¥å¤±æ•—: ' + result.error);
                }
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                alert('ç™»å…¥éŒ¯èª¤: ' + error.message);
            }
        }

        // ç™»å‡º
        async function logout() {
            await window.firebaseService.signOut();
            sessionStorage.clear();
            alert('å·²ç™»å‡º');
        }

        // æª¢æŸ¥ SessionStorage
        function checkSessionStorage() {
            const sessionDiv = document.getElementById('sessionData');
            const sessionKeys = ['currentUser', 'userEmail', 'userRole', 'userName', 'teacherId', 'teacherName', 'isStudentMode'];
            
            let html = '<h4>SessionStorage å…§å®¹:</h4>';
            sessionKeys.forEach(key => {
                const value = sessionStorage.getItem(key);
                html += `<p><strong>${key}:</strong> ${value || '(æœªè¨­ç½®)'}</p>`;
            });
            
            sessionDiv.innerHTML = html;
        }

        // ç²å–æ•™å¸«è³‡æ–™
        async function getTeacherData() {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }

            const teacherDiv = document.getElementById('teacherData');
            teacherDiv.innerHTML = '<p>è¼‰å…¥ä¸­...</p>';

            try {
                console.log('ğŸ” ç²å–æ•™å¸«è³‡æ–™ï¼Œå­¸ç”ŸID:', currentUser.uid);
                const result = await window.firebaseService.getTeacherDataForStudent(currentUser.uid);
                
                if (result.success) {
                    teacherDiv.innerHTML = `
                        <div class="success">
                            <h4>âœ… æˆåŠŸç²å–æ•™å¸«è³‡æ–™</h4>
                            <p><strong>æ•™å¸«ID:</strong> ${result.teacherId}</p>
                            <p><strong>æ•™å¸«å§“å:</strong> ${result.teacherInfo?.name || 'N/A'}</p>
                            <p><strong>æ•™å¸«ä¿¡ç®±:</strong> ${result.teacherInfo?.email || 'N/A'}</p>
                            <p><strong>å­¸ç”Ÿè³‡æ–™:</strong></p>
                            <pre>${JSON.stringify(result.studentInfo, null, 2)}</pre>
                            <p><strong>æ•™å¸«æ‰“æƒè³‡æ–™:</strong></p>
                            <pre>${JSON.stringify(result.teacherData, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    teacherDiv.innerHTML = `
                        <div class="error">
                            <h4>âŒ ç²å–æ•™å¸«è³‡æ–™å¤±æ•—</h4>
                            <p><strong>éŒ¯èª¤:</strong> ${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ç²å–æ•™å¸«è³‡æ–™éŒ¯èª¤:', error);
                teacherDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ ç™¼ç”ŸéŒ¯èª¤</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ç›´æ¥æŸ¥è©¢ Firestore
        async function checkFirestoreDirectly() {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }

            const firestoreDiv = document.getElementById('firestoreData');
            firestoreDiv.innerHTML = '<p>æŸ¥è©¢ä¸­...</p>';

            try {
                // 1. æª¢æŸ¥å­¸ç”Ÿè¨˜éŒ„
                const studentDoc = await window.firebaseService.db.collection('students').doc(currentUser.uid).get();
                
                let html = '<h4>Firestore ç›´æ¥æŸ¥è©¢çµæœ:</h4>';
                
                if (studentDoc.exists) {
                    const studentData = studentDoc.data();
                    html += `<div class="success">
                        <h5>âœ… å­¸ç”Ÿè¨˜éŒ„å­˜åœ¨</h5>
                        <pre>${JSON.stringify(studentData, null, 2)}</pre>
                    </div>`;
                    
                    // 2. æª¢æŸ¥æ•™å¸«è³‡æ–™
                    if (studentData.teacherId) {
                        const teacherDoc = await window.firebaseService.db.collection('users').doc(studentData.teacherId).get();
                        const teacherUserData = await window.firebaseService.db.collection('userData').doc(studentData.teacherId).get();
                        
                        html += `<div class="info">
                            <h5>ğŸ“‹ æ•™å¸«åŸºæœ¬è³‡æ–™</h5>
                            <pre>${JSON.stringify(teacherDoc.exists ? teacherDoc.data() : 'ä¸å­˜åœ¨', null, 2)}</pre>
                            
                            <h5>ğŸ“Š æ•™å¸«æ‰“æƒè³‡æ–™</h5>
                            <pre>${JSON.stringify(teacherUserData.exists ? teacherUserData.data() : 'ä¸å­˜åœ¨', null, 2)}</pre>
                        </div>`;
                    }
                } else {
                    html += `<div class="error">
                        <h5>âŒ å­¸ç”Ÿè¨˜éŒ„ä¸å­˜åœ¨</h5>
                        <p>UID: ${currentUser.uid}</p>
                    </div>`;
                }
                
                firestoreDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Firestore æŸ¥è©¢éŒ¯èª¤:', error);
                firestoreDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ Firestore æŸ¥è©¢éŒ¯èª¤</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // é é¢è¼‰å…¥æ™‚æ›´æ–°ç‹€æ…‹
        updateStatus();
    </script>
</body>
</html>